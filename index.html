<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Doble Control de √çtems v2.8.9 (Formato Carta PDF)</title>
  <style>
    /* Estilos CSS Generales */
    body { font-family: Arial, sans-serif; }
    .pdf-container { width: 100%; }
    .pdf-header { text-align: center; margin-bottom: 10px; }
    .pdf-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
    .pdf-date { font-size: 10px; margin-bottom: 10px; }
    .pdf-summary { font-size: 12px; margin-bottom: 15px; }
    .pdf-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; page-break-inside: avoid; }
    .pdf-item-label { font-weight: bold; display: block; margin-bottom: 5px; }
    .pdf-barcode-container { text-align: center; margin-bottom: 10px; }
    .pdf-barcode-svg { max-width: 80%; height: auto; }
    .pdf-item-info { font-size: 12px; margin-bottom: 8px; }
    .pdf-manual-input { margin-top: 15px; font-size: 12px; }
    .pdf-manual-input label { font-weight: bold; display: block; margin-bottom: 5px; }
    .pdf-manual-input textarea { width: 100%; height: 50px; box-sizing: border-box; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sistema de Doble Control de √çtems v2.8.9</h1>

    <div id="panelInicio" class="section hidden">
      <h2>Panel de Inicio</h2>
      <div id="panelInicioInfo" class="panel-inicio-info info">
        Cargando informaci√≥n de Lista Maestra desde el repositorio...
      </div>
      <div class="panel-inicio-actions">
        <button id="btnIniciarDobleControlDesdePanel" disabled>‚û°Ô∏è Iniciar Doble Control</button>
        <button id="btnGestionMaestraDesdePanel" class="secondary" disabled>üîé Ver Lista Maestra y Buscar</button>
        <button id="btnBorrarMaestraStorage" class="danger secondary" style="margin-top: 20px;">üóëÔ∏è Borrar Maestra Local y Resincronizar</button>
      </div>
    </div>

    <div id="confirmacionCambiosStep" class="section hidden">
      <h2>Confirmar Cambios de Lista Maestra (desde Repositorio)</h2>
      <p>Se han detectado los siguientes cambios respecto a tu lista local guardada:</p>
      <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
          <div id="resumenNuevos"><h3>Nuevos √çtems:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenEliminados"><h3>√çtems Eliminados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenModificados"><h3>√çtems Modificados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
      </div>
      <p>¬øDeseas aplicar estos cambios y usar la versi√≥n del repositorio en tu sesi√≥n actual?</p>
      <div style="text-align: center;">
        <button id="btnConfirmarCambiosRepositorio">S√≠, Aplicar Cambios del Repositorio</button>
        <button id="btnRechazarCambiosRepositorio" class="secondary">No, Mantener Mi Versi√≥n Local</button>
      </div>
    </div>

    <div id="gestionMaestraStep" class="section hidden">
      <h2>Ver Lista Maestra y Buscar</h2>
      <div class="input-group">
        <label for="searchFocoInput">Buscar √çtem (por ID, UPC, descripci√≥n, marca o URL de imagen):</label>
        <input type="text" id="searchFocoInput" placeholder="Ingrese t√©rmino de b√∫squeda...">
      </div>
      <div id="focoSearchResults" class="search-results-area" style="margin-bottom: 20px;">Resultados de la b√∫squeda aparecer√°n aqu√≠...</div>

      <div id="focoPreview" class="preview-area">
        <h3>Estad√≠sticas de la Lista Maestra</h3>
        <ul id="masterListStats">
            <li>Total de √çtems: <strong id="statTotalItems">0</strong></li>
            <li>√çtems sin URL de imagen: <strong id="statNoImageUrl">0</strong></li>
            <li>√çtems sin UPC: <strong id="statNoUpc">0</strong></li>
            <li>√çtems sin Descripci√≥n: <strong id="statNoDescription">0</strong></li>
            <li>√çtems sin Marca: <strong id="statNoBrand">0</strong></li>
        </ul>
        <p style="font-size:0.8em; margin-top:15px; text-align:center;">
            Utiliza la barra de b√∫squeda de arriba para encontrar √≠tems espec√≠ficos.
        </p>
      </div>

      <div style="margin-top:20px; text-align:center;">
        <button id="btnVolverAlPanelDesdeGestion" class="secondary">‚Ü©Ô∏è Volver al Panel de Inicio</button>
      </div>
    </div>

    <div id="dobleControlStep" class="section hidden">
      <h2>Paso 2: Cargar Lista de √çtems para Doble Control</h2>
      <p style="font-size:0.9em; color: #555;">
        Puede escanear el UPC del art√≠culo f√≠sico (si su Lista Maestra contiene UPCs) o ingresar el ID del √çtem.
        Solo se considerar√°n IDs de √çtem **num√©ricos de m√°s de 5 d√≠gitos**.
      </p>
      <div class="input-group">
        <label for="verifyTextarea">Pegar IDs de √çtem a verificar (uno por l√≠nea o separados por espacio/tabulador):</label>
        <textarea id="verifyTextarea" rows="5" inputmode="numeric"></textarea>
      </div>
       <div class="input-group">
        <label>Subir archivo con IDs de √çtem a verificar:</label>
        <p style="font-size:0.85em; color:#666;">Se tomar√°n los IDs de √çtem de la columna especificada. Solo se considerar√°n IDs num√©ricos de m√°s de 5 d√≠gitos.</p>
        <div class="input-columns">
            <div><label for="verifyFileTxtCsv" style="font-size:0.9em;">Texto (.txt, .csv):</label><input type="file" id="verifyFileTxtCsv" accept=".txt,.csv"></div>
            <div><label for="verifyFileExcel" style="font-size:0.9em;">Excel (.xlsx, .xls):</label><input type="file" id="verifyFileExcel" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"></div>
        </div>
        <div class="file-options">
            <div class="input-columns">
                <div><label for="verifyCodigoCol">Col. ID √çtem (ej: 1):</label><input type="number" id="verifyCodigoCol" value="1" min="1"></div>
                 <div><label for="verifyCsvDelimiter">Delimitador CSV:</label><input type="text" id="verifyCsvDelimiter" value=","></div>
            </div>
             <label><input type="checkbox" id="verifyHasHeader" checked> El archivo tiene encabezados</label>
        </div>
      </div>
      <div class="input-group">
        <button id="startScanVerifyBtn">üì∑ Escanear UPC de Art√≠culo</button>
        <div id="scannerContainerVerify" class="hidden"><div id="readerVerify"></div></div>
        <label for="scannedCodesVerifyTextarea" style="margin-top:10px;">IDs de √çtem v√°lidos identificados (desde UPC escaneado o ingresado):</label>
        <textarea id="scannedCodesVerifyTextarea" rows="3" placeholder="Los IDs de √çtem v√°lidos aparecer√°n aqu√≠..." readonly></textarea>
      </div>
      <div id="verifyPreview" class="preview-area">A√∫n no se han cargado √çtems a verificar.</div>
      <hr style="margin: 20px 0;">
      <button id="btnVolverAlPanelDesdeDobleControl" class="secondary">&larr; Volver al Panel de Inicio</button>
      <button id="btnCompare">Verificar y Mostrar √çtems Concordantes &rarr;</button>
    </div>

    <div id="resultadosStep" class="section hidden">
      <h2>Resultados: √çtems Concordantes</h2>
      <div id="resultsSummary" class="results-summary">
        <p>Total √çtems en Lista Maestra: <strong id="totalFoco">0</strong></p>
        <p>Total √çtems en Lista de Verificaci√≥n (v√°lidos): <strong id="totalVerify">0</strong></p>
        <p>√çtems Concordantes Verificados: <strong id="totalMatches">0</strong></p>
      </div>
      <h3>Detalle de √çtems Concordantes (Clic para ver m√°s)</h3>
      <div style="margin-bottom: 15px;">
          <button id="layoutToggleResultsBtn">üìä Cambiar Vista</button>
          <button id="downloadXlsxResultsBtn" class="secondary">üìä Descargar XLSX</button>
          <button id="downloadCsvResultsBtn" class="secondary">üíæ Descargar CSV de Concordancias</button>
          <button id="downloadPdfResultsBtn">üìÑ Generar PDF</button>
      </div>
      <div id="outputResults" class="list"><p>No se han encontrado coincidencias o no se ha realizado la verificaci√≥n.</p></div>
      <hr style="margin: 20px 0;">
      <button id="btnNewVerification">‚ú® Iniciar Nuevo Doble Control</button>
    </div>
  </div>

  <div id="itemDetailModal" class="hidden">
    <div class="modal-content">
      <span class="close-modal" onclick="closeItemDetailModal()">&times;</span>
      <h3 id="modalItemCodigo"></h3>
      <div id="modalItemImageContainer">
        <img id="modalItemImage" src="#" alt="Imagen del √çtem" style="display:none;">
        <p id="modalImageError" style="display:none; color:red;">Imagen no disponible.</p>
      </div>
      <p><strong>Descripci√≥n:</strong> <span id="modalItemDescripcion"></span></p>
      <p><strong>UPC:</strong> <span id="modalItemUPC"></span></p>
      <p><strong>Marca:</strong> <span id="modalItemBrand"></span></p>
    </div>
  </div>

  <footer>
    Sistema de Doble Control de √çtems v2.8.9 - Desarrollado por fgalaz - Chile, 2025
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ----- URL DE LA LISTA MAESTRA EN REPOSITORIO -----
    const URL_LISTA_MAESTRA_REPOSITORIO = 'https://raw.githubusercontent.com/Galaz94/Double_Control/main/maestra.csv'; // Reemplaza con tu URL real

    // ----- ESTADO DE LA APLICACI√ìN -----
    let listaFoco = new Map();
    let upcToCodigoMap = new Map();
    let listaVerificar = new Set();
    let coincidencias = new Map();
    const LOCAL_STORAGE_KEY_LISTA_FOCO = 'sDCI_listaFocoGuardada_v2.8.9';
    let listaFocoCacheadaLocalmente = new Map();

    // ----- SELECTORES DOM -----
    const panelInicioDiv = document.getElementById('panelInicio');
    const modalItemImage = document.getElementById('modalItemImage');
    const modalImageError = document.getElementById('modalImageError');
    const statTotalItems = document.getElementById('statTotalItems');
    const statNoImageUrl = document.getElementById('statNoImageUrl');
    const statNoUpc = document.getElementById('statNoUpc');
    const statNoDescription = document.getElementById('statNoDescription');
    const statNoBrand = document.getElementById('statNoBrand');
    const gestionMaestraStepDiv = document.getElementById('gestionMaestraStep');
    const dobleControlStepDiv = document.getElementById('dobleControlStep');
    const resultadosStepDiv = document.getElementById('resultadosStep');
    const confirmacionCambiosStepDiv = document.getElementById('confirmacionCambiosStep');
    const itemDetailModal = document.getElementById('itemDetailModal');
    const modalItemCodigo = document.getElementById('modalItemCodigo');
    const modalItemDescripcion = document.getElementById('modalItemDescripcion');
    const modalItemUPC = document.getElementById('modalItemUPC');
    const modalItemBrand = document.getElementById('modalItemBrand');
    const panelInicioInfo = document.getElementById('panelInicioInfo');
    const btnIniciarDobleControlDesdePanel = document.getElementById('btnIniciarDobleControlDesdePanel');
    const btnGestionMaestraDesdePanel = document.getElementById('btnGestionMaestraDesdePanel');
    const btnBorrarMaestraStorage = document.getElementById('btnBorrarMaestraStorage');
    const searchFocoInput = document.getElementById('searchFocoInput');
    const focoSearchResultsDiv = document.getElementById('focoSearchResults');
    const focoPreview = document.getElementById('focoPreview');
    const btnVolverAlPanelDesdeGestion = document.getElementById('btnVolverAlPanelDesdeGestion');
    const verifyTextarea = document.getElementById('verifyTextarea');
    const verifyFileTxtCsv = document.getElementById('verifyFileTxtCsv'), verifyFileExcel = document.getElementById('verifyFileExcel');
    const verifyCodigoColInput = document.getElementById('verifyCodigoCol'), verifyCsvDelimiterInput = document.getElementById('verifyCsvDelimiter');
    const verifyHasHeaderCheckbox = document.getElementById('verifyHasHeader');
    const verifyPreview = document.getElementById('verifyPreview');
    const startScanVerifyBtn = document.getElementById('startScanVerifyBtn');
    const scannerContainerVerify = document.getElementById('scannerContainerVerify');
    const readerVerifyDiv = document.getElementById('readerVerify'), scannedCodesVerifyTextarea = document.getElementById('scannedCodesVerifyTextarea');
    const btnVolverAlPanelDesdeDobleControl = document.getElementById('btnVolverAlPanelDesdeDobleControl');
    const btnCompare = document.getElementById('btnCompare');
    const totalFocoSpan = document.getElementById('totalFoco'), totalVerifySpan = document.getElementById('totalVerify'), totalMatchesSpan = document.getElementById('totalMatches');
    const outputResultsDiv = document.getElementById('outputResults');
    const layoutToggleResultsBtn = document.getElementById('layoutToggleResultsBtn');
    const downloadXlsxResultsBtn = document.getElementById('downloadXlsxResultsBtn');
    const downloadCsvResultsBtn = document.getElementById('downloadCsvResultsBtn');
    const downloadPdfResultsBtn = document.getElementById('downloadPdfResultsBtn');
    const btnNewVerification = document.getElementById('btnNewVerification');
    const resumenNuevosUl = document.querySelector('#resumenNuevos ul');
    const resumenEliminadosUl = document.querySelector('#resumenEliminados ul');
    const resumenModificadosUl = document.querySelector('#resumenModificados ul');
    const btnConfirmarCambiosRepositorio = document.getElementById('btnConfirmarCambiosRepositorio');
    const btnRechazarCambiosRepositorio = document.getElementById('btnRechazarCambiosRepositorio');
    let html5QrCodeVerifier = null;
    let scannerVerifierActive = false;

    // ----- INICIALIZACI√ìN -----
    document.addEventListener('DOMContentLoaded', () => {
        checkInitialState();
        navigateToView('panelInicio');
        itemDetailModal.addEventListener('click', function(event) {
            if (event.target === itemDetailModal) { closeItemDetailModal(); }
        });
        modalItemImage.onerror = function() {
            this.style.display = 'none';
            modalImageError.style.display = 'block';
            modalImageError.textContent = 'Error al cargar imagen o URL no v√°lida.';
        };
        modalItemImage.onload = function() {
            this.style.display = 'block';
            modalImageError.style.display = 'none';
        };
    });

    // ----- L√≥gica de Carga y Sincronizaci√≥n con Repositorio -----
    function cleanText(text) { return text ? String(text).trim() : ''; }
    function parsearMaestraCSV(csvText) {
        const items = [];
        const lineas = csvText.trim().split(/\r\n|\n/);
        const cabeceraPresente = true; // Asumimos que siempre hay cabecera en el CSV del repo
        const indiceInicio = cabeceraPresente ? 1 : 0;
        for (let i = indiceInicio; i < lineas.length; i++) {
            const linea = lineas[i].trim();
            if (!linea) continue;
            const partes = linea.split(',');
            if (partes.length >= 1 && partes[0]) {
                let itemData = {
                    codigo: cleanText(partes[0]),
                    upc: '',
                    descripcion: '',
                    brand: '',
                    url: ''
                };
                if (partes.length >= 2) itemData.upc = cleanText(partes[1]);
                if (partes.length >= 3) itemData.descripcion = cleanText(partes[2]);
                if (partes.length >= 4) itemData.brand = cleanText(partes[3]);
                if (partes.length >= 5) itemData.url = cleanText(partes[4]);
                items.push(itemData);
            }
        }
        return items;
    }
    function rebuildUpcToCodigoMap() {
        upcToCodigoMap.clear();
        listaFoco.forEach(item => {
            if (item.upc && item.upc.trim() !== '') {
                upcToCodigoMap.set(item.upc.trim(), item.codigo);
            }
        });
    }
    async function cargarMaestraDesdeRepositorio() {
        if (!URL_LISTA_MAESTRA_REPOSITORIO || URL_LISTA_MAESTRA_REPOSITORIO === 'PON_AQUI_LA_URL_RAW_DE_TU_MAESTRA.CSV_EN_REPOSITORIO') {
            console.warn('URL_LISTA_MAESTRA_REPOSITORIO no configurada.');
            return null;
        }
        try {
            const response = await fetch(URL_LISTA_MAESTRA_REPOSITORIO + '?t=' + new Date().getTime()); // Cache busting
            if (!response.ok) {
                console.error('Error al cargar Maestra desde Repositorio:', response.status);
                return null;
            }
            const csvText = await response.text();
            const itemsArray = parsearMaestraCSV(csvText);
            const nuevaListaMap = new Map();
            itemsArray.forEach(item => {
                const idItemLimpio = cleanCode(item.codigo);
                if (idItemLimpio) {
                    nuevaListaMap.set(idItemLimpio, {
                        codigo: idItemLimpio,
                        upc: item.upc,
                        descripcion: item.descripcion,
                        brand: item.brand,
                        url: item.url
                    });
                }
            });
            return nuevaListaMap;
        } catch (error) {
            console.error('Excepci√≥n al cargar Maestra desde Repositorio:', error);
            return null;
        }
    }
    function compararListas(listaLocalMap, listaRemotaMap) {
        const nuevos = [], eliminados = [], modificados = [];
        listaRemotaMap.forEach((itemRemoto, codigo) => {
            if (!listaLocalMap.has(codigo)) {
                nuevos.push(itemRemoto);
            } else {
                const itemLocal = listaLocalMap.get(codigo);
                let changedFields = {};
                const localDesc = itemLocal.descripcion||'', remoteDesc = itemRemoto.descripcion||'';
                const localUpc = itemLocal.upc||'', remoteUpc = itemRemoto.upc||'';
                const localBrand = itemLocal.brand||'', remoteBrand = itemRemoto.brand||'';
                const localUrl = itemLocal.url||'', remoteUrl = itemRemoto.url||'';
                if (localDesc !== remoteDesc) changedFields.descripcion = { old: localDesc, new: remoteDesc};
                if (localUpc !== remoteUpc) changedFields.upc = { old: localUpc, new: remoteUpc};
                if (localBrand !== remoteBrand) changedFields.brand = { old: localBrand, new: remoteBrand};
                if (localUrl !== remoteUrl) changedFields.url = { old: localUrl, new: remoteUrl};
                if (Object.keys(changedFields).length > 0) {
                    modificados.push({ ...itemRemoto, changedFields });
                }
            }
        });
        listaLocalMap.forEach((itemLocal, codigo) => {
            if (!listaRemotaMap.has(codigo)) {
                eliminados.push(itemLocal);
            }
        });
        return { nuevos, eliminados, modificados };
    }
    function mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraRepositorioMap) {
        const popularListaResumen = (ul, items, fmt) => {
            ul.innerHTML = items.length > 0 ? items.map(fmt).join('') : '<li>Ninguno</li>';
        };
        const itemFormatter = itm => `<li><span class="code">${itm.codigo}</span>: D:${itm.descripcion||'N/A'}, U:${itm.upc||'N/A'}, B:${itm.brand||'N/A'}, ImgURL:${itm.url||'N/A'}</span></li>`;
        popularListaResumen(resumenNuevosUl, nuevos, itemFormatter);
        popularListaResumen(resumenEliminadosUl, eliminados, itemFormatter);
        popularListaResumen(resumenModificadosUl, modificados, itm => {
            let chgs = '';
            if(itm.changedFields.descripcion) chgs += `<span class="field-change">Desc: <s>${itm.changedFields.descripcion.old||'N/A'}</s> &rarr; ${itm.changedFields.descripcion.new||'N/A'}</span>`;
            if(itm.changedFields.upc) chgs += `<span class="field-change">UPC: <s>${itm.changedFields.upc.old||'N/A'}</s> &rarr; ${itm.changedFields.upc.new||'N/A'}</span>`;
            if(itm.changedFields.brand) chgs += `<span class="field-change">Brand: <s>${itm.changedFields.brand.old||'N/A'}</s> &rarr; ${itm.changedFields.brand.new||'N/A'}</span>`;
            if(itm.changedFields.url) chgs += `<span class="field-change">URL Img: <s>${itm.changedFields.url.old||'N/A'}</s> &rarr; ${itm.changedFields.url.new||'N/A'}</span>`;
            return `<li><span class="code">${itm.codigo}</span>${chgs}</li>`;
        });
        btnConfirmarCambiosRepositorio.onclick = () => {
            listaFoco = new Map(maestraRepositorioMap);
            rebuildUpcToCodigoMap();
            saveListaFocoToStorage();
            updateFocoPreviewAndSearch();
            panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems) desde el repositorio y guardada localmente.`;
            panelInicioInfo.className = 'panel-inicio-info';
            navigateToView('panelInicio');
        };
        btnRechazarCambiosRepositorio.onclick = () => {
            rebuildUpcToCodigoMap(); // Ya est√° usando la local (listaFocoCacheadaLocalmente que se pas√≥ a listaFoco)
            updateFocoPreviewAndSearch();
            panelInicioInfo.innerHTML = `‚ÑπÔ∏è Cambios del repositorio ignorados. Se mantiene la Maestra local (${listaFoco.size} √≠tems).`;
            panelInicioInfo.className = 'panel-inicio-info info';
            navigateToView('panelInicio');
        };
        navigateToView('confirmacionCambiosStep');
    }
    async function checkInitialState() {
        loadListaFocoFromStorage(false); // Carga la guardada localmente en listaFoco
        listaFocoCacheadaLocalmente = new Map(listaFoco); // Guarda una copia para comparar
        panelInicioInfo.innerHTML = 'üîÑ Sincronizando Maestra TMR desde el repositorio...';
        panelInicioInfo.className = 'panel-inicio-info info';
        btnIniciarDobleControlDesdePanel.disabled = true;
        btnGestionMaestraDesdePanel.disabled = true;
        const maestraDesdeRepositorio = await cargarMaestraDesdeRepositorio();
        btnIniciarDobleControlDesdePanel.disabled = false;
        btnGestionMaestraDesdePanel.disabled = false;

        if (maestraDesdeRepositorio) {
            const { nuevos, eliminados, modificados } = compararListas(listaFocoCacheadaLocalmente, maestraDesdeRepositorio);

            let localIsIdenticalToRemote = true;
            if (listaFocoCacheadaLocalmente.size !== maestraDesdeRepositorio.size) {
                localIsIdenticalToRemote = false;
            } else {
                for (const [key, remoteItem] of maestraDesdeRepositorio.entries()) {
                    const localItem = listaFocoCacheadaLocalmente.get(key);
                    if (!localItem ||
                        (localItem.descripcion || '') !== (remoteItem.descripcion || '') ||
                        (localItem.upc || '') !== (remoteItem.upc || '') ||
                        (localItem.brand || '') !== (remoteItem.brand || '') ||
                        (localItem.url || '') !== (remoteItem.url || '') ) {
                        localIsIdenticalToRemote = false;
                        break;
                    }
                }
            }

            if (nuevos.length === 0 && eliminados.length === 0 && modificados.length === 0 && localIsIdenticalToRemote) {
                // No hay cambios y la local es id√©ntica (o ya fue actualizada y guardada)
                panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems). Ya estaba actualizada.`;
            } else if (nuevos.length === 0 && eliminados.length === 0 && modificados.length === 0) {
                panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems).`;
            } else if (nuevos.length > 0 || eliminados.length > 0 || modificados.length > 0) {
                panelInicioInfo.innerHTML = `‚ÑπÔ∏è Se detectaron cambios en la Maestra TMR del repositorio. Revisa y confirma.`;
                panelInicioInfo.className = 'panel-inicio-info warning';
                mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraDesdeRepositorio);
                return; // Esperar acci√≥n del usuario
            } else {
                panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems).`;
            }
            panelInicioInfo.className = 'panel-inicio-info';
            updateFocoPreviewAndSearch();
            navigateToView('panelInicio');
        } else {
            if (listaFoco.size > 0) {
                panelInicioInfo.innerHTML = `‚ö†Ô∏è Error al cargar desde el repositorio. Usando Maestra local (${listaFoco.size} √≠tems).`;
                panelInicioInfo.className = 'panel-inicio-info warning';
            } else {
                panelInicioInfo.innerHTML = `‚ùå Error al cargar desde el repositorio y no hay Maestra local. Funcionalidad limitada.`;
                panelInicioInfo.className = 'panel-inicio-info error';
                btnIniciarDobleControlDesdePanel.disabled = true;
                btnGestionMaestraDesdePanel.disabled = true;
            }
            rebuildUpcToCodigoMap(); // Asegurar que el mapa UPC est√© actualizado con la local (si existe)
            updateFocoPreviewAndSearch();
            navigateToView('panelInicio');
        }
    }

    // ----- NAVEGACI√ìN DE VISTAS -----
    function navigateToView(viewName) {
        [panelInicioDiv, gestionMaestraStepDiv, dobleControlStepDiv, resultadosStepDiv, confirmacionCambiosStepDiv, itemDetailModal].forEach(div => div.classList.add('hidden'));
        if (viewName !== 'itemDetailModal') itemDetailModal.style.display = 'none';
        if (viewName === 'panelInicio') panelInicioDiv.classList.remove('hidden');
        else if (viewName === 'gestionMaestraStep') { gestionMaestraStepDiv.classList.remove('hidden'); updateFocoPreviewAndSearch(); }
        else if (viewName === 'dobleControlStep') dobleControlStepDiv.classList.remove('hidden');
        else if (viewName === 'resultadosStep') resultadosStepDiv.classList.remove('hidden');
        else if (viewName === 'confirmacionCambiosStep') confirmacionCambiosStepDiv.classList.remove('hidden');
    }

    // ----- UTILIDADES -----
    function cleanCode(code) {
        if (typeof code !== 'string' && typeof code !== 'number') return '';
        return String(code).trim().replace(/[^a-zA-Z0-9\-]+/g, '').toUpperCase();
    }
    function resetFileInput(el) { if(el) el.value = null; }
    function getDelimiterRegex(d) {
        if (d.toLowerCase()==='<tab>') return /\t/;
        return new RegExp(d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
    }

    // ----- GESTI√ìN LISTA MAESTRA (B√öSQUEDA Y ESTAD√çSTICAS) -----
    function updateFocoPreviewAndSearch(itemsToShow = null) {
        let countNoUrl = 0, countNoUpc = 0, countNoDescription = 0, countNoBrand = 0;
        listaFoco.forEach(item => {
            if (!item.url || item.url.trim() === '') countNoUrl++;
            if (!item.upc || item.upc.trim() === '') countNoUpc++;
            if (!item.descripcion || item.descripcion.trim() === '') countNoDescription++;
            if (!item.brand || item.brand.trim() === '') countNoBrand++;
        });
        statTotalItems.textContent = listaFoco.size;
        statNoImageUrl.textContent = countNoUrl;
        statNoUpc.textContent = countNoUpc;
        statNoDescription.textContent = countNoDescription;
        statNoBrand.textContent = countNoBrand;
        const searchTerm = searchFocoInput.value.toLowerCase().trim();
        if (itemsToShow) {
            focoSearchResultsDiv.innerHTML = '';
            if (itemsToShow.length > 0) {
                itemsToShow.slice(0, 30).forEach(item => {
                    const p = document.createElement('div');
                    p.className = 'search-result-item';
                    p.innerHTML = `<span class="code">${item.codigo}</span> <span class="upc-brand-url">(UPC: ${item.upc||'N/A'}, M: ${item.brand||'N/A'}, Img: ${item.url ? 'S√≠':'No'})</span> <span class="desc">${item.descripcion||'(S/D)'}</span>`;
                    p.addEventListener('click', () => openItemDetailModal(item.codigo));
                    focoSearchResultsDiv.appendChild(p);
                });
                if (itemsToShow.length > 30) {
                    focoSearchResultsDiv.innerHTML += `<p style="text-align:center; font-style:italic;">... y ${itemsToShow.length - 30} m√°s. Refine su b√∫squeda.</p>`;
                }
            } else if (searchTerm !== '') {
                focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">No se encontraron √≠tems que coincidan con la b√∫squeda.</p>';
            } else {
                focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">Ingrese un t√©rmino para buscar en la Lista Maestra...</p>';
            }
        } else if (searchTerm === '' && !itemsToShow) {
            focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">Ingrese un t√©rmino para buscar en la Lista Maestra...</p>';
        }
    }
    function saveListaFocoToStorage(showAlert = true) {
        if (listaFoco.size === 0 && showAlert && !confirm("La Maestra est√° vac√≠a. ¬øGuardar vac√≠a?")) return false;
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_LISTA_FOCO, JSON.stringify(Array.from(listaFoco.values())));
            if (showAlert) alert(`Maestra con ${listaFoco.size} √≠tems guardada localmente.`);
            return true;
        } catch (e) {
            if (showAlert) alert("Error al guardar Maestra local: " + e.message);
            return false;
        }
    }
    function loadListaFocoFromStorage(showAlerts = true) {
        const data = localStorage.getItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
        listaFoco.clear();
        if (data) {
            try {
                const itemsArray = JSON.parse(data);
                itemsArray.forEach(item => {
                    const idItemLimpio = cleanCode(item.codigo);
                    if (idItemLimpio) {
                        listaFoco.set(idItemLimpio, {
                            codigo: idItemLimpio,
                            upc: item.upc||'',
                            descripcion: item.descripcion||'',
                            brand: item.brand||'',
                            url: item.url||''
                        });
                    }
                });
                if (showAlerts) alert(`Maestra local con ${listaFoco.size} √≠tems cargada.`);
            } catch (e) {
                if (showAlerts) alert("Error al cargar Maestra local: datos corruptos. Se borrar√°.");
                localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
                listaFoco.clear();
            }
        } else {
            if (showAlerts) console.log("No hay Maestra guardada localmente."); // Cambiado a console.log para menos alertas
        }
        // rebuildUpcToCodigoMap(); // Se llama despu√©s en checkInitialState o donde sea necesario
    }
    searchFocoInput.addEventListener('input', () => {
        const searchTerm = searchFocoInput.value.toLowerCase().trim();
        if (!searchTerm) {
            focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">Ingrese un t√©rmino para buscar en la Lista Maestra...</p>';
            return;
        }
        const results = Array.from(listaFoco.values()).filter(item =>
            item.codigo.toLowerCase().includes(searchTerm) ||
            (item.upc && item.upc.toLowerCase().includes(searchTerm)) ||
            (item.descripcion && item.descripcion.toLowerCase().includes(searchTerm)) ||
            (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
            (item.url && item.url.toLowerCase().includes(searchTerm))
        );
        updateFocoPreviewAndSearch(results);
    });
    btnVolverAlPanelDesdeGestion.addEventListener('click', () => navigateToView('panelInicio'));

    // ----- LECTURA DE ARCHIVOS (VERIFICACI√ìN) Y MANEJO LISTA A VERIFICAR -----
    function addValidCodeToVerifyList(idItem) {
        // Convert to Number first to remove leading zeros, then to String
        const trimmedIdItem = String(Number(idItem)).trim();
        if (/^[0-9]+$/.test(trimmedIdItem) && trimmedIdItem.length > 5) {
            if (!listaVerificar.has(trimmedIdItem)) {
                listaVerificar.add(trimmedIdItem);
                return trimmedIdItem;
            }
            return null; // Ya existe
        }
        return false; // Inv√°lido
    }
    function handleFileUpload(file, isExcel) {
        if (!file) return;
        verifyPreview.innerHTML = `Procesando "${file.name}"...`;
        const idItemCol = parseInt(verifyCodigoColInput.value) - 1;
        const delimiter = verifyCsvDelimiterInput.value;
        const hasHeader = verifyHasHeaderCheckbox.checked;
        const targetFileElement = isExcel ? verifyFileExcel : verifyFileTxtCsv;
        if (idItemCol < 0) {
            alert("Col. ID √çtem debe ser >= 1.");
            verifyPreview.textContent = "Error.";
            resetFileInput(targetFileElement);
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            let itemsFromFile = [];
            try {
                if (isExcel) itemsFromFile = processExcelDataForVerify(content, idItemCol, hasHeader);
                else itemsFromFile = processTextCsvDataForVerify(content, idItemCol, hasHeader, delimiter);

                listaVerificar.clear(); // Limpiar antes de a√±adir nuevos de archivo
                scannedCodesVerifyTextarea.value = ''; // Limpiar √°rea de escaneo tambi√©n
                let addedCount = 0, omittedCount = 0, duplicateCount = 0;
                itemsFromFile.forEach(idItemFromFile => {
                    const result = addValidCodeToVerifyList(idItemFromFile);
                    if (result === null) { // Ya estaba en la lista
                        duplicateCount++;
                    } else if (result !== false) { // A√±adido correctamente
                        addedCount++;
                    } else { // Formato inv√°lido
                        omittedCount++;
                    }
                });
                if (omittedCount > 0) alert(`${omittedCount} ID(s) de √çtem del archivo fueron omitidos (no num√©ricos > 5 d√≠gitos).`);
                if (duplicateCount > 0) alert(`${duplicateCount} ID(s) de √çtem del archivo ya estaban en la lista (omitidos).`);
                updateVerifyPreview();
            } catch (error) {
                alert(`Error procesando ${file.name}: ${error.message}`);
                verifyPreview.textContent = `Error.`;
            }
            resetFileInput(targetFileElement);
        };
        reader.onerror = () => {
            alert(`No se pudo leer ${file.name}.`);
            verifyPreview.textContent = `Error.`;
            resetFileInput(targetFileElement);
        };
        if (isExcel) reader.readAsArrayBuffer(file);
        else reader.readAsText(file);
    }
    function processTextCsvDataForVerify(content, colIdx, hasHeader, delimiter = ',') {
        const lines = content.split(/\r\n|\n/);
        const dataRows = hasHeader ? lines.slice(1) : lines;
        const items = [];
        const delimRegex = getDelimiterRegex(delimiter);
        dataRows.forEach(line => {
            if (line.trim() === '') return;
            const parts = line.split(delimRegex);
            const rawValue = parts[colIdx] ? String(parts[colIdx]).trim() : null;
            if (rawValue) {
                // Convert to Number to remove leading zeros, then to String
                const val = String(Number(rawValue));
                items.push(val);
            }
        });
        return items;
    }
    function processExcelDataForVerify(arrayBuffer, colIdx, hasHeader) {
        const items = [];
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheetName = workbook.SheetNames[0];
        if (!firstSheetName) throw new Error("Excel sin hojas.");
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, rawNumbers: false, defval: null }); // rawNumbers: false para asegurar strings
        const dataRows = hasHeader ? jsonData.slice(1) : jsonData;
        dataRows.forEach(row => {
            if (!row) return;
            const rawValue = (row[colIdx] !== null && row[colIdx] !== undefined) ? String(row[colIdx]).trim() : null;
            if (rawValue) {
                // Convert to Number to remove leading zeros, then to String
                const val = String(Number(rawValue));
                items.push(val);
            }
        });
        return items;
    }
    verifyFileTxtCsv.addEventListener('change', (e) => handleFileUpload(e.target.files[0], false));
    verifyFileExcel.addEventListener('change', (e) => handleFileUpload(e.target.files[0], true));
    function updateVerifyPreview() {
        verifyPreview.textContent = `Lista de IDs de √çtem V√°lidos a Verificar: ${listaVerificar.size}. ${listaVerificar.size > 0 ? `Primeros: ${[...listaVerificar].slice(0,5).join(', ')}${listaVerificar.size > 5 ? '...' : ''}` : 'Vac√≠a.'}`;
    }
    function collectVerifyDataFromInputs() { // Se llama antes de comparar
        const textVerifyItems = verifyTextarea.value.trim();
        if (textVerifyItems) {
            textVerifyItems.split(/\s+/).forEach(idItemFromText => {
                addValidCodeToVerifyList(idItemFromText); // A√±ade si es v√°lido y no existe
            });
        }
        updateVerifyPreview();
    }
    btnVolverAlPanelDesdeDobleControl.addEventListener('click', () => navigateToView('panelInicio'));
    btnCompare.addEventListener('click', () => {
        collectVerifyDataFromInputs();
        if (listaVerificar.size === 0) {
            alert("Cargue o escanee √çtems v√°lidos para la Lista de Verificaci√≥n.");
            return;
        }
        if (listaFoco.size === 0) {
            alert("La Lista Maestra est√° vac√≠a. Sincronice con el repositorio.");
            navigateToView('panelInicio');
            return;
        }
        compareListsAndDisplayResults();
        navigateToView('resultadosStep');
    });
    function onScanSuccessVerify(decodedText, decodedResult){
        const scannedUPC_full = cleanText(decodedText);
        let internalCode = null;
        let matchedMasterUPCForLog = null;
        if (scannedUPC_full) {
            if (upcToCodigoMap.size === 0 && listaFoco.size > 0) {
                // Esta alerta es √∫til si la maestra no tiene UPCs
                // alert("Advertencia: Su Lista Maestra no parece tener UPCs mapeados. El escaneo de UPC no encontrar√° √çtems.");
            }
            if (upcToCodigoMap.has(scannedUPC_full)) {
                internalCode = upcToCodigoMap.get(scannedUPC_full);
                matchedMasterUPCForLog = scannedUPC_full;
            } else if (scannedUPC_full.length > 1) {
                const scannedUPC_chopped = scannedUPC_full.substring(0, scannedUPC_full.length - 1);
                if (upcToCodigoMap.has(scannedUPC_chopped)) {
                    internalCode = upcToCodigoMap.get(scannedUPC_chopped);
                    matchedMasterUPCForLog = scannedUPC_chopped;
                }
            }
            if (internalCode) {
                const addedIdItemResult = addValidCodeToVerifyList(internalCode);
                if (addedIdItemResult !== false && addedIdItemResult !== null) { // Fue a√±adido
                    const currentScannedText = scannedCodesVerifyTextarea.value.trim();
                    let logMessage = `${addedIdItemResult} (Scan: ${scannedUPC_full}`;
                    if (scannedUPC_full !== matchedMasterUPCForLog && matchedMasterUPCForLog !== null) {
                        logMessage += ` -> Maestra: ${matchedMasterUPCForLog}`;
                    }
                    logMessage += `)`;
                    scannedCodesVerifyTextarea.value = currentScannedText ? `${currentScannedText}\n${logMessage}` : logMessage;
                    updateVerifyPreview();
                } else if (addedIdItemResult === null) { // Ya estaba
                    let alertMessage = `El √çtem ${internalCode} (Scan: ${scannedUPC_full}`;
                    if (scannedUPC_full !== matchedMasterUPCForLog && matchedMasterUPCForLog !== null) {
                        alertMessage += ` -> Maestra: ${matchedMasterUPCForLog}`;
                    }
                    alertMessage += `) ya est√° en la lista de verificaci√≥n.`;
                    // alert(alertMessage); // Puede ser molesto, opcional
                    console.log(alertMessage);
                } else { // Formato de internalCode inv√°lido (raro si viene de la maestra)
                    let alertMessage = `El ID de √çtem (${internalCode}) asociado al UPC (Scan: ${scannedUPC_full}`;
                    if (scannedUPC_full !== matchedMasterUPCForLog && matchedMasterUPCForLog !== null) {
                        alertMessage += ` -> Maestra: ${matchedMasterUPCForLog}`;
                    }
                    alertMessage += `) no cumple el formato y ser√° omitido.`;
                    alert(alertMessage);
                }
            } else {
                alert(`UPC escaneado (${scannedUPC_full}) no encontrado en la Lista Maestra (incluso sin √∫ltimo d√≠gito).`);
            }
        } else {
            alert("Escaneo no produjo un UPC utilizable.");
        }
    }
    startScanVerifyBtn.addEventListener('click', () => {
        if(scannerVerifierActive){
            if(html5QrCodeVerifier && html5QrCodeVerifier.isScanning){
                html5QrCodeVerifier.stop().then(() => {
                    scannerVerifierActive = false;
                    scannerContainerVerify.classList.add('hidden');
                    startScanVerifyBtn.textContent = 'üì∑ Escanear UPC de Art√≠culo';
                }).catch(err => console.error("Error deteniendo esc√°ner:", err));
            } else { // Si no estaba escaneando pero el flag estaba activo, resetear.
                scannerVerifierActive = false;
                scannerContainerVerify.classList.add('hidden');
                startScanVerifyBtn.textContent = 'üì∑ Escanear UPC de Art√≠culo';
            }
        } else {
            if(location.protocol !=='https:' && !['localhost','127.0.0.1'].includes(location.hostname)){
                alert('El esc√°ner de c√≥digos de barras requiere un entorno seguro (HTTPS) o ser ejecutado en localhost.');
                return;
            }
            scannerContainerVerify.classList.remove('hidden');
            startScanVerifyBtn.textContent = 'üõë Detener Esc√°ner';
            if(!html5QrCodeVerifier) html5QrCodeVerifier = new Html5Qrcode("readerVerify", { verbose: false });
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 100 },
                rememberLastUsedCamera: true,
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
            };
            html5QrCodeVerifier.start({ facingMode: "environment" }, config, onScanSuccessVerify, (error) => { /* ignorar errores de no detecci√≥n */ })
            .then(() => scannerVerifierActive = true)
            .catch(err => {
                alert(`Error al iniciar esc√°ner: ${err.message || err}`);
                scannerContainerVerify.classList.add('hidden');
                startScanVerifyBtn.textContent = 'üì∑ Escanear UPC de Art√≠culo';
                scannerVerifierActive = false;
            });
        }
    });

    // ----- COMPARACI√ìN Y RESULTADOS -----
    function compareListsAndDisplayResults(){
        coincidencias.clear();
        listaVerificar.forEach(idItemToVerify => {
            if(listaFoco.has(idItemToVerify)) {
                coincidencias.set(idItemToVerify, listaFoco.get(idItemToVerify));
            }
        });
        displayFinalResults();
    }
    function displayFinalResults(){
        totalFocoSpan.textContent=listaFoco.size;
        totalVerifySpan.textContent=listaVerificar.size;
        totalMatchesSpan.textContent=coincidencias.size;
        outputResultsDiv.innerHTML='';
        outputResultsDiv.className='list'; // Por defecto a lista
        if(coincidencias.size===0){
            outputResultsDiv.innerHTML='<p>No se encontraron √çtems concordantes.</p>';
        } else {
            coincidencias.forEach(item => {
                const cD = document.createElement("div");
                cD.className="barcode-item-container";
                cD.setAttribute('data-iditem', item.codigo);
                cD.addEventListener('click', () => openItemDetailModal(item.codigo));

                const cP = document.createElement("p");
                cP.className="barcode-item-code";
                cP.textContent = item.codigo;
                cD.appendChild(cP);

                if(item.descripcion){
                    const dP=document.createElement("p");
                    dP.className="barcode-item-desc";
                    dP.textContent = item.descripcion;
                    cD.appendChild(dP);
                }

                const brandP = document.createElement("p");
                brandP.style.fontSize = "0.8em";
                brandP.style.textAlign = "center";
                brandP.style.color = "#777";
                brandP.textContent = `Marca: ${item.brand||'N/A'}`;
                cD.appendChild(brandP);

                const sD = document.createElement("div");
                sD.className="barcode-item-svg";
                const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
                try {
                    JsBarcode(svg, item.codigo, {
                        format:"CODE128",
                        width:2,
                        height:50,
                        displayValue:false,
                        margin:5
                    });
                    sD.appendChild(svg);
                } catch(e) {
                    console.error("Error JsBarcode:", e, "para item:", item.codigo);
                    sD.innerHTML=`<p style="color:red;font-size:0.8em;">Error BC</p>`;
                }
                cD.appendChild(sD);
                outputResultsDiv.appendChild(cD);
            });
        }
    }
    function openItemDetailModal(idItem) {
        const item = listaFoco.get(idItem) || coincidencias.get(idItem);
        if (item) {
            modalItemCodigo.textContent = "ID √çtem: " + item.codigo;
            modalItemDescripcion.textContent = item.descripcion || 'No disponible';
            modalItemUPC.textContent = item.upc || 'No disponible';
            modalItemBrand.textContent = item.brand || 'No disponible';
            const imageUrl = item.url ? item.url.trim() : '';
            if (imageUrl) {
                modalItemImage.src = imageUrl;
                modalItemImage.alt = "Imagen de " + (item.descripcion || item.codigo);
                modalItemImage.style.display = 'block';
                modalImageError.style.display = 'none';
            } else {
                modalItemImage.style.display = 'none';
                modalItemImage.src = '#'; // Clear previous image
                modalImageError.textContent = 'URL de imagen no especificada.';
                modalImageError.style.display = 'block';
            }
            itemDetailModal.classList.remove('hidden');
            itemDetailModal.style.display = 'flex';
        }
    }
    function closeItemDetailModal() {
        itemDetailModal.classList.add('hidden');
        itemDetailModal.style.display = 'none';
        modalItemImage.src="#";
        modalItemImage.style.display = 'none';
        modalImageError.style.display = 'none';
    }
    layoutToggleResultsBtn.addEventListener('click',()=>{
        outputResultsDiv.classList.toggle('grid');
        outputResultsDiv.classList.toggle('list');
        layoutToggleResultsBtn.textContent = outputResultsDiv.classList.contains('grid') ? 'üìä Vista Lista' : 'üìä Vista Cuadr√≠cula';
    });
    downloadCsvResultsBtn.addEventListener('click',()=>{
        if(coincidencias.size===0){alert("No hay √çtems concordantes para descargar.");return;}
        let cC="ID_Item,UPC,Descripcion,Marca,URL_Imagen\n";
        coincidencias.forEach(item=>{
            const desc = `"${(item.descripcion||'').replace(/"/g,'""')}"`;
            const upcVal = `"${(item.upc||'').replace(/"/g,'""')}"`;
            const brandVal = `"${(item.brand||'').replace(/"/g,'""')}"`;
            const urlVal = `"${(item.url||'').replace(/"/g,'""')}"`;
            cC+=`${item.codigo},${upcVal},${desc},${brandVal},${urlVal}\n`;
        });
        const b=new Blob([cC],{type:'text/csv;charset=utf-8;'});
        const l=document.createElement("a");
        const u=URL.createObjectURL(b);
        l.setAttribute("href",u);
        l.setAttribute("download",`concordancias_sdci_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(u);
    });

    downloadXlsxResultsBtn.addEventListener('click', async () => {
        if (coincidencias.size === 0) {
            alert("No hay √çtems concordantes para generar el archivo XLSX.");
            return;
        }
        downloadXlsxResultsBtn.textContent = 'Generando XLSX...';
        downloadXlsxResultsBtn.disabled = true;

        try {
            const dataForSheet = [];
            const numCols = 4;

            dataForSheet.push(["Control TMR 2025"].concat(Array(numCols - 1).fill(null)));
            const currentDateFormatted = new Date().toLocaleDateString("es-CL", { year: 'numeric', month: 'long', day: 'numeric' });
            dataForSheet.push(["Fecha de Generaci√≥n:", currentDateFormatted].concat(Array(numCols - 2).fill(null)));
            dataForSheet.push(Array(numCols).fill(null)); // Blank row for spacing

            Array.from(coincidencias.values()).forEach(item => {
                dataForSheet.push(["ID √çtem:", item.codigo, null, null]);
                dataForSheet.push(["Descripci√≥n:", item.descripcion || '', null, null]);
                dataForSheet.push(["Marca:", item.brand || '', null, null]);
                // Barcode image will be added manually or via script in Excel if needed, here we just reserve space or add a note
                dataForSheet.push(["Revisado:", "‚òê " + "_".repeat(30) + " (Firma/Obs)", null, null]);
                dataForSheet.push(["Diferencias Encontradas:", "_".repeat(45), null, null]);
                dataForSheet.push([null, "_".repeat(45), null, null]);
                dataForSheet.push(Array(numCols).fill(null)); // Separator row
            });

            const ws = XLSX.utils.aoa_to_sheet(dataForSheet);
            ws['!cols'] = [ { wch: 25 }, { wch: 60 }, { wch: 10 }, { wch: 10 } ]; // Column widths

            const merges = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: numCols - 1 } }, // Title
                { s: { r: 1, c: 1 }, e: { r: 1, c: numCols - 1 } }  // Date value
            ];

            let currentRow = 3; // Start after header block
            Array.from(coincidencias.values()).forEach(() => {
                merges.push({ s: { r: currentRow + 3, c: 1 }, e: { r: currentRow + 3, c: numCols -1 } }); // Revisado line
                merges.push({ s: { r: currentRow + 4, c: 1 }, e: { r: currentRow + 4, c: numCols -1 } }); // Diferencias line 1
                merges.push({ s: { r: currentRow + 5, c: 1 }, e: { r: currentRow + 5, c: numCols -1 } }); // Diferencias line 2
                currentRow += 7; // 6 rows per item data + 1 separator
            });
            ws['!merges'] = merges;

            if(ws['A1']) { ws['A1'].s = { font: { bold: true, sz: 16 }, alignment: { horizontal: "center" } }; }
            if(ws['A2']) { ws['A2'].s = { font: { bold: true } }; }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Control TMR");
            const fileName = `Control_TMR_Formato_Detallado_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        } catch (error) {
            console.error("Error generando XLSX:", error);
            alert("Error al generar archivo XLSX: " + error.message);
        } finally {
            downloadXlsxResultsBtn.textContent = 'üìä Descargar XLSX';
            downloadXlsxResultsBtn.disabled = false;
        }
    });

    function generatePdfReport() {
        if (coincidencias.size === 0) {
            alert("No hay √çtems concordantes para generar el PDF.");
            return;
        }

        const originalButtonText = downloadPdfResultsBtn.textContent;
        downloadPdfResultsBtn.textContent = 'Generando PDF...';
        downloadPdfResultsBtn.disabled = true;

        const pdfContainer = document.createElement('div');
        pdfContainer.className = 'pdf-container';

        const header = document.createElement('div');
        header.className = 'pdf-header';
        const title = document.createElement('div');
        title.className = 'pdf-title';
        title.textContent = 'Control Items Foco';
        header.appendChild(title);
        const currentDate = new Date().toLocaleDateString('es-CL');
        const date = document.createElement('div');
        date.className = 'pdf-date';
        date.textContent = `Fecha: ${currentDate}`;
        header.appendChild(date);
        const summary = document.createElement('div');
        summary.className = 'pdf-summary';
        summary.textContent = `Total Items Revisados: ${listaVerificar.size}, TMRs Encontrados: ${coincidencias.size}`;
        header.appendChild(summary);
        pdfContainer.appendChild(header);

        coincidencias.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'pdf-item';

            const itemLabel = document.createElement('div');
            itemLabel.className = 'pdf-item-label';
            itemLabel.textContent = '√çtem:';
            itemDiv.appendChild(itemLabel);

            const barcodeContainer = document.createElement('div');
            barcodeContainer.className = 'pdf-barcode-container';
            const svgBarcode = document.createElementNS("http://www.w3.org/2000/svg","svg");
            svgBarcode.classList.add('pdf-barcode-svg');
            try {
                JsBarcode(svgBarcode, item.codigo, {
                    format:"CODE128",
                    width: 1.5,
                    height: 50,
                    displayValue: true,
                    fontSize: 10,
                    margin: 5
                });
                barcodeContainer.appendChild(svgBarcode);
            } catch(e) {
                console.error("Error JsBarcode para PDF:", e, "para item:", item.codigo);
                barcodeContainer.innerHTML = `<p style="color:red;font-size:0.8em; text-align:center;">Error BC</p>`;
            }
            itemDiv.appendChild(barcodeContainer);

            const infoDiv = document.createElement('div');
            infoDiv.className = 'pdf-item-info';
            infoDiv.innerHTML = `<span class="pdf-item-label">Descripci√≥n:</span>${item.descripcion || 'N/A'}<br>`;
            infoDiv.innerHTML += `<span class="pdf-item-label">Marca:</span>${item.brand || 'N/A'}`;
            itemDiv.appendChild(infoDiv);

            const manualInput = document.createElement('div');
            manualInput.className = 'pdf-manual-input';
            manualInput.innerHTML = `<label for="cantidadControl_${item.codigo}">Cantidad de Control:</label><div></div>`;
            manualInput.innerHTML += `<label for="diferencias_${item.codigo}">Diferencias:</label><textarea id="diferencias_${item.codigo}"></textarea>`;
            itemDiv.appendChild(manualInput);

            pdfContainer.appendChild(itemDiv);
        });

        const opt = {
            margin: [10, 10, 10, 10],
            filename: `Control_Items_Foco_${currentDate.replace(/\//g, '-')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' },
            pagebreak: { mode: 'avoid', before: '.pdf-item' }
        };

        pdfContainer.style.position = 'absolute';
        pdfContainer.style.left = '-9999px';
        document.body.appendChild(pdfContainer);

        html2pdf().from(pdfContainer).set(opt).save().finally(() => {
            downloadPdfResultsBtn.textContent = originalButtonText;
            downloadPdfResultsBtn.disabled = false;
            if (document.body.contains(pdfContainer)) {
                document.body.removeChild(pdfContainer);
            }
        });
    }
    downloadPdfResultsBtn.addEventListener('click', generatePdfReport);


    // ----- BOTONES PANEL INICIO -----
    btnIniciarDobleControlDesdePanel.addEventListener('click', () => {
        if (listaFoco.size === 0) {
            alert("No hay Lista Maestra cargada. Sincronice con el repositorio.");
            return;
        }
        listaVerificar.clear();
        coincidencias.clear();
        verifyTextarea.value = '';
        scannedCodesVerifyTextarea.value = '';
        resetFileInput(verifyFileTxtCsv);
        resetFileInput(verifyFileExcel);
        updateVerifyPreview();
        navigateToView('dobleControlStep');
    });
    btnGestionMaestraDesdePanel.addEventListener('click', () => navigateToView('gestionMaestraStep'));
    btnBorrarMaestraStorage.addEventListener('click', () => {
        if (confirm("¬øSeguro que desea borrar la Maestra guardada localmente? \nSe intentar√° resincronizar con el repositorio.")) {
            localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
            listaFoco.clear();
            listaFocoCacheadaLocalmente.clear();
            upcToCodigoMap.clear();
            alert("Maestra local borrada. Se resincronizar√° con el repositorio.");
            checkInitialState(); // Volver a sincronizar
        }
    });

    // ----- NUEVA VERIFICACI√ìN -----
    btnNewVerification.addEventListener('click', () => {
        listaVerificar.clear();
        coincidencias.clear();
        verifyTextarea.value = '';
        scannedCodesVerifyTextarea.value = '';
        resetFileInput(verifyFileTxtCsv);
        resetFileInput(verifyFileExcel);
        updateVerifyPreview();
        outputResultsDiv.innerHTML = '<p>No se han encontrado coincidencias o no se ha realizado la verificaci√≥n.</p>';
        totalVerifySpan.textContent = '0';
        totalMatchesSpan.textContent = '0';
        if(scannerVerifierActive && html5QrCodeVerifier && html5QrCodeVerifier.isScanning) {
            html5QrCodeVerifier.stop().catch(err => console.error("Error deteniendo esc√°ner en nueva verificaci√≥n:", err));
            scannerVerifierActive = false;
            scannerContainerVerify.classList.add('hidden');
            startScanVerifyBtn.textContent = 'üì∑ Escanear UPC de Art√≠culo';
        }
        navigateToView('panelInicio'); // Volver al panel de inicio
    });

  </script>
</body>
</html>
