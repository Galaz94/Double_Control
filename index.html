<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Doble Control de √çtems v2.8.2 (Estad√≠sticas Maestra)</title>
  <style>
    /* ... (Estilos CSS de la v2.8.1 se mantienen) ... */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 15px;
      background-color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h1, h2, h3 {
      color: #2c3e50;
      text-align: center;
    }
    h1 { margin-bottom: 30px; font-size: 1.8em;}
    h2 { margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.5em;}
    h3 { margin-bottom: 15px; font-size: 1.2em; text-align: left;}

    .section {
      border: 1px solid #e0e0e0;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      background-color: #fdfdfd;
    }
    .hidden { display: none !important; }
    .panel-inicio-info {
        font-size: 1.1em;
        color: #27ae60; /* Verde para mensaje positivo */
        margin-bottom: 20px;
        padding: 15px;
        background-color: #e8f8f0;
        border-left: 5px solid #27ae60;
        border-radius: 4px;
    }
    .panel-inicio-info.warning { color: #f39c12; background-color: #fef9e7; border-left-color: #f39c12;}
    .panel-inicio-info.error { color: #c0392b; background-color: #fdedec; border-left-color: #c0392b;}
    .panel-inicio-info.info { color: #2980b9; background-color: #eaf2f8; border-left-color: #2980b9;}

    .panel-inicio-actions button { margin-top: 10px; width: 100%; box-sizing: border-box; padding: 12px;}


    .input-group { margin-bottom: 20px; }
    .input-group label, .file-options label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 0.95em;
    }
    textarea, input[type="file"], select, input[type="text"], input[type="search"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    textarea { min-height: 100px; }
    .file-options { border: 1px solid #ddd; padding: 15px; margin-top: -10px; margin-bottom:15px; border-radius: 0 0 4px 4px; background-color: #f9f9f9;}
    .input-columns { display: flex; gap: 15px; align-items: flex-end; }
    .input-columns > div { flex: 1; }
    .input-columns input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle;}


    button {
      background-color: #3498db; /* Azul principal */
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      margin-right: 8px;
      margin-top: 5px;
    }
    button:hover { background-color: #2980b9; /* Azul m√°s oscuro */ }
    button.secondary { background-color: #95a5a6; /* Gris secundario */ }
    button.secondary:hover { background-color: #7f8c8d; /* Gris m√°s oscuro */ }
    button.danger { background-color: #e74c3c; /* Rojo peligro */ }
    button.danger:hover { background-color: #c0392b; }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

    .preview-area, .search-results-area {
      background-color: #ecf0f1;
      border: 1px dashed #bdc3c7;
      padding: 12px;
      min-height: 60px;
      margin-top:10px;
      font-size: 0.9em;
      border-radius: 4px;
      word-break: break-word;
    }
    #focoPreview { /* Estilos espec√≠ficos para el √°rea de estad√≠sticas */
        max-height: none; /* Permitir que crezca si es necesario */
    }
    #focoPreview ul { list-style-type: none; padding-left: 0; }
    #focoPreview li { margin-bottom: 5px; font-size: 0.95em; }
    #focoPreview strong { color: #34495e; }


    .search-results-area { max-height: 200px; overflow-y: auto; } /* Mantener scroll para resultados */
    .preview-item, .search-result-item {
        padding: 6px 3px;
        border-bottom: 1px solid #dde;
        display: flex;
        justify-content: space-between;
        align-items: center; 
    }
    .preview-item:last-child, .search-result-item:last-child { border-bottom: none; }
    .preview-item .code, .search-result-item .code { font-weight: bold; color: #34495e; flex-shrink: 0; margin-right: 10px;}
    .preview-item .desc, .search-result-item .desc { color: #7f8c8d; margin-left: 10px; font-style: italic; text-align: right; flex-grow: 1; }
    .preview-item .upc-brand-url, .search-result-item .upc-brand-url { font-size: 0.85em; color: #555; margin-left: 10px; }


    .results-summary {
      margin-bottom: 25px;
      background-color: #eaf5ff;
      padding: 18px;
      border-radius: 6px;
      border: 1px solid #c1d9ed;
    }
    .results-summary p { margin: 8px 0; font-size: 1.05em; }
    .results-summary strong { color: #2980b9; }
    
    #confirmacionCambiosStep .preview-area { max-height: 120px; margin-bottom: 10px; background-color: #fff; overflow-y: auto;}
    #confirmacionCambiosStep h3 { font-size: 1.1em; margin-bottom:5px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    #confirmacionCambiosStep li { font-size: 0.9em; padding: 3px 0; border-bottom: 1px dotted #eee; }
    #confirmacionCambiosStep li:last-child { border-bottom: none; }
    #confirmacionCambiosStep li s { color: #e74c3c; } 
    #confirmacionCambiosStep li .field-change { display: block; margin-left: 15px; font-size: 0.9em;}


    #outputResults.list .barcode-item-container { margin: 10px 0; background: #fff; padding:12px; border:1px solid #e0e0e0; border-radius:5px; cursor: pointer;}
    #outputResults.grid .barcode-item-container { background: #fff; padding:12px; border:1px solid #e0e0e0; border-radius:5px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; cursor: pointer;}
    #outputResults.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
    
    .barcode-item-code { font-weight: bold; text-align: center; margin-bottom: 4px; font-size: 1em; color: #333; }
    .barcode-item-desc { text-align: center; margin-bottom: 6px; font-size: 0.9em; color: #555; font-style: italic; }
    .barcode-item-svg svg { max-width: 100%; height: auto; display: block; margin: 0 auto;}

    #itemDetailModal {
      position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.5); display: none;
      align-items: center; justify-content: center;
    }
    #itemDetailModal .modal-content {
      background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888;
      width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center; 
      position: relative;
    }
    #itemDetailModal .modal-content h3 { margin-top: 0; color: #3498db; }
    #itemDetailModal .modal-content p { margin: 8px 0; font-size: 1.1em; text-align: left;}
    #itemDetailModal .modal-content strong { color: #555;}
    #itemDetailModal #modalItemImageContainer { margin-top: 15px; margin-bottom: 15px; min-height: 50px; }
    #itemDetailModal #modalItemImage { max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; object-fit: contain; }
    #itemDetailModal .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; }
    #itemDetailModal .close-modal:hover, #itemDetailModal .close-modal:focus { color: black; text-decoration: none; }

    #scannerContainerVerify { max-width: 400px; margin: 15px auto; border: 1px solid #ccc; padding: 5px; border-radius: 4px;}
    #readerVerify { width: 100%; }

    footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      font-size: 0.9em;
      color: #777;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sistema de Doble Control de √çtems v2.8.2</h1>

    <div id="panelInicio" class="section">
      <h2>Panel de Inicio</h2>
      <div id="panelInicioInfo" class="panel-inicio-info info">
        Cargando informaci√≥n de Lista Maestra desde el repositorio...
      </div>
      <div class="panel-inicio-actions">
        <button id="btnIniciarDobleControlDesdePanel" disabled>‚û°Ô∏è Iniciar Doble Control</button>
        <button id="btnGestionMaestraDesdePanel" class="secondary" disabled>üîé Ver Lista Maestra y Buscar</button>
        <button id="btnBorrarMaestraStorage" class="danger secondary" style="margin-top: 20px;">üóëÔ∏è Borrar Maestra Local y Resincronizar</button>
      </div>
    </div>

    <div id="confirmacionCambiosStep" class="section hidden">
      <h2>Confirmar Cambios de Lista Maestra (desde Repositorio)</h2>
      <p>Se han detectado los siguientes cambios respecto a tu lista local guardada:</p>
      <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
          <div id="resumenNuevos"><h3>Nuevos √çtems:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenEliminados"><h3>√çtems Eliminados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenModificados"><h3>√çtems Modificados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
      </div>
      <p>¬øDeseas aplicar estos cambios y usar la versi√≥n del repositorio en tu sesi√≥n actual?</p>
      <div style="text-align: center;">
        <button id="btnConfirmarCambiosRepositorio">S√≠, Aplicar Cambios del Repositorio</button>
        <button id="btnRechazarCambiosRepositorio" class="secondary">No, Mantener Mi Versi√≥n Local</button>
      </div>
    </div>

    <div id="gestionMaestraStep" class="section hidden">
      <h2>Ver Lista Maestra y Buscar</h2>
      <div class="input-group">
        <label for="searchFocoInput">Buscar √çtem (por ID, UPC, descripci√≥n, marca o URL de imagen):</label>
        <input type="text" id="searchFocoInput" placeholder="Ingrese t√©rmino de b√∫squeda...">
      </div>
      <div id="focoSearchResults" class="search-results-area" style="margin-bottom: 20px;">Resultados de la b√∫squeda aparecer√°n aqu√≠...</div>
      
      <div id="focoPreview" class="preview-area">
        <h3>Estad√≠sticas de la Lista Maestra</h3>
        <ul id="masterListStats">
            <li>Total de √çtems: <strong id="statTotalItems">0</strong></li>
            <li>√çtems sin URL de imagen: <strong id="statNoImageUrl">0</strong></li>
            <li>√çtems sin UPC: <strong id="statNoUpc">0</strong></li>
            <li>√çtems sin Descripci√≥n: <strong id="statNoDescription">0</strong></li>
            <li>√çtems sin Marca: <strong id="statNoBrand">0</strong></li>
        </ul>
        <p style="font-size:0.8em; margin-top:15px; text-align:center;">
            Utiliza la barra de b√∫squeda de arriba para encontrar √≠tems espec√≠ficos.
        </p>
      </div>

      <div style="margin-top:20px; text-align:center;">
        <button id="btnVolverAlPanelDesdeGestion" class="secondary">‚Ü©Ô∏è Volver al Panel de Inicio</button>
      </div>
    </div>

    <div id="dobleControlStep" class="section hidden">
      <h2>Paso 2: Cargar Lista de √çtems para Doble Control</h2>
      <p style="font-size:0.9em; color: #555;">
        Puede escanear el UPC del art√≠culo f√≠sico (si su Lista Maestra contiene UPCs) o ingresar el ID del √çtem.
        Solo se considerar√°n IDs de √çtem **num√©ricos de m√°s de 5 d√≠gitos**.
      </p>
      <div class="input-group">
        <label for="verifyTextarea">Pegar IDs de √çtem a verificar (uno por l√≠nea o separados por espacio/tabulador):</label>
        <textarea id="verifyTextarea" rows="5" inputmode="numeric"></textarea>
      </div>
       <div class="input-group">
        <label>Subir archivo con IDs de √çtem a verificar:</label>
        <p style="font-size:0.85em; color:#666;">Se tomar√°n los IDs de √çtem de la columna especificada. Solo se considerar√°n IDs num√©ricos de m√°s de 5 d√≠gitos.</p>
        <div class="input-columns">
            <div><label for="verifyFileTxtCsv" style="font-size:0.9em;">Texto (.txt, .csv):</label><input type="file" id="verifyFileTxtCsv" accept=".txt,.csv"></div>
            <div><label for="verifyFileExcel" style="font-size:0.9em;">Excel (.xlsx, .xls):</label><input type="file" id="verifyFileExcel" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"></div>
        </div>
        <div class="file-options">
            <div class="input-columns">
                <div><label for="verifyCodigoCol">Col. ID √çtem (ej: 1):</label><input type="number" id="verifyCodigoCol" value="1" min="1"></div>
                 <div><label for="verifyCsvDelimiter">Delimitador CSV:</label><input type="text" id="verifyCsvDelimiter" value=","></div>
            </div>
             <label><input type="checkbox" id="verifyHasHeader" checked> El archivo tiene encabezados</label>
        </div>
      </div>
      <div class="input-group">
        <button id="startScanVerifyBtn">üì∑ Escanear UPC de Art√≠culo</button>
        <div id="scannerContainerVerify" class="hidden"><div id="readerVerify"></div></div>
        <label for="scannedCodesVerifyTextarea" style="margin-top:10px;">IDs de √çtem v√°lidos identificados (desde UPC escaneado o ingresado):</label>
        <textarea id="scannedCodesVerifyTextarea" rows="3" placeholder="Los IDs de √çtem v√°lidos aparecer√°n aqu√≠..." readonly></textarea>
      </div>
      <div id="verifyPreview" class="preview-area">A√∫n no se han cargado √çtems a verificar.</div>
      <hr style="margin: 20px 0;">
      <button id="btnVolverAlPanelDesdeDobleControl" class="secondary">&larr; Volver al Panel de Inicio</button>
      <button id="btnCompare">Verificar y Mostrar √çtems Concordantes &rarr;</button>
    </div>

    <div id="resultadosStep" class="section hidden">
      <h2>Resultados: √çtems Concordantes</h2>
      <div id="resultsSummary" class="results-summary">
        <p>Total √çtems en Lista Maestra: <strong id="totalFoco">0</strong></p>
        <p>Total √çtems en Lista de Verificaci√≥n (v√°lidos): <strong id="totalVerify">0</strong></p>
        <p>√çtems Concordantes Verificados: <strong id="totalMatches">0</strong></p>
      </div>
      <h3>Detalle de √çtems Concordantes (Clic para ver m√°s)</h3>
      <div style="margin-bottom: 15px;">
          <button id="layoutToggleResultsBtn">üìä Cambiar Vista</button>
          <button id="downloadPdfResultsBtn" class="secondary">üìÑ Descargar PDF</button>
          <button id="downloadCsvResultsBtn" class="secondary">üíæ Descargar CSV de Concordancias</button>
      </div>
      <div id="outputResults" class="list"><p>No se han encontrado coincidencias o no se ha realizado la verificaci√≥n.</p></div>
      <hr style="margin: 20px 0;">
      <button id="btnNewVerification">‚ú® Iniciar Nuevo Doble Control</button>
    </div>
  </div>

  <div id="itemDetailModal" class="hidden">
    <div class="modal-content">
      <span class="close-modal" onclick="closeItemDetailModal()">&times;</span>
      <h3 id="modalItemCodigo"></h3>
      <div id="modalItemImageContainer">
        <img id="modalItemImage" src="#" alt="Imagen del √çtem" style="display:none;">
        <p id="modalImageError" style="display:none; color:red;">Imagen no disponible.</p>
      </div>
      <p><strong>Descripci√≥n:</strong> <span id="modalItemDescripcion"></span></p>
      <p><strong>UPC:</strong> <span id="modalItemUPC"></span></p>
      <p><strong>Marca:</strong> <span id="modalItemBrand"></span></p>
      <p><strong>URL Imagen:</strong> <span id="modalItemUrl"></span></p>
    </div>
  </div>

  <footer>
    Sistema de Doble Control de √çtems v2.8.2 - Desarrollado por fgalaz - Chile, 2025
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ----- URL DE LA LISTA MAESTRA EN REPOSITORIO -----
    const URL_LISTA_MAESTRA_REPOSITORIO = 'https://raw.githubusercontent.com/Galaz94/Double_Control/main/maestra.csv';

    // ----- ESTADO DE LA APLICACI√ìN -----
    let listaFoco = new Map(); 
    let upcToCodigoMap = new Map();
    let listaVerificar = new Set(); 
    let coincidencias = new Map();
    const LOCAL_STORAGE_KEY_LISTA_FOCO = 'sDCI_listaFocoGuardada_v2.8.2'; // Bump versi√≥n para storage si la estructura cambia
    let listaFocoCacheadaLocalmente = new Map();

    // ----- SELECTORES DOM (incluyendo los nuevos spans para estad√≠sticas) -----
    const panelInicioDiv = document.getElementById('panelInicio');
    // ... (otros selectores de la v2.8.1 se mantienen)
    const modalItemImage = document.getElementById('modalItemImage');
    const modalImageError = document.getElementById('modalImageError');
    const modalItemUrl = document.getElementById('modalItemUrl');
    // Spans para estad√≠sticas
    const statTotalItems = document.getElementById('statTotalItems');
    const statNoImageUrl = document.getElementById('statNoImageUrl');
    const statNoUpc = document.getElementById('statNoUpc');
    const statNoDescription = document.getElementById('statNoDescription');
    const statNoBrand = document.getElementById('statNoBrand');
    // El resto de los selectores son iguales a v2.8.1
    const gestionMaestraStepDiv = document.getElementById('gestionMaestraStep');
    const dobleControlStepDiv = document.getElementById('dobleControlStep');
    const resultadosStepDiv = document.getElementById('resultadosStep');
    const confirmacionCambiosStepDiv = document.getElementById('confirmacionCambiosStep');
    const itemDetailModal = document.getElementById('itemDetailModal');
    const modalItemCodigo = document.getElementById('modalItemCodigo');
    const modalItemDescripcion = document.getElementById('modalItemDescripcion');
    const modalItemUPC = document.getElementById('modalItemUPC');
    const modalItemBrand = document.getElementById('modalItemBrand');
    const panelInicioInfo = document.getElementById('panelInicioInfo');
    const btnIniciarDobleControlDesdePanel = document.getElementById('btnIniciarDobleControlDesdePanel');
    const btnGestionMaestraDesdePanel = document.getElementById('btnGestionMaestraDesdePanel');
    const btnBorrarMaestraStorage = document.getElementById('btnBorrarMaestraStorage');
    const searchFocoInput = document.getElementById('searchFocoInput');
    const focoSearchResultsDiv = document.getElementById('focoSearchResults');
    const focoPreview = document.getElementById('focoPreview'); // Este div ahora contendr√° las estad√≠sticas
    const btnVolverAlPanelDesdeGestion = document.getElementById('btnVolverAlPanelDesdeGestion');
    const verifyTextarea = document.getElementById('verifyTextarea');
    const verifyFileTxtCsv = document.getElementById('verifyFileTxtCsv'), verifyFileExcel = document.getElementById('verifyFileExcel');
    const verifyCodigoColInput = document.getElementById('verifyCodigoCol'), verifyCsvDelimiterInput = document.getElementById('verifyCsvDelimiter');
    const verifyHasHeaderCheckbox = document.getElementById('verifyHasHeader');
    const verifyPreview = document.getElementById('verifyPreview');
    const startScanVerifyBtn = document.getElementById('startScanVerifyBtn');
    const scannerContainerVerify = document.getElementById('scannerContainerVerify');
    const readerVerifyDiv = document.getElementById('readerVerify'), scannedCodesVerifyTextarea = document.getElementById('scannedCodesVerifyTextarea');
    const btnVolverAlPanelDesdeDobleControl = document.getElementById('btnVolverAlPanelDesdeDobleControl');
    const btnCompare = document.getElementById('btnCompare');
    const totalFocoSpan = document.getElementById('totalFoco'), totalVerifySpan = document.getElementById('totalVerify'), totalMatchesSpan = document.getElementById('totalMatches');
    const outputResultsDiv = document.getElementById('outputResults');
    const layoutToggleResultsBtn = document.getElementById('layoutToggleResultsBtn');
    const downloadPdfResultsBtn = document.getElementById('downloadPdfResultsBtn'), downloadCsvResultsBtn = document.getElementById('downloadCsvResultsBtn');
    const btnNewVerification = document.getElementById('btnNewVerification');
    const resumenNuevosUl = document.querySelector('#resumenNuevos ul');
    const resumenEliminadosUl = document.querySelector('#resumenEliminados ul');
    const resumenModificadosUl = document.querySelector('#resumenModificados ul');
    const btnConfirmarCambiosRepositorio = document.getElementById('btnConfirmarCambiosRepositorio');
    const btnRechazarCambiosRepositorio = document.getElementById('btnRechazarCambiosRepositorio');


    let html5QrCodeVerifier = null;
    let scannerVerifierActive = false;

    // ----- INICIALIZACI√ìN -----
    document.addEventListener('DOMContentLoaded', () => {
      checkInitialState();
      navigateToView('panelInicio');
      itemDetailModal.addEventListener('click', function(event) {
        if (event.target === itemDetailModal) { closeItemDetailModal(); }
      });
      modalItemImage.onerror = function() {
          this.style.display = 'none';
          modalImageError.style.display = 'block';
          modalImageError.textContent = 'Error al cargar imagen o URL no v√°lida.';
      };
       modalItemImage.onload = function() {
          this.style.display = 'block';
          modalImageError.style.display = 'none';
      };
    });

    // ----- L√≥gica de Carga y Sincronizaci√≥n con Repositorio (sin cambios funcionales desde v2.8.1) -----
    function cleanText(text) { return text ? String(text).trim() : ''; }
    function parsearMaestraCSV(csvText) { /* ... igual que v2.8.1 ... */ const items = []; const lineas = csvText.trim().split(/\r\n|\n/); const cabeceraPresente = true; const indiceInicio = cabeceraPresente ? 1 : 0; for (let i = indiceInicio; i < lineas.length; i++) { const linea = lineas[i].trim(); if (!linea) continue; const partes = linea.split(','); if (partes.length >= 1 && partes[0]) { let itemData = { codigo: cleanText(partes[0]), upc: '', descripcion: '', brand: '', url: '' }; if (partes.length >= 2) itemData.upc = cleanText(partes[1]); if (partes.length >= 3) itemData.descripcion = cleanText(partes[2]); if (partes.length >= 4) itemData.brand = cleanText(partes[3]); if (partes.length >= 5) itemData.url = cleanText(partes[4]); items.push(itemData); } } return items;}
    function rebuildUpcToCodigoMap() { /* ... igual que v2.8.1 ... */ upcToCodigoMap.clear(); listaFoco.forEach(item => { if (item.upc && item.upc.trim() !== '') { upcToCodigoMap.set(item.upc.trim(), item.codigo); } }); }
    async function cargarMaestraDesdeRepositorio() { /* ... igual que v2.8.1 ... */ if (!URL_LISTA_MAESTRA_REPOSITORIO || URL_LISTA_MAESTRA_REPOSITORIO === 'PON_AQUI_LA_URL_RAW_DE_TU_MAESTRA.CSV_EN_REPOSITORIO') { console.warn('URL_LISTA_MAESTRA_REPOSITORIO no configurada.'); return null; } try { const response = await fetch(URL_LISTA_MAESTRA_REPOSITORIO + '?t=' + new Date().getTime()); if (!response.ok) { console.error('Error al cargar Maestra desde Repositorio:', response.status); return null; } const csvText = await response.text(); const itemsArray = parsearMaestraCSV(csvText); const nuevaListaMap = new Map(); itemsArray.forEach(item => { const idItemLimpio = cleanCode(item.codigo); if (idItemLimpio) { nuevaListaMap.set(idItemLimpio, { codigo: idItemLimpio, upc: item.upc, descripcion: item.descripcion, brand: item.brand, url: item.url }); } }); return nuevaListaMap; } catch (error) { console.error('Excepci√≥n al cargar Maestra desde Repositorio:', error); return null; } }
    function compararListas(listaLocalMap, listaRemotaMap) { /* ... igual que v2.8.1 ... */ const nuevos = [], eliminados = [], modificados = []; listaRemotaMap.forEach((itemRemoto, codigo) => { if (!listaLocalMap.has(codigo)) { nuevos.push(itemRemoto); } else { const itemLocal = listaLocalMap.get(codigo); let changedFields = {}; const localDesc = itemLocal.descripcion||'', remoteDesc = itemRemoto.descripcion||''; const localUpc = itemLocal.upc||'', remoteUpc = itemRemoto.upc||''; const localBrand = itemLocal.brand||'', remoteBrand = itemRemoto.brand||''; const localUrl = itemLocal.url||'', remoteUrl = itemRemoto.url||''; if (localDesc !== remoteDesc) changedFields.descripcion = { old: localDesc, new: remoteDesc}; if (localUpc !== remoteUpc) changedFields.upc = { old: localUpc, new: remoteUpc}; if (localBrand !== remoteBrand) changedFields.brand = { old: localBrand, new: remoteBrand}; if (localUrl !== remoteUrl) changedFields.url = { old: localUrl, new: remoteUrl}; if (Object.keys(changedFields).length > 0) { modificados.push({ ...itemRemoto, changedFields }); } } }); listaLocalMap.forEach((itemLocal, codigo) => { if (!listaRemotaMap.has(codigo)) { eliminados.push(itemLocal); } }); return { nuevos, eliminados, modificados }; }
    function mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraRepositorioMap) { /* ... igual que v2.8.1 ... */ const popularListaResumen = (ul, items, fmt) => { ul.innerHTML = items.length > 0 ? items.map(fmt).join('') : '<li>Ninguno</li>'; }; const itemFormatter = itm => `<li><span class="code">${itm.codigo}</span>: D:${itm.descripcion||'N/A'}, U:${itm.upc||'N/A'}, B:${itm.brand||'N/A'}, ImgURL:${itm.url||'N/A'}</span></li>`; popularListaResumen(resumenNuevosUl, nuevos, itemFormatter); popularListaResumen(resumenEliminadosUl, eliminados, itemFormatter); popularListaResumen(resumenModificadosUl, modificados, itm => { let chgs = ''; if(itm.changedFields.descripcion) chgs += `<span class="field-change">Desc: <s>${itm.changedFields.descripcion.old||'N/A'}</s> &rarr; ${itm.changedFields.descripcion.new||'N/A'}</span>`; if(itm.changedFields.upc) chgs += `<span class="field-change">UPC: <s>${itm.changedFields.upc.old||'N/A'}</s> &rarr; ${itm.changedFields.upc.new||'N/A'}</span>`; if(itm.changedFields.brand) chgs += `<span class="field-change">Brand: <s>${itm.changedFields.brand.old||'N/A'}</s> &rarr; ${itm.changedFields.brand.new||'N/A'}</span>`; if(itm.changedFields.url) chgs += `<span class="field-change">URL Img: <s>${itm.changedFields.url.old||'N/A'}</s> &rarr; ${itm.changedFields.url.new||'N/A'}</span>`; return `<li><span class="code">${itm.codigo}</span>${chgs}</li>`; }); btnConfirmarCambiosRepositorio.onclick = () => { listaFoco = new Map(maestraRepositorioMap); rebuildUpcToCodigoMap(); saveListaFocoToStorage(); updateFocoPreviewAndSearch(); panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems) desde el repositorio y guardada localmente.`; panelInicioInfo.className = 'panel-inicio-info'; navigateToView('panelInicio'); }; btnRechazarCambiosRepositorio.onclick = () => { rebuildUpcToCodigoMap(); updateFocoPreviewAndSearch(); panelInicioInfo.innerHTML = `‚ÑπÔ∏è Cambios del repositorio ignorados. Se mantiene la Maestra local (${listaFoco.size} √≠tems).`; panelInicioInfo.className = 'panel-inicio-info info'; navigateToView('panelInicio'); }; navigateToView('confirmacionCambiosStep'); }
    async function checkInitialState() { /* ... igual que v2.8.1 ... */ loadListaFocoFromStorage(false); listaFocoCacheadaLocalmente = new Map(listaFoco); panelInicioInfo.innerHTML = 'üîÑ Sincronizando Maestra TMR desde el repositorio...'; panelInicioInfo.className = 'panel-inicio-info info'; btnIniciarDobleControlDesdePanel.disabled = true; btnGestionMaestraDesdePanel.disabled = true; const maestraDesdeRepositorio = await cargarMaestraDesdeRepositorio(); btnIniciarDobleControlDesdePanel.disabled = false; btnGestionMaestraDesdePanel.disabled = false; if (maestraDesdeRepositorio) { const { nuevos, eliminados, modificados } = compararListas(listaFocoCacheadaLocalmente, maestraDesdeRepositorio); let localIsIdentical = true; if (listaFocoCacheadaLocalmente.size !== maestraDesdeRepositorio.size) { localIsIdentical = false; } else { for (const [key, remoteItem] of maestraDesdeRepositorio.entries()) { const localItem = listaFocoCacheadaLocalmente.get(key); if (!localItem || (localItem.descripcion || '') !== (remoteItem.descripcion || '') || (localItem.upc || '') !== (remoteItem.upc || '') || (localItem.brand || '') !== (remoteItem.brand || '') || (localItem.url || '') !== (remoteItem.url || '') ) { localIsIdentical = false; break; } } } if (nuevos.length === 0 && eliminados.length === 0 && modificados.length === 0 && localIsIdentical) { panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems).`; } else if (nuevos.length === 0 && eliminados.length === 0 && modificados.length === 0 && !localIsIdentical) { listaFoco = new Map(maestraDesdeRepositorio); rebuildUpcToCodigoMap(); saveListaFocoToStorage(false); panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems) con cambios menores y guardada.`; } else { panelInicioInfo.innerHTML = `‚ÑπÔ∏è Se detectaron cambios en la Maestra TMR del repositorio. Revisa y confirma.`; panelInicioInfo.className = 'panel-inicio-info warning'; mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraDesdeRepositorio); return; } panelInicioInfo.className = 'panel-inicio-info'; updateFocoPreviewAndSearch(); navigateToView('panelInicio'); } else { if (listaFoco.size > 0) { panelInicioInfo.innerHTML = `‚ö†Ô∏è Error al cargar desde el repositorio. Usando Maestra local (${listaFoco.size} √≠tems).`; panelInicioInfo.className = 'panel-inicio-info warning'; } else { panelInicioInfo.innerHTML = `‚ùå Error al cargar desde el repositorio y no hay Maestra local.`; panelInicioInfo.className = 'panel-inicio-info error'; btnIniciarDobleControlDesdePanel.disabled = true; btnGestionMaestraDesdePanel.disabled = true; } updateFocoPreviewAndSearch(); navigateToView('panelInicio'); } }
    
    // ----- NAVEGACI√ìN DE VISTAS -----
    function navigateToView(viewName) { [panelInicioDiv, gestionMaestraStepDiv, dobleControlStepDiv, resultadosStepDiv, confirmacionCambiosStepDiv, itemDetailModal].forEach(div => div.classList.add('hidden')); if (viewName !== 'itemDetailModal') itemDetailModal.style.display = 'none'; if (viewName === 'panelInicio') panelInicioDiv.classList.remove('hidden'); else if (viewName === 'gestionMaestraStep') { gestionMaestraStepDiv.classList.remove('hidden'); updateFocoPreviewAndSearch(); } else if (viewName === 'dobleControlStep') dobleControlStepDiv.classList.remove('hidden'); else if (viewName === 'resultadosStep') resultadosStepDiv.classList.remove('hidden'); else if (viewName === 'confirmacionCambiosStep') confirmacionCambiosStepDiv.classList.remove('hidden');}
    
    // ----- UTILIDADES -----
    function cleanCode(code) { if (typeof code !== 'string' && typeof code !== 'number') return ''; return String(code).trim().replace(/[^a-zA-Z0-9\-]+/g, '').toUpperCase(); }
    function resetFileInput(el) { if(el) el.value = null; }
    function getDelimiterRegex(d) { if (d.toLowerCase()==='<tab>') return /\t/; return new RegExp(d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));}

    // ----- GESTI√ìN LISTA MAESTRA (B√öSQUEDA Y ESTAD√çSTICAS) -----
    function updateFocoPreviewAndSearch(itemsToShow = null) { // itemsToShow es para los resultados de b√∫squeda
        // Calcular y mostrar estad√≠sticas
        let countNoUrl = 0;
        let countNoUpc = 0;
        let countNoDescription = 0;
        let countNoBrand = 0;

        listaFoco.forEach(item => {
            if (!item.url || item.url.trim() === '') countNoUrl++;
            if (!item.upc || item.upc.trim() === '') countNoUpc++;
            if (!item.descripcion || item.descripcion.trim() === '') countNoDescription++;
            if (!item.brand || item.brand.trim() === '') countNoBrand++;
        });

        statTotalItems.textContent = listaFoco.size;
        statNoImageUrl.textContent = countNoUrl;
        statNoUpc.textContent = countNoUpc;
        statNoDescription.textContent = countNoDescription;
        statNoBrand.textContent = countNoBrand;

        // L√≥gica para mostrar resultados de b√∫squeda (itemsToShow)
        const searchTerm = searchFocoInput.value.toLowerCase().trim();
        if (itemsToShow) { // Si se pasaron items (resultado de una b√∫squeda)
            focoSearchResultsDiv.innerHTML = ''; // Limpiar resultados anteriores
             if (itemsToShow.length > 0) {
                itemsToShow.slice(0, 30).forEach(item => { // Mostrar hasta 30 resultados de b√∫squeda
                    const p = document.createElement('div'); p.className = 'search-result-item';
                    p.innerHTML = `<span class="code">${item.codigo}</span> <span class="upc-brand-url">(UPC: ${item.upc||'N/A'}, M: ${item.brand||'N/A'}, Img: ${item.url ? 'S√≠':'No'})</span> <span class="desc">${item.descripcion||'(S/D)'}</span>`;
                    p.addEventListener('click', () => openItemDetailModal(item.codigo));
                    focoSearchResultsDiv.appendChild(p);
                });
                if (itemsToShow.length > 30) {
                    focoSearchResultsDiv.innerHTML += `<p style="text-align:center; font-style:italic;">... y ${itemsToShow.length - 30} m√°s. Refine su b√∫squeda.</p>`;
                }
            } else if (searchTerm !== '') { 
                focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">No se encontraron √≠tems que coincidan con la b√∫squeda.</p>'; 
            } else { 
                focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">Ingrese un t√©rmino para buscar en la Lista Maestra...</p>'; 
            }
        } else if (searchTerm === '' && !itemsToShow) { // Si no hay t√©rmino de b√∫squeda y no se pasaron items expl√≠citamente
             focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">Ingrese un t√©rmino para buscar en la Lista Maestra...</p>';
        }
        // Si itemsToShow es null pero hay un searchTerm, la b√∫squeda se realiza en el event listener de searchFocoInput.
    }

    function saveListaFocoToStorage(showAlert = true) { /* ... igual que v2.8.1 ... */ if (listaFoco.size === 0 && showAlert && !confirm("La Maestra est√° vac√≠a. ¬øGuardar vac√≠a?")) return false; try { localStorage.setItem(LOCAL_STORAGE_KEY_LISTA_FOCO, JSON.stringify(Array.from(listaFoco.values()))); if (showAlert) alert(`Maestra con ${listaFoco.size} √≠tems guardada localmente.`); return true; } catch (e) { if (showAlert) alert("Error al guardar Maestra local: " + e.message); return false; } }
    function loadListaFocoFromStorage(showAlerts = true) { /* ... igual que v2.8.1 ... */ const data = localStorage.getItem(LOCAL_STORAGE_KEY_LISTA_FOCO); listaFoco.clear(); if (data) { try { const itemsArray = JSON.parse(data); itemsArray.forEach(item => { const idItemLimpio = cleanCode(item.codigo); if (idItemLimpio) { listaFoco.set(idItemLimpio, { codigo: idItemLimpio, upc: item.upc||'', descripcion: item.descripcion||'', brand: item.brand||'', url: item.url||'' }); } }); if (showAlerts) alert(`Maestra local con ${listaFoco.size} √≠tems cargada.`); } catch (e) { if (showAlerts) alert("Error al cargar Maestra local: datos corruptos. Se borrar√°."); localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO); listaFoco.clear(); } } else { if (showAlerts) alert("No hay Maestra guardada localmente."); } rebuildUpcToCodigoMap(); }
    
    searchFocoInput.addEventListener('input', () => {
        const searchTerm = searchFocoInput.value.toLowerCase().trim();
        if (!searchTerm) {
            focoSearchResultsDiv.innerHTML = '<p style="text-align:center;">Ingrese un t√©rmino para buscar en la Lista Maestra...</p>';
            // No llamamos a updateFocoPreviewAndSearch sin argumentos aqu√≠, 
            // ya que las estad√≠sticas se actualizan cuando cambia listaFoco o al entrar a la vista.
            return;
        }
        const results = Array.from(listaFoco.values()).filter(item =>
            item.codigo.toLowerCase().includes(searchTerm) ||
            (item.upc && item.upc.toLowerCase().includes(searchTerm)) ||
            (item.descripcion && item.descripcion.toLowerCase().includes(searchTerm)) ||
            (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
            (item.url && item.url.toLowerCase().includes(searchTerm))
        );
        updateFocoPreviewAndSearch(results); // Pasamos los resultados para que se muestren
    });
    btnVolverAlPanelDesdeGestion.addEventListener('click', () => navigateToView('panelInicio'));

    // ----- LECTURA DE ARCHIVOS (VERIFICACI√ìN) Y MANEJO LISTA A VERIFICAR (sin cambios funcionales desde v2.8.1) -----
    function addValidCodeToVerifyList(idItem) { /* ... igual que v2.8.1 ... */ const trimmedIdItem = String(idItem).trim(); if (/^[0-9]+$/.test(trimmedIdItem) && trimmedIdItem.length > 5) { if (!listaVerificar.has(trimmedIdItem)) { listaVerificar.add(trimmedIdItem); return trimmedIdItem; } return null; } return false; }
    function handleFileUpload(file, isExcel) { /* ... igual que v2.8.1 ... */ if (!file) return; verifyPreview.innerHTML = `Procesando "${file.name}"...`; const idItemCol = parseInt(verifyCodigoColInput.value) - 1; const delimiter = verifyCsvDelimiterInput.value; const hasHeader = verifyHasHeaderCheckbox.checked; const targetFileElement = isExcel ? verifyFileExcel : verifyFileTxtCsv; if (idItemCol < 0) { alert("Col. ID √çtem debe ser >= 1."); verifyPreview.textContent = "Error."; resetFileInput(targetFileElement); return; } const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; let itemsFromFile = []; try { if (isExcel) itemsFromFile = processExcelDataForVerify(content, idItemCol, hasHeader); else itemsFromFile = processTextCsvDataForVerify(content, idItemCol, hasHeader, delimiter); listaVerificar.clear(); scannedCodesVerifyTextarea.value = ''; let addedCount = 0, omittedCount = 0; itemsFromFile.forEach(idItemFromFile => { const result = addValidCodeToVerifyList(idItemFromFile); if (result !== false && result !== null) { addedCount++; } else if (result === false) { omittedCount++; } }); if (omittedCount > 0) alert(`${omittedCount} ID(s) de √çtem del archivo fueron omitidos (no num√©ricos > 5 d√≠gitos).`); updateVerifyPreview(); } catch (error) { alert(`Error procesando ${file.name}: ${error.message}`); verifyPreview.textContent = `Error.`; } resetFileInput(targetFileElement); }; reader.onerror = () => { alert(`No se pudo leer ${file.name}.`); verifyPreview.textContent = `Error.`; resetFileInput(targetFileElement); }; if (isExcel) reader.readAsArrayBuffer(file); else reader.readAsText(file); }
    function processTextCsvDataForVerify(content, colIdx, hasHeader, delimiter = ',') { /* ... igual que v2.8.1 ... */ const lines = content.split(/\r\n|\n/); const dataRows = hasHeader ? lines.slice(1) : lines; const items = []; const delimRegex = getDelimiterRegex(delimiter); dataRows.forEach(line => { if (line.trim() === '') return; const parts = line.split(delimRegex); const val = parts[colIdx] ? String(parts[colIdx]).trim() : null; if (val) items.push(val); }); return items; }
    function processExcelDataForVerify(arrayBuffer, colIdx, hasHeader) { /* ... igual que v2.8.1 ... */ const items = []; const data = new Uint8Array(arrayBuffer); const workbook = XLSX.read(data, {type:"array"}); const firstSheetName = workbook.SheetNames[0]; if (!firstSheetName) throw new Error("Excel sin hojas."); const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: true, defval:null }); const dataRows = hasHeader ? jsonData.slice(1) : jsonData; dataRows.forEach(row => { if (!row) return; const val = (row[colIdx] !== null && row[colIdx] !== undefined) ? String(row[colIdx]).trim() : null; if (val) items.push(val); }); return items; }
    verifyFileTxtCsv.addEventListener('change', (e) => handleFileUpload(e.target.files[0], false));
    verifyFileExcel.addEventListener('change', (e) => handleFileUpload(e.target.files[0], true));
    function updateVerifyPreview() { /* ... igual que v2.8.1 ... */ verifyPreview.textContent = `Lista de IDs de √çtem V√°lidos a Verificar: ${listaVerificar.size}. ${listaVerificar.size > 0 ? `Primeros: ${[...listaVerificar].slice(0,5).join(', ')}${listaVerificar.size > 5 ? '...' : ''}` : 'Vac√≠a.'}`; }
    function collectVerifyDataFromInputs() { /* ... igual que v2.8.1 ... */ const textVerifyItems = verifyTextarea.value.trim(); if (textVerifyItems) { textVerifyItems.split(/\s+/).forEach(idItemFromText => { addValidCodeToVerifyList(idItemFromText); }); } updateVerifyPreview(); }
    btnVolverAlPanelDesdeDobleControl.addEventListener('click', () => navigateToView('panelInicio'));
    btnCompare.addEventListener('click', () => { /* ... igual que v2.8.1 ... */ collectVerifyDataFromInputs(); if (listaVerificar.size === 0) { alert("Cargue o escanee √çtems v√°lidos para la Lista de Verificaci√≥n."); return; } if (listaFoco.size === 0) { alert("La Lista Maestra est√° vac√≠a. Sincronice con el repositorio."); navigateToView('panelInicio'); return; } compareListsAndDisplayResults(); navigateToView('resultadosStep'); });
    function onScanSuccessVerify(decodedText, decodedResult){ /* ... igual que v2.8.1 ... */ const scannedUPC = cleanText(decodedText); if (scannedUPC) { if (upcToCodigoMap.size === 0 && listaFoco.size > 0) { alert("Advertencia: Su Lista Maestra no parece tener UPCs mapeados. El escaneo de UPC no encontrar√° √çtems."); } const idItem = upcToCodigoMap.get(scannedUPC); if (idItem) { const addedIdItem = addValidCodeToVerifyList(idItem); if (addedIdItem) { const currentScannedText = scannedCodesVerifyTextarea.value.trim(); scannedCodesVerifyTextarea.value = currentScannedText ? `${currentScannedText}\n${addedIdItem} (UPC: ${scannedUPC})` : `${addedIdItem} (UPC: ${scannedUPC})`; updateVerifyPreview(); } else if (addedIdItem === null) { alert(`El √çtem ${idItem} (UPC: ${scannedUPC}) ya est√° en la lista de verificaci√≥n.`); } else { alert(`El ID de √çtem (${idItem}) asociado al UPC (${scannedUPC}) no cumple el formato (n√∫mero > 5 d√≠gitos) y ser√° omitido.`); } } else { alert(`UPC escaneado (${scannedUPC}) no encontrado en la Lista Maestra o no tiene ID de √çtem asociado.`); } } }
    startScanVerifyBtn.addEventListener('click', () => { /* ... igual que v2.8.1 ... */ if(scannerVerifierActive){if(html5QrCodeVerifier&&html5QrCodeVerifier.isScanning){html5QrCodeVerifier.stop().then(()=>{scannerVerifierActive=false;scannerContainerVerify.classList.add('hidden');startScanVerifyBtn.textContent='üì∑ Escanear UPC de Art√≠culo';}).catch(err=>console.error("Error deteniendo esc√°ner:",err));}else{scannerVerifierActive=false;scannerContainerVerify.classList.add('hidden');startScanVerifyBtn.textContent='üì∑ Escanear UPC de Art√≠culo';}}else{if(location.protocol !=='https:'&&!['localhost','127.0.0.1'].includes(location.hostname)){alert('El esc√°ner requiere HTTPS o localhost.');return;}scannerContainerVerify.classList.remove('hidden');startScanVerifyBtn.textContent='üõë Detener Esc√°ner';if(!html5QrCodeVerifier)html5QrCodeVerifier=new Html5Qrcode("readerVerify",{verbose:false});const config={fps:10,qrbox:{width:250,height:100},rememberLastUsedCamera:true,supportedScanTypes:[Html5QrcodeScanType.SCAN_TYPE_CAMERA]};html5QrCodeVerifier.start({facingMode:"environment"},config,onScanSuccessVerify,(error)=>{/*ignorar*/}).then(()=>scannerVerifierActive=true).catch(err=>{alert(`Error al iniciar esc√°ner: ${err.message||err}`);scannerContainerVerify.classList.add('hidden');startScanVerifyBtn.textContent='üì∑ Escanear UPC de Art√≠culo';scannerVerifierActive=false;});}});

    // ----- COMPARACI√ìN Y RESULTADOS (openItemDetailModal es de v2.8.1) -----
    function compareListsAndDisplayResults(){ /* ... igual que v2.8.1 ... */ coincidencias.clear(); listaVerificar.forEach(idItemToVerify => { if(listaFoco.has(idItemToVerify)) { coincidencias.set(idItemToVerify, listaFoco.get(idItemToVerify)); } }); displayFinalResults(); }
    function displayFinalResults(){ /* ... igual que v2.8.1 ... */ totalFocoSpan.textContent=listaFoco.size; totalVerifySpan.textContent=listaVerificar.size; totalMatchesSpan.textContent=coincidencias.size; outputResultsDiv.innerHTML=''; outputResultsDiv.className='list'; if(coincidencias.size===0){ outputResultsDiv.innerHTML='<p>No se encontraron √çtems concordantes.</p>'; }else{ coincidencias.forEach(item => { const cD = document.createElement("div"); cD.className="barcode-item-container"; cD.setAttribute('data-iditem', item.codigo); cD.addEventListener('click', () => openItemDetailModal(item.codigo)); const cP = document.createElement("p"); cP.className="barcode-item-code"; cP.textContent = item.codigo; cD.appendChild(cP); if(item.descripcion){ const dP=document.createElement("p"); dP.className="barcode-item-desc"; dP.textContent = item.descripcion; cD.appendChild(dP); } const upcBrandP = document.createElement("p"); upcBrandP.style.fontSize = "0.8em"; upcBrandP.style.textAlign = "center"; upcBrandP.textContent = `UPC: ${item.upc||'N/A'} | Marca: ${item.brand||'N/A'} | Img: ${item.url ? 'S√≠' : 'No'}`; cD.appendChild(upcBrandP); const sD = document.createElement("div"); sD.className="barcode-item-svg"; const svg = document.createElementNS("http://www.w3.org/2000/svg","svg"); try{ JsBarcode(svg, item.codigo, {format:"CODE128",width:2,height:50,displayValue:false,margin:5}); sD.appendChild(svg); } catch(e) { sD.innerHTML=`<p style="color:red;font-size:0.8em;">Error BC</p>`; } cD.appendChild(sD); outputResultsDiv.appendChild(cD); }); } }
    function openItemDetailModal(idItem) { /* ... igual que v2.8.1 ... */ const item = listaFoco.get(idItem) || coincidencias.get(idItem); if (item) { modalItemCodigo.textContent = "ID √çtem: " + item.codigo; modalItemDescripcion.textContent = item.descripcion || 'No disponible'; modalItemUPC.textContent = item.upc || 'No disponible'; modalItemBrand.textContent = item.brand || 'No disponible'; const imageUrl = item.url ? item.url.trim() : ''; if (imageUrl) { modalItemImage.src = imageUrl; modalItemImage.alt = "Imagen de " + (item.descripcion || item.codigo); } else { modalItemImage.style.display = 'none'; modalItemImage.src = '#'; modalImageError.textContent = 'URL de imagen no especificada.'; modalImageError.style.display = 'block'; } itemDetailModal.classList.remove('hidden'); itemDetailModal.style.display = 'flex'; } }
    function closeItemDetailModal() { /* ... igual que v2.8.1 ... */ itemDetailModal.classList.add('hidden'); itemDetailModal.style.display = 'none'; modalItemImage.src="#"; modalItemImage.style.display = 'none'; modalImageError.style.display = 'none'; }
    layoutToggleResultsBtn.addEventListener('click',()=>{ /* ... igual que v2.8.1 ... */ outputResultsDiv.classList.toggle('grid');outputResultsDiv.classList.toggle('list');});
    downloadCsvResultsBtn.addEventListener('click',()=>{ /* ... igual que v2.8.1 ... */ if(coincidencias.size===0){alert("No hay √çtems concordantes.");return;} let cC="ID_Item,UPC,Descripcion,Marca,URL_Imagen\n"; coincidencias.forEach(item=>{ const desc = `"${(item.descripcion||'').replace(/"/g,'""')}"`; const upcVal = `"${(item.upc||'').replace(/"/g,'""')}"`; const brandVal = `"${(item.brand||'').replace(/"/g,'""')}"`; const urlVal = `"${(item.url||'').replace(/"/g,'""')}"`; cC+=`${item.codigo},${upcVal},${desc},${brandVal},${urlVal}\n`; }); const b=new Blob([cC],{type:'text/csv;charset=utf-8;'}); const l=document.createElement("a");const u=URL.createObjectURL(b); l.setAttribute("href",u); l.setAttribute("download",`concordancias_v2.8.2_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(u);});
    downloadPdfResultsBtn.addEventListener('click',async()=>{ /* ... igual que v2.8.1 ... */ if(coincidencias.size===0){alert("No hay √çtems concordantes para PDF.");return;} downloadPdfResultsBtn.textContent='Generando PDF...'; downloadPdfResultsBtn.disabled=true; const pC=document.createElement("div");pC.style.display="grid";pC.style.gridTemplateColumns="repeat(3, 1fr)";pC.style.gap="10px";pC.style.padding="10mm"; outputResultsDiv.querySelectorAll(".barcode-item-container").forEach(iEl=>{ const idItem = iEl.getAttribute('data-iditem'); const itemData = coincidencias.get(idItem); const cI=document.createElement('div'); cI.style.border="1px solid #ccc"; cI.style.padding="5px"; cI.style.pageBreakInside="avoid";cI.style.textAlign="center"; const codeP = document.createElement('p'); codeP.textContent = `ID √çtem: ${itemData.codigo}`; codeP.style.fontWeight="bold"; const descP = document.createElement('p'); descP.textContent = `Desc: ${itemData.descripcion || 'N/A'}`; const upcP = document.createElement('p'); upcP.textContent = `UPC: ${itemData.upc || 'N/A'}`; const brandP = document.createElement('p'); brandP.textContent = `Marca: ${itemData.brand || 'N/A'}`; const urlP = document.createElement('p'); urlP.textContent = `ImgURL: ${itemData.url || 'N/A'}`; cI.appendChild(codeP); cI.appendChild(descP); cI.appendChild(upcP); cI.appendChild(brandP); cI.appendChild(urlP); const svgOriginal = iEl.querySelector(".barcode-item-svg svg"); if (svgOriginal) { const svgClone = svgOriginal.cloneNode(true); const sD = document.createElement("div"); sD.style.marginTop="5px"; sD.appendChild(svgClone); cI.appendChild(sD); } pC.appendChild(cI); }); if(pC.children.length===0){alert("No hay elementos v√°lidos para PDF.");downloadPdfResultsBtn.textContent='üìÑ Descargar PDF';downloadPdfResultsBtn.disabled=false;return;} const opt={margin:10,filename:`concordancias_v2.8.2_${new Date().toISOString().slice(0,10)}.pdf`,image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},pagebreak:{mode:['avoid-all','css','legacy']}}; try{await html2pdf().from(pC).set(opt).save();}catch(error){console.error("Error PDF:", error); alert("Error al generar PDF.");} finally{downloadPdfResultsBtn.textContent='üìÑ Descargar PDF';downloadPdfResultsBtn.disabled=false;} });

    // ----- BOTONES PANEL INICIO (sin cambios funcionales desde v2.8.1) -----
    btnIniciarDobleControlDesdePanel.addEventListener('click', () => { if (listaFoco.size === 0) { alert("No hay Lista Maestra cargada. Sincronice con el repositorio."); return; } listaVerificar.clear(); verifyTextarea.value = ''; scannedCodesVerifyTextarea.value = ''; verifyFileTxtCsv.value = null; verifyFileExcel.value = null; updateVerifyPreview(); navigateToView('dobleControlStep'); });
    btnGestionMaestraDesdePanel.addEventListener('click', () => navigateToView('gestionMaestraStep'));
    btnBorrarMaestraStorage.addEventListener('click', () => { if (confirm("¬øSeguro que desea borrar la Maestra guardada localmente? \nSe intentar√° resincronizar con el repositorio.")) { localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO); listaFoco.clear(); listaFocoCacheadaLocalmente.clear(); upcToCodigoMap.clear(); alert("Maestra local borrada. Se resincronizar√° con el repositorio."); checkInitialState(); } });

    // ----- NUEVA VERIFICACI√ìN (sin cambios funcionales desde v2.8.1) -----
    btnNewVerification.addEventListener('click', () => { listaVerificar.clear(); coincidencias.clear(); verifyTextarea.value = ''; scannedCodesVerifyTextarea.value = ''; verifyFileTxtCsv.value = null; verifyFileExcel.value = null; updateVerifyPreview(); outputResultsDiv.innerHTML = '<p>No se han encontrado coincidencias o no se ha realizado la verificaci√≥n.</p>'; totalVerifySpan.textContent = '0'; totalMatchesSpan.textContent = '0'; if(scannerVerifierActive && html5QrCodeVerifier && html5QrCodeVerifier.isScanning) { html5QrCodeVerifier.stop().catch(err => console.error("Error deteniendo esc√°ner:", err)); scannerVerifierActive = false; scannerContainerVerify.classList.add('hidden'); startScanVerifyBtn.textContent = 'üì∑ Escanear UPC de Art√≠culo'; } navigateToView('panelInicio'); });

  </script>
</body>
</html>
