<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Doble Control de Ítems v3.0.3 (Modal & Stats Refined)</title>
  <style>
    /* Estilos CSS Generales (de la v2.8.8 y mejoras) */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 15px;
      background-color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h1, h2, h3 {
      color: #2c3e50;
      text-align: center;
    }
    h1 { margin-bottom: 30px; font-size: 1.8em;}
    h2 { margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.5em;}
    h3 { margin-bottom: 15px; font-size: 1.2em; text-align: left;}

    .section {
      border: 1px solid #e0e0e0;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      background-color: #fdfdfd;
    }
    .hidden { display: none !important; }
    .panel-inicio-info {
        font-size: 1.1em;
        color: #27ae60;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #e8f8f0;
        border-left: 5px solid #27ae60;
        border-radius: 4px;
    }
    .panel-inicio-info.warning { color: #f39c12; background-color: #fef9e7; border-left-color: #f39c12;}
    .panel-inicio-info.error { color: #c0392b; background-color: #fdedec; border-left-color: #c0392b;}
    .panel-inicio-info.info { color: #2980b9; background-color: #eaf2f8; border-left-color: #2980b9;}
    .panel-inicio-actions button { margin-top: 10px; width: 100%; box-sizing: border-box; padding: 12px;}

    .input-group { margin-bottom: 20px; }
    .input-group label, .file-options label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 0.95em;
    }
    textarea, input[type="file"], select, input[type="text"], input[type="search"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    textarea { min-height: 100px; }
    .file-options { border: 1px solid #ddd; padding: 15px; margin-top: -10px; margin-bottom:15px; border-radius: 0 0 4px 4px; background-color: #f9f9f9;}
    .input-columns { display: flex; gap: 15px; align-items: flex-end; }
    .input-columns > div { flex: 1; }
    .input-columns input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle;}

    button {
      background-color: #3498db;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      margin-right: 8px;
      margin-top: 5px;
    }
    button:hover { background-color: #2980b9; }
    button.secondary { background-color: #95a5a6; }
    button.secondary:hover { background-color: #7f8c8d; }
    button.danger { background-color: #e74c3c; }
    button.danger:hover { background-color: #c0392b; }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

    .preview-area, .search-results-area {
      background-color: #ecf0f1;
      border: 1px dashed #bdc3c7;
      padding: 12px;
      min-height: 60px;
      margin-top:10px;
      font-size: 0.9em;
      border-radius: 4px;
      word-break: break-word;
    }
    #focoPreview ul { list-style-type: none; padding-left: 0; }
    #focoPreview li { margin-bottom: 5px; font-size: 0.95em; }
    #focoPreview strong { color: #34495e; }

    .search-results-area { max-height: 200px; overflow-y: auto; }
    .preview-item, .search-result-item {
        padding: 6px 3px;
        border-bottom: 1px solid #dde;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    .preview-item:last-child, .search-result-item:last-child { border-bottom: none; }
    .preview-item .code, .search-result-item .code { font-weight: bold; color: #34495e; flex-shrink: 0; margin-right: 10px;}
    .preview-item .desc, .search-result-item .desc { color: #7f8c8d; margin-left: 10px; font-style: italic; text-align: right; flex-grow: 1; }
    .preview-item .upc-brand-url { font-size: 0.85em; color: #555; margin-left: 10px; }

    .results-summary {
      margin-bottom: 25px;
      background-color: #eaf5ff;
      padding: 18px;
      border-radius: 6px;
      border: 1px solid #c1d9ed;
    }
    .results-summary p { margin: 8px 0; font-size: 1.05em; }
    .results-summary strong { color: #2980b9; }

    #confirmacionCambiosStep .preview-area { max-height: 120px; margin-bottom: 10px; background-color: #fff; overflow-y: auto;}
    #confirmacionCambiosStep h3 { font-size: 1.1em; margin-bottom:5px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    #confirmacionCambiosStep li { font-size: 0.9em; padding: 3px 0; border-bottom: 1px dotted #eee; }
    #confirmacionCambiosStep li:last-child { border-bottom: none; }
    #confirmacionCambiosStep li s { color: #e74c3c; }
    #confirmacionCambiosStep li .field-change { display: block; margin-left: 15px; font-size: 0.9em;}

    #outputResults.list .barcode-item-container { margin: 10px 0; background: #fff; padding:12px; border:1px solid #e0e0e0; border-radius:5px; cursor: pointer;}
    #outputResults.grid .barcode-item-container { background: #fff; padding:12px; border:1px solid #e0e0e0; border-radius:5px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; cursor: pointer;}
    #outputResults.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }

    .barcode-item-code { font-weight: bold; text-align: center; margin-bottom: 4px; font-size: 1em; color: #333; }
    .barcode-item-desc { text-align: center; margin-bottom: 6px; font-size: 0.9em; color: #555; font-style: italic; }
    .barcode-item-svg svg { max-width: 100%; height: auto; display: block; margin: 0 auto;}

    /* Modal de Detalles del Ítem */
    #itemDetailModal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
      align-items: center; /* Center vertically */
      justify-content: center; /* Center horizontally */
    }

    #itemDetailModal .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 25px;
      border: 1px solid #888;
      width: 90%; /* Could be more or less, depending on screen size */
      max-width: 600px; /* Max width for larger screens */
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative; /* Needed for close button positioning */
      text-align: center;
    }

    #itemDetailModal .modal-content h3 {
      margin-top: 0;
      color: #3498db;
      text-align: center;
      margin-bottom: 15px;
    }

    #itemDetailModal .modal-content p {
      margin: 8px 0;
      font-size: 1.1em;
      text-align: left;
    }

    #itemDetailModal .modal-content strong {
      color: #555;
    }

    #itemDetailModal #modalItemImageContainer {
      margin-top: 15px;
      margin-bottom: 15px;
      min-height: 50px; /* Reserve space */
      text-align: center;
    }

    #itemDetailModal #modalItemImage {
      max-width: 100%;
      max-height: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
      object-fit: contain; /* Ensures image fits without cropping */
    }

    #itemDetailModal #modalImageError {
      color: red;
      font-size: 0.9em;
      margin-top: 5px;
      display: none; /* Hidden by default */
    }

    #itemDetailModal .close-modal {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    #itemDetailModal .close-modal:hover,
    #itemDetailModal .close-modal:focus {
      color: black;
      text-decoration: none;
    }

    #modalItemBarcodeSvg {
        margin-top: 15px;
        margin-bottom: 10px;
        text-align: center;
    }
    #modalItemBarcodeSvg svg {
        max-width: 80%;
        height: auto;
        display: inline-block; /* To center it */
    }


    #scannerContainerVerify { max-width: 400px; margin: 15px auto; border: 1px solid #ccc; padding: 5px; border-radius: 4px;}
    #readerVerify { width: 100%; }

    footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      font-size: 0.9em;
      color: #777;
      border-top: 1px solid #eee;
    }

    /* Estilos para Toasts/Snackbars */
    #toast-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050; /* Higher than modal */
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 400px;
        pointer-events: none; /* Allows clicks through to elements below */
    }

    .toast {
        background-color: #333;
        color: #fff;
        padding: 12px 20px;
        border-radius: 5px;
        margin-bottom: 10px;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(20px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        width: fit-content;
        text-align: center;
        pointer-events: auto; /* Re-enable pointer events for the toast itself */
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast.success { background-color: #28a745; }
    .toast.error { background-color: #dc3545; }
    .toast.warning { background-color: #ffc107; color: #333;}
    .toast.info { background-color: #17a2b8; }


    /* Estilos para @media print */
    @media print {
      body {
        margin: 0;
        padding: 0;
        background: #fff !important;
      }
      .container {
        box-shadow: none !important;
        background: #fff !important;
        margin: 0 !important;
        padding: 0.5in !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      .barcode-item-container, h4, .section, .results-summary {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      h4 {
        page-break-before: auto !important;
        page-break-after: avoid !important;
      }
      @page {
        size: letter;
        margin: 0.5in;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sistema de Doble Control de Ítems v3.0.3 (Modal & Stats Refined)</h1>

    <div id="panelInicio" class="section">
      <h2>Panel de Inicio</h2>
      <div id="panelInicioInfo" class="panel-inicio-info info">
        Cargando información de Lista Maestra desde el repositorio...
      </div>
      <div class="panel-inicio-actions">
        <button id="btnIniciarDobleControlDesdePanel" disabled>➡️ Iniciar Doble Control</button>
        <button id="btnGestionMaestraDesdePanel" class="secondary" disabled>🔎 Ver Lista Maestra y Buscar</button>
        <button id="btnBorrarMaestraStorage" class="danger secondary" style="margin-top: 20px;">🗑️ Borrar Maestra Local y Resincronizar</button>
      </div>

      <div class="input-group" style="margin-top:30px; border-top: 1px solid #eee; padding-top: 20px;">
        <h3>Cargar Maestra Local (Offline)</h3>
        <p style="font-size:0.9em; color:#555;">
          Si necesitas trabajar sin conexión o prefieres una maestra local, sube tu archivo `.xlsx` aquí.
          Este archivo reemplazará cualquier maestra cargada desde el repositorio o previamente guardada.
        </p>
        <label for="masterFileExcelUpload">Seleccionar archivo Maestran (.xlsx):</label>
        <input type="file" id="masterFileExcelUpload" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <button id="btnUploadLocalMaestra">⬆️ Cargar Maestra Local (Offline)</button>
      </div>
    </div>

    <div id="confirmacionCambiosStep" class="section hidden">
      <h2>Confirmar Cambios de Lista Maestra (desde Repositorio)</h2>
      <p>Se han detectado los siguientes cambios respecto a tu lista local guardada:</p>
      <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
          <div id="resumenNuevos"><h3>Nuevos Ítems:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenEliminados"><h3>Ítems Eliminados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenModificados"><h3>Ítems Modificados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
      </div>
      <p>¿Deseas aplicar estos cambios y usar la versión del repositorio en tu sesión actual?</p>
      <div style="text-align: center;">
        <button id="btnConfirmarCambiosRepositorio">Sí, Aplicar Cambios del Repositorio</button>
        <button id="btnRechazarCambiosRepositorio" class="secondary">No, Mantener Mi Versión Local</button>
      </div>
    </div>

    <div id="gestionMaestraStep" class="section hidden">
      <h2>Ver Lista Maestra y Buscar</h2>
      <div class="input-group">
        <label for="searchFocoInput">Buscar Ítem (por ID, UPC, descripción, marca o URL de imagen):</label>
        <input type="text" id="searchFocoInput" placeholder="Ingrese término de búsqueda...">
        
        <label for="departmentFilter">Filtrar por Departamento:</label>
        <select id="departmentFilter">
            <option value="">Todos los Departamentos</option>
            </select>

        <label for="segmentFilter">Filtrar por Segmento:</label>
        <select id="segmentFilter">
            <option value="">Todos los Segmentos</option>
            <option value="ACP">ACP</option>
            <option value="PPS">PPS</option>
        </select>
      </div>
      <div id="focoSearchResults" class="search-results-area" style="margin-bottom: 20px;">Resultados de la búsqueda aparecerán aquí...</div>

      <div id="focoPreview" class="preview-area">
        <h3>Estadísticas por Departamento y Segmento</h3>
        <ul id="departmentAndSegmentStats">
            <li><strong>Total ítems por depto:</strong> <ul id="statItemsByDepartment" style="list-style-type: none; padding-left: 15px;"></ul></li>
            <li><strong>Total ítems por segmento:</strong> <ul id="statItemsBySegment" style="list-style-type: none; padding-left: 15px;"></ul></li>
        </ul>
        <p style="font-size:0.8em; margin-top:15px; text-align:center;">
            Utiliza la barra de búsqueda de arriba para encontrar ítems específicos.
        </p>
      </div>

      <div style="margin-top:20px; text-align:center;">
        <button id="btnVolverAlPanelDesdeGestion" class="secondary">↩️ Volver al Panel de Inicio</button>
      </div>
    </div>

    <div id="dobleControlStep" class="section hidden">
      <h2>Paso 2: Cargar Lista de Ítems para Doble Control</h2>
      <p style="font-size:0.9em; color: #555;">
        Puede escanear el UPC del artículo físico (si su Lista Ma
        Solo se considerarán IDs de Ítem **numéricos de más de 5 dígitos**.
      </p>
       <p style="font-size:0.85em; color:#c0392b; background-color: #fdedec; padding: 5px; border-left: 3px solid #c0392b;">
        Para el reporte XLSX con información de carga (contenedora, cantidad), suba un archivo Excel (.xlsx) con encabezados: `item_`, `contenedoras`, `cantidad`.
      </p>
      <div class="input-group">
        <label for="verifyTextarea">Pegar IDs de Ítem a verificar (uno por línea o separados por espacio/tabulador):</label>
        <textarea id="verifyTextarea" rows="5" inputmode="numeric"></textarea>
      </div>
       <div class="input-group">
        <label>Subir archivo con IDs de Ítem a verificar:</label>
        <p style="font-size:0.85em; color:#666;">Se tomarán los IDs de Ítem de la columna especificada. Para información adicional en el reporte XLSX (contenedora, cantidad), use Excel con las columnas indicadas arriba.</p>
        <div class="input-columns">
            <div><label for="verifyFileTxtCsv" style="font-size:0.9em;">Texto (.txt, .csv):</label><input type="file" id="verifyFileTxtCsv" accept=".txt,.csv"></div>
            <div><label for="verifyFileExcel" style="font-size:0.9em;">Excel (.xlsx, .xls):</label><input type="file" id="verifyFileExcel" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"></div>
        </div>
        <div class="file-options">
            <div class="input-columns">
                <div><label for="verifyCodigoCol">Col. ID Ítem (ej: 1 o por header 'item_'):</label><input type="number" id="verifyCodigoCol" value="1" min="1"></div>
                 <div><label for="verifyCsvDelimiter">Delimitador CSV:</label><input type="text" id="verifyCsvDelimiter" value=","></div>
            </div>
             <label><input type="checkbox" id="verifyHasHeader" checked> El archivo tiene encabezados</label>
        </div>
      </div>
      <div class="input-group">
        <button id="startScanVerifyBtn">📷 Escanear UPC de Artículo</button>
        <div id="scannerContainerVerify" class="hidden"><div id="readerVerify"></div></div>
        <label for="scannedCodesVerifyTextarea" style="margin-top:10px;">IDs de Ítem válidos identificados (desde UPC escaneado o ingresado):</label>
        <textarea id="scannedCodesVerifyTextarea" rows="3" placeholder="Los IDs de Ítem válidos aparecerán aquí..." readonly></textarea>
      </div>
      <div id="verifyPreview" class="preview-area">Aún no se han cargado Ítems a verificar.</div>
      <hr style="margin: 20px 0;">
      <button id="btnVolverAlPanelDesdeDobleControl" class="secondary">&larr; Volver al Panel de Inicio</button>
      <button id="btnCompare">Verificar y Mostrar Ítems Concordantes &rarr;</button>
    </div>

    <div id="resultadosStep" class="section hidden">
      <h2>Resultados: Ítems Concordantes</h2>
      <div id="resultsSummary" class="results-summary">
        <p>Total Ítems en Lista Maestra: <strong id="totalFoco">0</strong></p>
        <p>Total Ítems en Lista de Verificación (válidos): <strong id="totalVerify">0</strong></p>
        <p>Ítems Concordantes Verificados: <strong id="totalMatches">0</strong></p>
      </div>
      <h3>Detalle de Ítems Concordantes (Clic para ver más)</h3>
      <div style="margin-bottom: 15px;">
          <button id="layoutToggleResultsBtn">📊 Cambiar Vista</button>
          <button id="downloadXlsxResultsBtn" class="secondary">📊 Descargar XLSX (Informe por Contenedora)</button>
          <button id="downloadCsvResultsBtn" class="secondary">💾 Descargar CSV de Concordancias</button>
      </div>
      <div id="outputResults" class="list"><p>No se han encontrado coincidencias o no se ha realizado la verificación.</p></div>
      <hr style="margin: 20px 0;">
      <button id="btnNewVerification">✨ Iniciar Nuevo Doble Control</button>
    </div>
  </div>

  <div id="itemDetailModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeItemDetailModal()">&times;</span>
      <h3 id="modalItemCodigo"></h3>
      <div id="modalItemImageContainer">
        <img id="modalItemImage" src="#" alt="Imagen del Ítem">
        <p id="modalImageError">URL de imagen no especificada o error al cargar.</p>
      </div>
      <p><strong>Descripción:</strong> <span id="modalItemDescripcion"></span></p>
      <p><strong>UPC:</strong> <span id="modalItemUPC"></span></p>
      <p><strong>Marca:</strong> <span id="modalItemBrand"></span></p>
      <p><strong>Departamento:</strong> <span id="modalItemDepartment"></span></p>
      <p><strong>UOM:</strong> <span id="modalItemUom"></span></p>
      <div id="modalItemBarcodeSvg"></div>
    </div>
  </div>

  <div id="toast-container"></div>

  <footer>
    Sistema de Doble Control de Ítems v3.0.3 - Desarrollado por fgalaz - Chile, 2025
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ----- URL DE LA LISTA MAESTRA EN REPOSITORIO (DEBE SER UN ARCHIVO .XLSX) -----
    const URL_LISTA_MAESTRA_REPOSITORIO = 'https://raw.githubusercontent.com/Galaz94/Double_Control/main/maestra.xlsx'; // ¡Asegúrate de que esta URL apunte a tu XLSX!

    // ----- ESTADO DE LA APLICACIÓN -----
    let listaFoco = new Map();
    let upcToCodigoMap = new Map();
    let listaVerificar = new Set(); 
    let datosVerificacionCargados = []; 
    let coincidencias = new Map();
    const LOCAL_STORAGE_KEY_LISTA_FOCO = 'sDCI_listaFocoGuardada_v3.0.3'; // Clave actualizada para la versión 3.0.3
    let listaFocoCacheadaLocalmente = new Map();
    let html5QrCodeVerifier = null;
    let scannerVerifierActive = false;

    const $ = (id) => document.getElementById(id);
    const DOM = {
        views: {
            panelInicio: $('panelInicio'),
            gestionMaestraStep: $('gestionMaestraStep'),
            dobleControlStep: $('dobleControlStep'),
            resultadosStep: $('resultadosStep'),
            confirmacionCambiosStep: $('confirmacionCambiosStep'),
            itemDetailModal: $('itemDetailModal'),
        },
        buttons: {
            iniciarDobleControl: $('btnIniciarDobleControlDesdePanel'),
            gestionMaestra: $('btnGestionMaestraDesdePanel'),
            borrarStorage: $('btnBorrarMaestraStorage'),
            volverDesdeGestion: $('btnVolverAlPanelDesdeGestion'),
            volverDesdeDobleControl: $('btnVolverAlPanelDesdeDobleControl'),
            compare: $('btnCompare'),
            startScanVerify: $('startScanVerifyBtn'),
            layoutToggle: $('layoutToggleResultsBtn'),
            downloadXlsx: $('downloadXlsxResultsBtn'),
            downloadCsv: $('downloadCsvResultsBtn'),
            newVerification: $('btnNewVerification'),
            confirmarCambios: $('btnConfirmarCambiosRepositorio'),
            rechazarCambios: $('btnRechazarCambiosRepositorio'),
            uploadLocalMaestra: $('btnUploadLocalMaestra'), 
        },
        inputs: {
            searchFoco: $('searchFocoInput'),
            verifyTextarea: $('verifyTextarea'),
            verifyFileTxtCsv: $('verifyFileTxtCsv'),
            verifyFileExcel: $('verifyFileExcel'),
            verifyCodigoCol: $('verifyCodigoCol'),
            verifyCsvDelimiter: $('verifyCsvDelimiter'),
            verifyHasHeader: $('verifyHasHeader'),
            scannedCodesVerifyTextarea: $('scannedCodesVerifyTextarea'),
            masterFileExcelUpload: $('masterFileExcelUpload'), 
        },
        displays: {
            panelInicioInfo: $('panelInicioInfo'),
            focoSearchResults: $('focoSearchResults'),
            focoPreview: $('focoPreview'),
            verifyPreview: $('verifyPreview'),
            scannerContainerVerify: $('scannerContainerVerify'),
            readerVerify: $('readerVerify'),
            outputResults: $('outputResults'),
        },
        stats: {
            // General stats removed
            // totalItems: $('statTotalItems'),
            // noImageUrl: $('statNoImageUrl'),
            // noUpc: $('statNoUpc'),
            // noDescription: $('statNoDescription'),
            // noBrand: $('statNoBrand'),

            totalFoco: $('totalFoco'),
            totalVerify: $('totalVerify'),
            totalMatches: $('totalMatches'),
            itemsByDepartment: $('statItemsByDepartment'),
            itemsBySegment: $('statItemsBySegment'),
        },
        filters: {
            department: $('departmentFilter'),
            segment: $('segmentFilter'),
        },
        modal: {
            image: $('modalItemImage'),
            imageError: $('modalImageError'),
            codigo: $('modalItemCodigo'),
            descripcion: $('modalItemDescripcion'),
            upc: $('modalItemUPC'),
            brand: $('modalItemBrand'),
            department: $('modalItemDepartment'),
            uom: $('modalItemUom'),
            barcodeSvgContainer: $('modalItemBarcodeSvg') // Nuevo para el código de barras
        },
        resumenCambios: {
            nuevos: document.querySelector('#resumenNuevos ul'),
            eliminados: document.querySelector('#resumenEliminados ul'),
            modificados: document.querySelector('#resumenModificados ul'),
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        checkInitialState();
        navigateToView('panelInicio');
        addEventListeners();
    });

    // --- Toast / Snackbar Implementation ---
    function showToast(message, type = 'info', duration = 3000) {
        let toastContainer = $('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            document.body.appendChild(toastContainer);
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);

        // Force reflow to enable transition
        void toast.offsetWidth; 
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => {
                toast.remove();
            }, { once: true });
        }, duration);
    }

    function addEventListeners() {
        DOM.views.itemDetailModal.addEventListener('click', (event) => {
            // Only close if clicking directly on the modal background or the close button
            if (event.target === DOM.views.itemDetailModal || event.target.classList.contains('close-modal')) {
                closeItemDetailModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && DOM.views.itemDetailModal.style.display === 'flex') {
                closeItemDetailModal();
            }
        });

        DOM.modal.image.onerror = function() {
            this.style.display = 'none';
            DOM.modal.imageError.style.display = 'block';
            DOM.modal.imageError.textContent = 'Error al cargar imagen o URL no válida.';
        };
        DOM.modal.image.onload = function() {
            this.style.display = 'block';
            DOM.modal.imageError.style.display = 'none';
        };

        DOM.buttons.iniciarDobleControl.addEventListener('click', handleIniciarDobleControl);
        DOM.buttons.gestionMaestra.addEventListener('click', () => navigateToView('gestionMaestraStep'));
        DOM.buttons.borrarStorage.addEventListener('click', handleBorrarStorage);
        DOM.buttons.uploadLocalMaestra.addEventListener('click', handleMasterFileUpload); 
        DOM.inputs.masterFileExcelUpload.addEventListener('change', () => { 
            DOM.buttons.uploadLocalMaestra.disabled = !DOM.inputs.masterFileExcelUpload.files.length;
        });
        DOM.buttons.uploadLocalMaestra.disabled = true; 

        DOM.inputs.searchFoco.addEventListener('input', () => {
            updateFocoPreviewAndSearch(); 
        });

        DOM.filters.department.addEventListener('change', () => {
            DOM.filters.department.dataset.previousValue = DOM.filters.department.value; 
            updateFocoPreviewAndSearch();
        });
        DOM.filters.segment.addEventListener('change', () => updateFocoPreviewAndSearch());

        DOM.buttons.volverDesdeGestion.addEventListener('click', () => navigateToView('panelInicio'));

        DOM.inputs.verifyFileTxtCsv.addEventListener('change', (e) => handleVerifyFileUpload(e.target.files[0], 'textcsv'));
        DOM.inputs.verifyFileExcel.addEventListener('change', (e) => handleVerifyFileUpload(e.target.files[0], 'excel'));
        DOM.buttons.startScanVerify.addEventListener('click', toggleScanner);
        DOM.buttons.compare.addEventListener('click', handleCompare);
        DOM.buttons.volverDesdeDobleControl.addEventListener('click', () => navigateToView('panelInicio'));

        DOM.buttons.layoutToggle.addEventListener('click', toggleResultsLayout);
        DOM.buttons.downloadCsv.addEventListener('click', downloadCsvResults);
        DOM.buttons.downloadXlsx.addEventListener('click', downloadXlsxResults);
        DOM.buttons.newVerification.addEventListener('click', handleNewVerification);

        DOM.displays.outputResults.addEventListener('click', (event) => {
            const itemContainer = event.target.closest('.barcode-item-container');
            if (itemContainer) {
                const itemId = itemContainer.dataset.iditem;
                if (itemId) openItemDetailModal(itemId);
            }
        });
        DOM.displays.focoSearchResults.addEventListener('click', (event) => {
            const itemContainer = event.target.closest('.search-result-item');
            if(itemContainer) {
                const itemId = itemContainer.dataset.iditem;
                if(itemId) openItemDetailModal(itemId);
            }
        });
        DOM.buttons.confirmarCambios.addEventListener('click', () => { 
            const maestraRepositorioMap = JSON.parse(DOM.buttons.confirmarCambios.dataset.maestraRepositorio || '{}', (key, value) => {
                if (typeof value === 'object' && value !== null && value.__isMap__) return new Map(value.data);
                return value;
            });
            if (maestraRepositorioMap && maestraRepositorioMap.size > 0) {
                listaFoco = maestraRepositorioMap;
                rebuildUpcToCodigoMap();
                saveListaFocoToStorage();
                updateFocoPreviewAndSearch();
                DOM.displays.panelInicioInfo.innerHTML = `✅ Maestra Sincronizada (${listaFoco.size} ítems) y guardada.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info';
                showToast(`Maestra Sincronizada (${listaFoco.size} ítems) y guardada.`, 'success');
            } else {
                 DOM.displays.panelInicioInfo.innerHTML = `⚠️ Error al aplicar cambios. Se mantuvo la versión actual.`;
                 DOM.displays.panelInicioInfo.className = 'panel-inicio-info warning';
                 showToast(`Error al aplicar cambios. Se mantuvo la versión actual.`, 'error');
            }
            navigateToView('panelInicio');
        });
        DOM.buttons.rechazarCambios.addEventListener('click', () => { 
            rebuildUpcToCodigoMap(); 
            updateFocoPreviewAndSearch();
            DOM.displays.panelInicioInfo.innerHTML = `ℹ️ Cambios del repositorio ignorados. Maestra local (${listaFoco.size} ítems).`;
            DOM.displays.panelInicioInfo.className = 'panel-inicio-info info';
            showToast(`Cambios del repositorio ignorados. Maestra local (${listaFoco.size} ítems).`, 'info');
            navigateToView('panelInicio');
        });
    }

    function cleanText(text) { return text ? String(text).trim() : ''; }

    // NUEVA FUNCIÓN para parsear XLSX para la LISTA MAESTRA
    async function parsearMaestraXLSX(arrayBuffer) {
        const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        if (!worksheet) throw new Error("Archivo XLSX de Maestra sin hojas.");

        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, rawNumbers: false, defval: null });
        if (jsonData.length === 0) return [];

        const headersRow = jsonData[0].map(h => cleanText(h || '').toLowerCase());
        const dataRows = jsonData.slice(1);

        // Updated expected headers to include 'url'
        // Add 'uom' as the preferred header, keep 'quantity' for backward compatibility
        const expectedHeaders = ['department', 'item', 'upc', 'descripcion', 'brand', 'uom', 'quantity', 'url'];
        const headerMap = {};
        expectedHeaders.forEach(eh => {
            const idx = headersRow.indexOf(eh);
            if (idx !== -1) headerMap[eh] = idx;
        });
        // Special mapping for 'item' to 'codigo' if needed
        if (headerMap['item'] === undefined) {
             console.warn("Columna 'item' no encontrada en la maestra. Asegúrate de que el encabezado sea 'item'.");
             throw new Error("Columna 'item' (ID de ítem) no encontrada en el archivo XLSX de la maestra.");
        }


        const itemsArray = dataRows.map(row => {
            if (!row || row.every(cell => cell === null || cell === '')) return null;

            const item = {};
            item.department = cleanText(row[headerMap['department']]);
            item.codigo = cleanText(row[headerMap['item']]); // 'item' del XLSX es 'codigo' en nuestra lógica
            item.upc = cleanText(row[headerMap['upc']]);
            item.descripcion = cleanText(row[headerMap['descripcion']]);
            item.brand = cleanText(row[headerMap['brand']]);
            // Prioritize 'uom', fallback to 'quantity' for backward compatibility
            item.uom = cleanText(row[headerMap['uom']]) || cleanText(row[headerMap['quantity']]);
            item.url = cleanText(row[headerMap['url']]); // Now explicitly looking for 'url' column

            // Validar que el código esté presente
            if (!item.codigo) return null; 
            return item;
        }).filter(Boolean); // Filtrar filas nulas o inválidas

        return itemsArray;
    }


    function rebuildUpcToCodigoMap() {
        upcToCodigoMap.clear();
        listaFoco.forEach(item => {
            if (item.upc?.trim()) {
                upcToCodigoMap.set(item.upc.trim(), item.codigo);
            }
        });
    }

    async function cargarMaestraDesdeRepositorio() {
        if (!URL_LISTA_MAESTRA_REPOSITORIO || URL_LISTA_MAESTRA_REPOSITORIO.includes('PON_AQUI_LA_URL')) {
            console.warn('URL_LISTA_MAESTRA_REPOSITORIO no configurada.');
            return null;
        }
        try {
            const response = await fetch(`${URL_LISTA_MAESTRA_REPOSITORIO}?t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const arrayBuffer = await response.arrayBuffer(); // Obtener como ArrayBuffer para XLSX
            const itemsArray = await parsearMaestraXLSX(arrayBuffer); // Usar la nueva función para XLSX

            const nuevaListaMap = new Map();
            itemsArray.forEach(item => {
                const idItemLimpio = cleanCode(item.codigo);
                if (idItemLimpio) nuevaListaMap.set(idItemLimpio, item);
            });
            return nuevaListaMap;
        } catch (error) {
            console.error('Excepción al cargar Maestra desde repositorio:', error);
            return null;
        }
    }

    function compararListas(listaLocalMap, listaRemotaMap) {
        const nuevos = [], eliminados = [], modificados = [];
        listaRemotaMap.forEach((itemRemoto, codigo) => {
            if (!listaLocalMap.has(codigo)) {
                nuevos.push(itemRemoto);
            } else {
                const itemLocal = listaLocalMap.get(codigo);
                const changedFields = {};
                // Compare new fields
                if ((itemLocal.department ?? '') !== (itemRemoto.department ?? '')) changedFields.department = { old: itemLocal.department, new: itemRemoto.department };
                if ((itemLocal.uom ?? '') !== (itemRemoto.uom ?? '')) changedFields.uom = { old: itemLocal.uom, new: itemRemoto.uom };
                // Original fields
                if ((itemLocal.descripcion ?? '') !== (itemRemoto.descripcion ?? '')) changedFields.descripcion = { old: itemLocal.descripcion, new: itemRemoto.descripcion };
                if ((itemLocal.upc ?? '') !== (itemRemoto.upc ?? '')) changedFields.upc = { old: itemLocal.upc, new: itemRemoto.upc };
                if ((itemLocal.brand ?? '') !== (itemRemoto.brand ?? '')) changedFields.brand = { old: itemLocal.brand, new: itemRemoto.brand };
                if ((itemLocal.url ?? '') !== (itemRemoto.url ?? '')) changedFields.url = { old: itemLocal.url, new: itemRemoto.url };

                if (Object.keys(changedFields).length > 0) {
                    modificados.push({ ...itemRemoto, changedFields });
                }
            }
        });
        listaLocalMap.forEach((itemLocal, codigo) => {
            if (!listaRemotaMap.has(codigo)) eliminados.push(itemLocal);
        });
        return { nuevos, eliminados, modificados };
    }

    function mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraRepositorioMap) {
        const popularListaResumen = (ul, items, fmt) => {
            ul.innerHTML = items.length > 0 ? items.map(fmt).join('') : '<li>Ninguno</li>';
        };
        const itemFormatter = itm => `<li><span class="code">${itm.codigo}</span>: D:${itm.descripcion??'N/A'}, U:${itm.upc??'N/A'}, Dept:${itm.department??'N/A'}, UOM:${itm.uom??'N/A'}</li>`;
        
        popularListaResumen(DOM.resumenCambios.nuevos, nuevos, itemFormatter);
        popularListaResumen(DOM.resumenCambios.eliminados, eliminados, itemFormatter);

        popularListaResumen(DOM.resumenCambios.modificados, modificados, itm => {
            let chgs = '';
            if(itm.changedFields.department) chgs += `<span class="field-change">Dept: <s>${itm.changedFields.department.old??'N/A'}</s> &rarr; ${itm.changedFields.department.new??'N/A'}</span>`;
            if(itm.changedFields.uom) chgs += `<span class="field-change">UOM: <s>${itm.changedFields.uom.old??'N/A'}</s> &rarr; ${itm.changedFields.uom.new??'N/A'}</span>`;
            if(itm.changedFields.descripcion) chgs += `<span class="field-change">Desc: <s>${itm.changedFields.descripcion.old??'N/A'}</s> &rarr; ${itm.changedFields.descripcion.new??'N/A'}</span>`;
            if(itm.changedFields.upc) chgs += `<span class="field-change">UPC: <s>${itm.changedFields.upc.old??'N/A'}</s> &rarr; ${itm.changedFields.upc.new??'N/A'}</span>`;
            if(itm.changedFields.brand) chgs += `<span class="field-change">Brand: <s>${itm.changedFields.brand.old??'N/A'}</s> &rarr; ${itm.changedFields.brand.new??'N/A'}</span>`;
            if(itm.changedFields.url) chgs += `<span class="field-change">URL Img: <s>${itm.changedFields.url.old??'N/A'}</s> &rarr; ${itm.changedFields.url.new??'N/A'}</span>`;
            return `<li><span class="code">${itm.codigo}</span>${chgs}</li>`;
        });
        
        DOM.buttons.confirmarCambios.dataset.maestraRepositorio = JSON.stringify(maestraRepositorioMap, (key, value) => {
             if (value instanceof Map) return { __isMap__: true, data: Array.from(value.entries()) };
             return value;
        });
        navigateToView('confirmacionCambiosStep');
    }

    async function checkInitialState() {
        loadListaFocoFromStorage(false);
        listaFocoCacheadaLocalmente = new Map(listaFoco);
        DOM.displays.panelInicioInfo.innerHTML = '🔄 Sincronizando Maestra desde el repositorio...';
        DOM.displays.panelInicioInfo.className = 'panel-inicio-info info';
        DOM.buttons.iniciarDobleControl.disabled = true;
        DOM.buttons.gestionMaestra.disabled = true;

        const maestraDesdeRepositorio = await cargarMaestraDesdeRepositorio();
        DOM.buttons.iniciarDobleControl.disabled = false;
        DOM.buttons.gestionMaestra.disabled = false;

        if (maestraDesdeRepositorio) {
            const { nuevos, eliminados, modificados } = compararListas(listaFocoCacheadaLocalmente, maestraDesdeRepositorio);

            if (nuevos.length === 0 && eliminados.length === 0 && modificados.length === 0) {
                DOM.displays.panelInicioInfo.innerHTML = `✅ Maestra Sincronizada (${listaFoco.size} ítems). Ya estaba actualizada.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info';
                // Only update and save if the *content* is actually different, not just the object reference
                const localValues = JSON.stringify(Array.from(listaFoco.values()));
                const repoValues = JSON.stringify(Array.from(maestraDesdeRepositorio.values()));
                if (localValues !== repoValues) {
                    listaFoco = new Map(maestraDesdeRepositorio); 
                    saveListaFocoToStorage(false); 
                }
                showToast(`Maestra Sincronizada (${listaFoco.size} ítems).`, 'success');
            } else {
                DOM.displays.panelInicioInfo.innerHTML = `ℹ️ Cambios detectados en Maestra. Revisa y confirma.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info warning';
                showToast(`Cambios detectados en Maestra. Revisa y confirma.`, 'warning');
                mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraDesdeRepositorio);
                return; 
            }
        } else {
            if (listaFoco.size > 0) {
                DOM.displays.panelInicioInfo.innerHTML = `⚠️ Error al cargar desde repositorio. Usando Maestra local (${listaFoco.size} ítems).`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info warning';
                showToast(`Error al cargar desde repositorio. Usando Maestra local (${listaFoco.size} ítems).`, 'warning');
            } else {
                DOM.displays.panelInicioInfo.innerHTML = `❌ Error al cargar y no hay Maestra local. Funcionalidad limitada.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info error';
                DOM.buttons.iniciarDobleControl.disabled = true;
                DOM.buttons.gestionMaestra.disabled = true;
                showToast(`Error al cargar y no hay Maestra local. Funcionalidad limitada.`, 'error');
            }
        }
        rebuildUpcToCodigoMap();
        updateFocoPreviewAndSearch();
        if(DOM.views.confirmacionCambiosStep.classList.contains('hidden')){ 
             navigateToView('panelInicio');
        }
    }

    function navigateToView(viewName) {
        const viewToShow = DOM.views[viewName];
        if (!viewToShow) {
            console.error("Vista no encontrada:", viewName);
            return;
        }

        if (viewName === 'itemDetailModal') {
            // Si es el modal, solo lo mostramos como una superposición
            viewToShow.style.display = 'flex';
        } else {
            // Si es una vista de página, ocultamos las otras y mostramos la correcta
            Object.entries(DOM.views).forEach(([key, div]) => {
                if (key !== 'itemDetailModal') { // No ocultar el modal, solo las vistas de página
                    div.classList.add('hidden');
                }
            });
            DOM.views.itemDetailModal.style.display = 'none'; // Asegurarse que el modal se oculte al cambiar de página
            viewToShow.classList.remove('hidden');
            if (viewName === 'gestionMaestraStep') updateFocoPreviewAndSearch();
        }
    }

    function cleanCode(code) {
        if (typeof code !== 'string' && typeof code !== 'number') return '';
        return String(code).trim().replace(/[^a-zA-Z0-9\-]+/g, '').toUpperCase();
    }
    function resetFileInput(el) { if(el) el.value = null; }
    function getDelimiterRegex(d) {
        if (d.toLowerCase()==='<tab>') return /\t/;
        return new RegExp(d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
    }

    function updateFocoPreviewAndSearch(itemsToDisplayInSearch = null) {
        // No need for general stats now
        // let countNoUrl = 0, countNoUpc = 0, countNoDescription = 0, countNoBrand = 0;
        const itemsByDepartment = {};
        let ppsCount = 0;
        let acpCount = 0;
        const uniqueDepartments = new Set();

        listaFoco.forEach(item => {
            // Original stats (now only for logic, not display)
            // if (!item.url?.trim()) countNoUrl++;
            // if (!item.upc?.trim()) countNoUpc++;
            // if (!item.descripcion?.trim()) countNoDescription++;
            // if (!item.brand?.trim()) countNoBrand++;

            // New department/segment stats
            const department = item.department?.trim();
            if (department) {
                uniqueDepartments.add(department);
                itemsByDepartment[department] = (itemsByDepartment[department] || 0) + 1;
                const deptNum = parseInt(department, 10);
                if (!isNaN(deptNum)) {
                    // Departments 90, 91, 97 are PPS. Others are ACP.
                    if (deptNum === 91 || deptNum === 90 || deptNum === 97) {
                        ppsCount++;
                    } else {
                        acpCount++;
                    }
                }
            }
        });

        // Update basic stats (removed general stats, keep total for info)
        // DOM.stats.totalItems.textContent = listaFoco.size;
        // DOM.stats.noImageUrl.textContent = countNoUrl;
        // DOM.stats.noUpc.textContent = countNoUpc;
        // DOM.stats.noDescription.textContent = countNoDescription;
        // DOM.stats.noBrand.textContent = countNoBrand;

        // Update department stats
        DOM.stats.itemsByDepartment.innerHTML = '';
        Object.entries(itemsByDepartment).sort(([d1], [d2]) => d1.localeCompare(d2)).forEach(([dept, count]) => {
            const li = document.createElement('li');
            li.textContent = `Depto ${dept}: ${count} ítems`;
            DOM.stats.itemsByDepartment.appendChild(li);
        });

        // Update segment stats
        DOM.stats.itemsBySegment.innerHTML = '';
        let liACP = document.createElement('li');
        liACP.textContent = `ACP: ${acpCount} ítems`;
        DOM.stats.itemsBySegment.appendChild(liACP);
        let liPPS = document.createElement('li');
        liPPS.textContent = `PPS: ${ppsCount} ítems`;
        DOM.stats.itemsBySegment.appendChild(liPPS);

        // Populate Department Filter
        DOM.filters.department.innerHTML = '<option value="">Todos los Departamentos</option>';
        Array.from(uniqueDepartments).sort((a,b) => parseInt(a) - parseInt(b)).forEach(dept => { // Sort numerically
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = `Departamento ${dept}`;
            DOM.filters.department.appendChild(option);
        });
        // Set selected value back if it was set before refreshing options
        if (DOM.filters.department.dataset.previousValue) {
            DOM.filters.department.value = DOM.filters.department.dataset.previousValue;
        }


        // --- Search and Filtering Logic ---
        const searchTerm = DOM.inputs.searchFoco.value.toLowerCase().trim();
        const selectedDepartment = DOM.filters.department.value;
        const selectedSegment = DOM.filters.segment.value;

        // Determine which items to filter (either all or pre-filtered from initial search input)
        let itemsToFilter = Array.from(listaFoco.values()).filter(item =>
            (item.codigo && item.codigo.toLowerCase().includes(searchTerm)) ||
            (item.upc && item.upc.toLowerCase().includes(searchTerm)) ||
            (item.descripcion && item.descripcion.toLowerCase().includes(searchTerm)) ||
            (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
            (item.url && item.url.toLowerCase().includes(searchTerm))
        );

        const filteredResults = itemsToFilter.filter(item => {
            const matchesDepartment = selectedDepartment === "" || (item.department && item.department === selectedDepartment);
            
            let matchesSegment = true;
            if (selectedSegment !== "") {
                const deptNum = parseInt(item.department, 10);
                if (selectedSegment === "PPS") {
                    matchesSegment = (deptNum === 91 || deptNum === 90 || deptNum === 97);
                } else if (selectedSegment === "ACP") {
                    matchesSegment = !(isNaN(deptNum) || deptNum === 91 || deptNum === 90 || deptNum === 97);
                }
            }
            return matchesDepartment && matchesSegment;
        });

        DOM.displays.focoSearchResults.innerHTML = '';
        if (filteredResults.length > 0) {
            const fragment = document.createDocumentFragment();
            // Limit to 30 items for preview to avoid performance issues with very large results
            filteredResults.slice(0, 30).forEach(item => {
                const p = document.createElement('div');
                p.className = 'search-result-item';
                p.dataset.iditem = item.codigo;
                p.innerHTML = `<span class="code">${item.codigo}</span> <span class="upc-brand-url">(Depto: ${item.department??'N/A'}, UPC: ${item.upc??'N/A'})</span> <span class="desc">${item.descripcion??'(S/D)'}</span>`;
                fragment.appendChild(p);
            });
            DOM.displays.focoSearchResults.appendChild(fragment);

            if (filteredResults.length > 30) {
                DOM.displays.focoSearchResults.innerHTML += `<p style="text-align:center; font-style:italic;">... y ${filteredResults.length - 30} más.</p>`;
            }
        } else if (searchTerm || selectedDepartment || selectedSegment) {
            DOM.displays.focoSearchResults.innerHTML = '<p style="text-align:center;">No se encontraron ítems con los filtros aplicados.</p>';
        } else {
             DOM.displays.focoSearchResults.innerHTML = '<p style="text-align:center;">Ingrese un término para buscar o use los filtros.</p>';
        }
    }

    function saveListaFocoToStorage(showAlert = true) {
        if (listaFoco.size === 0 && showAlert && !confirm("Maestra vacía. ¿Guardar vacía?")) return false;
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_LISTA_FOCO, JSON.stringify(Array.from(listaFoco.values())));
            if (showAlert) showToast(`Maestra con ${listaFoco.size} ítems guardada.`, 'success');
            return true;
        } catch (e) {
            if (showAlert) showToast(`Error al guardar Maestra: ${e.message}`, 'error');
            return false;
        }
    }

    function loadListaFocoFromStorage(showAlerts = true) {
        const data = localStorage.getItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
        listaFoco.clear();
        if (data) {
            try {
                const itemsArray = JSON.parse(data);
                itemsArray.forEach(item => {
                    const idItemLimpio = cleanCode(item.codigo);
                    if (idItemLimpio) listaFoco.set(idItemLimpio, item);
                });
                if (showAlerts) showToast(`Maestra local con ${listaFoco.size} ítems cargada.`, 'info');
            } catch (e) {
                if (showAlerts) showToast("Error al cargar Maestra: datos corruptos. Se borrará.", 'error');
                localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
            }
        }
    }

    // Nuevo: Manejar la carga del archivo XLSX de la Maestra
    async function handleMasterFileUpload() {
        const file = DOM.inputs.masterFileExcelUpload.files[0];
        if (!file) {
            showToast("Por favor, selecciona un archivo XLSX de Maestra.", 'warning');
            return;
        }

        DOM.displays.panelInicioInfo.innerHTML = `🔄 Cargando "${file.name}" localmente...`;
        DOM.displays.panelInicioInfo.className = 'panel-inicio-info info';
        DOM.buttons.uploadLocalMaestra.disabled = true;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const arrayBuffer = e.target.result;
                const itemsArray = await parsearMaestraXLSX(arrayBuffer);
                const nuevaListaMap = new Map();
                itemsArray.forEach(item => {
                    const idItemLimpio = cleanCode(item.codigo);
                    if (idItemLimpio) nuevaListaMap.set(idItemLimpio, item);
                });

                listaFoco = nuevaListaMap;
                rebuildUpcToCodigoMap();
                saveListaFocoToStorage(true); 
                updateFocoPreviewAndSearch();

                DOM.displays.panelInicioInfo.innerHTML = `✅ Maestra local "${file.name}" cargada y guardada (${listaFoco.size} ítems).`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info';
                showToast(`Maestra local "${file.name}" cargada y guardada (${listaFoco.size} ítems).`, 'success');
                resetFileInput(DOM.inputs.masterFileExcelUpload);
            } catch (error) {
                console.error('Error al procesar archivo local de Maestra:', error);
                DOM.displays.panelInicioInfo.innerHTML = `❌ Error al cargar "${file.name}": ${error.message}`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info error';
                showToast(`Error al cargar el archivo de Maestra: ${error.message}`, 'error');
            } finally {
                DOM.buttons.uploadLocalMaestra.disabled = false;
            }
        };
        reader.onerror = (e) => {
            console.error('Error al leer el archivo:', e);
            DOM.displays.panelInicioInfo.innerHTML = `❌ Error al leer "${file.name}".`;
            DOM.displays.panelInicioInfo.className = 'panel-inicio-info error';
            showToast(`Error al leer el archivo: ${file.name}`, 'error');
            DOM.buttons.uploadLocalMaestra.disabled = false;
        };
        reader.readAsArrayBuffer(file);
    }

    // Renombrado para evitar conflicto con la nueva función de carga de maestra
    function handleVerifyFileUpload(file, fileType) {
        if (!file) return;
        DOM.displays.verifyPreview.innerHTML = `Procesando "${file.name}"...`;
        const idItemColUserInput = parseInt(DOM.inputs.verifyCodigoCol.value);
        const delimiter = DOM.inputs.verifyCsvDelimiter.value;
        const hasHeader = DOM.inputs.verifyHasHeader.checked;
        const targetFileElement = fileType === 'excel' ? DOM.inputs.verifyFileExcel : DOM.inputs.verifyFileTxtCsv;

        if (idItemColUserInput < 1 && fileType === 'textcsv') {
            showToast("Col. ID Ítem debe ser >= 1 para texto/CSV.", 'error');
            DOM.displays.verifyPreview.textContent = "Error.";
            resetFileInput(targetFileElement);
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            try {
                let parsedItems = [];
                if (fileType === 'excel') {
                    parsedItems = processExcelDataForVerify(content, idItemColUserInput, hasHeader);
                } else { 
                    const itemIdsOnly = processTextCsvDataForVerify(content, idItemColUserInput - 1, hasHeader, delimiter);
                    parsedItems = itemIdsOnly.map(id => ({
                        idItem: id,
                        contenedora: 'N/A_TXT_CSV', 
                        cantidad: 0, 
                        allRowData: { item_: id },
                        isSuitableForGroupedReport: false 
                    }));
                }

                parsedItems.forEach(itemObj => {
                    const trimmedIdItem = cleanCode(itemObj.idItem); 
                    if (trimmedIdItem && /^[0-9]+$/.test(trimmedIdItem) && trimmedIdItem.length > 5) {
                        listaVerificar.add(trimmedIdItem); 
                        datosVerificacionCargados.push({...itemObj, idItem: trimmedIdItem }); 
                    } else {
                        console.warn("ID inválido o no encontrado:", itemObj.idItem, "Skipping.");
                    }
                });
                updateVerifyPreview();
                showToast(`Archivo "${file.name}" procesado. ${parsedItems.length} ítems cargados.`, 'success');

            } catch (error) {
                showToast(`Error procesando ${file.name}: ${error.message}`, 'error');
                DOM.displays.verifyPreview.textContent = `Error.`;
            }
            resetFileInput(targetFileElement); 
        };
        reader.onerror = () => { showToast(`No se pudo leer ${file.name}.`, 'error'); resetFileInput(targetFileElement); };
        
        if (fileType === 'excel') reader.readAsArrayBuffer(file);
        else reader.readAsText(file);
    }

    function processTextCsvDataForVerify(content, colIdx, hasHeader, delimiter = ',') {
        const lines = content.split(/\r\n|\n/);
        const dataRows = hasHeader ? lines.slice(1) : lines;
        const delimRegex = getDelimiterRegex(delimiter);
        return dataRows.map(line => {
            const parts = line.split(delimRegex);
            return parts[colIdx] ? String(Number(parts[colIdx])).trim() : null; 
        }).filter(Boolean);
    }

    function processExcelDataForVerify(arrayBuffer, itemColIdxUser, hasHeader) {
        const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        if (!worksheet) throw new Error("Excel sin hojas.");
        
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, rawNumbers: false, defval: null });
        if (jsonData.length === 0) return [];

        let headerRow = [];
        let dataRows = jsonData; 

        if (hasHeader && jsonData.length > 0) {
            headerRow = jsonData[0].map(h => h ? String(h).toLowerCase().trim() : '');
            dataRows = jsonData.slice(1);
        } else if (hasHeader && jsonData.length === 0) return [];
        
        const itemHeaderName = 'item_';
        const contenedoraHeaderName = 'contenedoras';
        const cantidadHeaderName = 'cantidad';

        let actualItemColIdx = -1;
        let contenedoraColIdx = -1;
        let cantidadColIdx = -1;
        let isSuitableForGroupedReport = false;

        if (hasHeader && headerRow.length > 0) {
            actualItemColIdx = headerRow.indexOf(itemHeaderName);
            contenedoraColIdx = headerRow.indexOf(contenedoraHeaderName);
            cantidadColIdx = headerRow.indexOf(cantidadHeaderName);

            if (actualItemColIdx === -1 && itemColIdxUser > 0 && (itemColIdxUser-1 < headerRow.length)) { 
                actualItemColIdx = itemColIdxUser - 1;
            } else if (actualItemColIdx === -1) {
                 throw new Error(`Columna '${itemHeaderName}' no encontrada o índice numérico no válido.`);
            }
            isSuitableForGroupedReport = (contenedoraColIdx !== -1 && cantidadColIdx !== -1 && actualItemColIdx !== -1);
        } else if (!hasHeader && itemColIdxUser > 0) { 
            actualItemColIdx = itemColIdxUser - 1;
            isSuitableForGroupedReport = false; 
        } else if (!hasHeader && itemColIdxUser <=0) {
            throw new Error("Excel sin encabezados y sin columna de ID válida.");
        }

        return dataRows.map(row => {
            if (!row || row.every(cell => cell === null || cell === '')) return null; 

            const idItem = (actualItemColIdx !== -1 && actualItemColIdx < row.length && row[actualItemColIdx]) ? String(Number(row[actualItemColIdx])).trim() : null;
            const contenedora = (contenedoraColIdx !== -1 && contenedoraColIdx < row.length && row[contenedoraColIdx]) ? String(row[contenedoraColIdx]).trim() : (isSuitableForGroupedReport ? 'Sin Contenedora' : 'N/A_EXCEL_NO_CONT_INFO');
            const cantidadVal = (cantidadColIdx !== -1 && cantidadColIdx < row.length && row[cantidadColIdx]) ? String(row[cantidadColIdx]).replace(',', '.') : null;
            const cantidad = cantidadVal ? parseFloat(cantidadVal) : 0;

            const allRowData = {};
            if (hasHeader && headerRow.length > 0) {
                headerRow.forEach((header, idx) => { if (header) allRowData[header] = row[idx]; });
            } else { 
                 row.forEach((val, idx) => allRowData[`col_${idx+1}`] = val);
            }
            
            return {
                idItem: idItem,
                contenedora: contenedora,
                cantidad: !isNaN(cantidad) ? cantidad : 0,
                allRowData: allRowData,
                isSuitableForGroupedReport: isSuitableForGroupedReport && idItem !== null 
            };
        }).filter(item => item && item.idItem); 
    }
    
    function updateVerifyPreview() {
        const count = listaVerificar.size;
        DOM.displays.verifyPreview.textContent = `Ítems a Verificar: ${count}. ${count > 0 ? `Primeros: ${[...listaVerificar].slice(0,5).join(', ')}${count > 5 ? '...' : ''}` : 'Vacía.'}`;
    }

    function collectVerifyDataFromInputs() {
        const textVerifyItems = DOM.inputs.verifyTextarea.value.trim();
        if (textVerifyItems) {
            textVerifyItems.split(/\s+/).forEach(id => {
                const trimmedIdItem = String(Number(id)).trim(); 
                if (/^[0-9]+$/.test(trimmedIdItem) && trimmedIdItem.length > 5) {
                    listaVerificar.add(trimmedIdItem); 
                    if (!datosVerificacionCargados.some(d => d.idItem === trimmedIdItem && d.contenedora === 'N/A_TEXTAREA')) {
                        datosVerificacionCargados.push({
                            idItem: trimmedIdItem, contenedora: 'N/A_TEXTAREA', cantidad: 0, 
                            allRowData: { item_: trimmedIdItem }, isSuitableForGroupedReport: false
                        });
                    }
                }
            });
        }
        updateVerifyPreview(); 
    }
    
    function onScanSuccessVerify(decodedText){
        const scannedUPC = cleanText(decodedText);
        let internalCode = null;
        if (scannedUPC) {
            // Buscar el código interno en el mapa de UPCs
            internalCode = upcToCodigoMap.get(scannedUPC);
            if (internalCode) {
                // Agregar a la lista de verificación si no está
                if (!listaVerificar.has(internalCode)) {
                    listaVerificar.add(internalCode);
                    datosVerificacionCargados.push({
                        idItem: internalCode,
                        contenedora: 'N/A_SCANNER',
                        cantidad: 0,
                        allRowData: { upc: scannedUPC },
                        isSuitableForGroupedReport: false
                    });
                    DOM.inputs.scannedCodesVerifyTextarea.value += (DOM.inputs.scannedCodesVerifyTextarea.value ? '\n' : '') + internalCode;
                    updateVerifyPreview();
                    showToast(`UPC escaneado (${scannedUPC}) agregado como ID ${internalCode}.`, 'success');
                } else {
                    showToast(`El ítem ${internalCode} ya fue agregado.`, 'info');
                }
            } else {
                showToast(`UPC escaneado (${scannedUPC}) no encontrado en Maestra.`, 'warning');
            }
        }
    }

    function toggleScanner() {
        if(scannerVerifierActive){
            if(html5QrCodeVerifier?.isScanning){
                html5QrCodeVerifier.stop().then(() => {
                    scannerVerifierActive = false;
                    DOM.displays.scannerContainerVerify.classList.add('hidden');
                    DOM.buttons.startScanVerify.textContent = '📷 Escanear UPC';
                }).catch(err => console.error("Error deteniendo escáner:", err));
            } else { 
                scannerVerifierActive = false;
                DOM.displays.scannerContainerVerify.classList.add('hidden');
                DOM.buttons.startScanVerify.textContent = '📷 Escanear UPC';
            }
        } else {
            if(location.protocol !=='https:' && !['localhost','127.0.0.1'].includes(location.hostname)){
                showToast('Escáner requiere HTTPS o localhost.', 'error'); return;
            }
            DOM.displays.scannerContainerVerify.classList.remove('hidden');
            DOM.buttons.startScanVerify.textContent = '🛑 Detener Escáner';
            if(!html5QrCodeVerifier) html5QrCodeVerifier = new Html5Qrcode("readerVerify", { verbose: false });
            const qrboxFunction = (vw, vh) => ({ width: Math.floor(vw * 0.8), height: Math.floor(vh * 0.4) });
            const config = { fps: 10, qrbox: qrboxFunction, supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA] };
            
            html5QrCodeVerifier.start({ facingMode: "environment" }, config, onScanSuccessVerify, (eM) => {})
            .then(() => scannerVerifierActive = true)
            .catch(err => {
                showToast(`Error al iniciar escáner: ${err.message || err}`, 'error');
                DOM.displays.scannerContainerVerify.classList.add('hidden');
                DOM.buttons.startScanVerify.textContent = '📷 Escanear UPC';
                scannerVerifierActive = false;
            });
        }
    }

    function compareListsAndDisplayResults(){
        coincidencias.clear();
        listaVerificar.forEach(idItemToVerify => { 
            if(listaFoco.has(idItemToVerify)) {
                coincidencias.set(idItemToVerify, listaFoco.get(idItemToVerify));
            }
        });
        displayFinalResults();
    }
    
    function displayFinalResults() {
        DOM.stats.totalFoco.textContent = listaFoco.size;
        DOM.stats.totalVerify.textContent = listaVerificar.size;
        DOM.stats.totalMatches.textContent = coincidencias.size;

        DOM.displays.outputResults.innerHTML = '';
        DOM.displays.outputResults.className = 'list'; 

        if (coincidencias.size === 0) { 
            DOM.displays.outputResults.innerHTML = '<p>No se encontraron Ítems concordantes.</p>';
            return;
        }

        const fragment = document.createDocumentFragment();
        const groupedForDisplay = new Map();
        const itemsHandledBySpecificContainer = new Set();

        datosVerificacionCargados.forEach(uploadedItem => {
            if (coincidencias.has(uploadedItem.idItem)) {
                const masterDetails = coincidencias.get(uploadedItem.idItem);
                let contenedoraKey;
                if (uploadedItem.isSuitableForGroupedReport && uploadedItem.contenedora && 
                    uploadedItem.contenedora.trim() !== '' && !uploadedItem.contenedora.startsWith('N/A_')) {
                    contenedoraKey = uploadedItem.contenedora.trim();
                    itemsHandledBySpecificContainer.add(uploadedItem.idItem); 
                } else {
                    contenedoraKey = "Ítems Concordantes (Otros/Sin Contenedora Específica)";
                }

                if (!groupedForDisplay.has(contenedoraKey)) {
                    groupedForDisplay.set(contenedoraKey, []);
                }
                groupedForDisplay.get(contenedoraKey).push({
                    ...masterDetails, 
                    cantidadOriginal: uploadedItem.cantidad, 
                    isFromSpecificContainerContext: (contenedoraKey !== "Ítems Concordantes (Otros/Sin Contenedora Específica)") 
                });
            }
        });

        coincidencias.forEach(masterItem => {
            if (!itemsHandledBySpecificContainer.has(masterItem.codigo)) {
                const defaultGroupKey = "Ítems Concordantes (Otros/Sin Contenedora Específica)";
                if (!groupedForDisplay.has(defaultGroupKey)) {
                    groupedForDisplay.set(defaultGroupKey, []);
                }
                if (!groupedForDisplay.get(defaultGroupKey).some(existing => existing.codigo === masterItem.codigo)) {
                    groupedForDisplay.get(defaultGroupKey).push({ 
                        ...masterItem, 
                        cantidadOriginal: null, 
                        isFromSpecificContainerContext: false 
                    });
                }
            }
        });
        
        if (groupedForDisplay.size === 0 && coincidencias.size > 0) { 
             coincidencias.forEach(masterItem => {
                const defaultGroupKey = "Ítems Concordantes (Otros/Sin Contenedora Específica)";
                 if (!groupedForDisplay.has(defaultGroupKey)) groupedForDisplay.set(defaultGroupKey, []);
                 if (!groupedForDisplay.get(defaultGroupKey).some(ex => ex.codigo === masterItem.codigo)) {
                    groupedForDisplay.get(defaultGroupKey).push({ ...masterItem, cantidadOriginal: null, isFromSpecificContainerContext: false });
                 }
             });
        }

        if (groupedForDisplay.size === 0) { 
             DOM.displays.outputResults.innerHTML='<p>No hay ítems concordantes para mostrar después de agrupar.</p>';
             return;
        }

        const sortedContenedoraKeys = Array.from(groupedForDisplay.keys()).sort((a, b) => {
            const defaultKey = "Ítems Concordantes (Otros/Sin Contenedora Específica)";
            if (a === defaultKey && b !== defaultKey) return 1;
            if (a !== defaultKey && b === defaultKey) return -1;
            return a.localeCompare(b);
        });

        sortedContenedoraKeys.forEach(contenedora => {
            const itemsArray = groupedForDisplay.get(contenedora);
            const uniqueItemsInGroup = itemsArray.filter((item, index, self) => 
                index === self.findIndex((t) => t.codigo === item.codigo && t.cantidadOriginal === item.cantidadOriginal)
            );

            if (uniqueItemsInGroup.length === 0) return; 

            const contenedoraHeader = document.createElement('h4');
            contenedoraHeader.textContent = `${contenedora} (${uniqueItemsInGroup.length} ítem(s) únicos)`; 
            contenedoraHeader.style.marginTop = "20px";
            contenedoraHeader.style.borderBottom = "1px solid #ccc";
            fragment.appendChild(contenedoraHeader);

            uniqueItemsInGroup.forEach(item => {
                const cD = document.createElement("div");
                cD.className = "barcode-item-container";
                cD.dataset.iditem = item.codigo;
                const descText = item.descripcion ? `<p class="barcode-item-desc">${item.descripcion}</p>` : '';
                const brandText = `<p style="font-size:0.8em;text-align:center;color:#777;">Marca: ${item.brand??'N/A'}</p>`;
                const cantidadText = (typeof item.cantidadOriginal === 'number' && item.cantidadOriginal !== null && item.isFromSpecificContainerContext) ? `<p style="font-size:0.9em;text-align:center;font-weight:bold;">Cantidad: ${item.cantidadOriginal}</p>` : '';

                cD.innerHTML = `<p class="barcode-item-code">${item.codigo}</p>${descText}${brandText}${cantidadText}<div class="barcode-item-svg"></div>`;
                const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
                try { JsBarcode(svg, item.codigo, {format:"CODE128",width:2,height:50,displayValue:false,margin:5}); cD.querySelector('.barcode-item-svg').appendChild(svg); }
                catch(e) { cD.querySelector('.barcode-item-svg').innerHTML=`<p style="color:red;font-size:0.8em;">Error BC</p>`; }
                fragment.appendChild(cD);
            });
        });
        DOM.displays.outputResults.appendChild(fragment);
        setResultsLayoutByDevice(); // <-- Ajusta la vista automáticamente al mostrar resultados
    }
    
    // Updated openItemDetailModal function
    function openItemDetailModal(idItem) {
        const item = listaFoco.get(idItem) ?? coincidencias.get(idItem); // Check both maps
        if (item) {
            DOM.modal.codigo.textContent = "ID Ítem: " + (item.codigo || 'N/A');
            DOM.modal.descripcion.textContent = item.descripcion || 'No disponible';
            DOM.modal.upc.textContent = item.upc || 'No disponible'; 
            DOM.modal.brand.textContent = item.brand || 'No disponible';
            DOM.modal.department.textContent = item.department || 'No disponible'; 
            DOM.modal.uom.textContent = item.uom || 'No disponible';   
            
            // Clear previous barcode
            DOM.modal.barcodeSvgContainer.innerHTML = ''; 

            // Generate and display barcode if item.codigo exists and is valid for barcode
            if (item.codigo && String(item.codigo).trim().length > 0) {
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                try {
                    JsBarcode(svg, String(item.codigo), {
                        format: "CODE128", // Or other format like EAN13 if UPC is used
                        width: 2,
                        height: 50,
                        displayValue: true, // Show the code below the barcode
                        margin: 10
                    });
                    DOM.modal.barcodeSvgContainer.appendChild(svg);
                } catch (e) {
                    DOM.modal.barcodeSvgContainer.innerHTML = `<p style="color:red; font-size:0.8em;">Error al generar código de barras: ${e.message}</p>`;
                }
            } else {
                DOM.modal.barcodeSvgContainer.innerHTML = '<p style="color:#777; font-size:0.9em;">Código de barras no disponible (ID de ítem vacío).</p>';
            }

            const imageUrl = item.url?.trim(); 
            if (imageUrl) {
                // Añadimos un parámetro único para evitar problemas de caché del navegador
                const cacheBustedUrl = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                DOM.modal.image.src = cacheBustedUrl;
                DOM.modal.image.alt = "Imagen de " + (item.descripcion || item.codigo || 'ítem');
                DOM.modal.image.style.display = 'block'; 
                DOM.modal.imageError.style.display = 'none';
            } else {
                DOM.modal.image.style.display = 'none'; 
                DOM.modal.image.src = '#'; // Clear src to prevent broken image icon
                DOM.modal.imageError.textContent = 'URL de imagen no especificada o no válida.'; 
                DOM.modal.imageError.style.display = 'block';
            }
            navigateToView('itemDetailModal'); // Now uses navigateToView for display:flex
        } else {
            showToast("Ítem no encontrado para mostrar detalles.", 'error');
        }
    }

    function closeItemDetailModal() {
        DOM.views.itemDetailModal.style.display = 'none';
        DOM.modal.image.src="#"; // Clear image source
        DOM.modal.barcodeSvgContainer.innerHTML = ''; // Clear barcode
    }

    function handleIniciarDobleControl() {
        if (listaFoco.size === 0) { showToast("No hay Lista Maestra cargada. Por favor, carga o sincroniza una maestra.", 'warning'); return; }
        listaVerificar.clear(); datosVerificacionCargados = []; coincidencias.clear();
        DOM.inputs.verifyTextarea.value = ''; DOM.inputs.scannedCodesVerifyTextarea.value = '';
        resetFileInput(DOM.inputs.verifyFileTxtCsv); resetFileInput(DOM.inputs.verifyFileExcel);
        updateVerifyPreview();
        navigateToView('dobleControlStep');
    }

    function handleBorrarStorage() {
        if (confirm("¿Borrar Maestra local y resincronizar? Esto eliminará la versión local y buscará la última del repositorio.")) {
            localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
            listaFoco.clear(); listaFocoCacheadaLocalmente.clear(); upcToCodigoMap.clear();
            showToast("Maestra local borrada. Resincronizando desde repositorio...", 'info');
            checkInitialState(); 
        }
    }

    function handleCompare() {
        collectVerifyDataFromInputs(); 
        if (listaVerificar.size === 0) { showToast("Cargue o escanee Ítems para la Lista de Verificación.", 'warning'); return; }
        if (listaFoco.size === 0) { showToast("Lista Maestra vacía. Sincronice o cargue una localmente.", 'error'); navigateToView('panelInicio'); return; }
        compareListsAndDisplayResults();
        navigateToView('resultadosStep');
    }

    function toggleResultsLayout(){
        DOM.displays.outputResults.classList.toggle('grid');
        DOM.displays.outputResults.classList.toggle('list');
        DOM.buttons.layoutToggle.textContent = DOM.displays.outputResults.classList.contains('grid') ? '📊 Vista Lista' : '📊 Vista Cuadrícula';
    }

    function setResultsLayoutByDevice() {
        const isMobile = /android|iphone|ipad|ipod|opera mini|iemobile|mobile/i.test(navigator.userAgent);
        if (isMobile) {
            DOM.displays.outputResults.classList.remove('grid');
            DOM.displays.outputResults.classList.add('list');
            DOM.buttons.layoutToggle.textContent = '📊 Vista Cuadrícula';
        } else {
            DOM.displays.outputResults.classList.remove('list');
            DOM.displays.outputResults.classList.add('grid');
            DOM.buttons.layoutToggle.textContent = '📊 Vista Lista';
        }
    }

    function downloadCsvResults(){
        if(coincidencias.size===0){showToast("No hay Ítems concordantes para exportar.", 'warning');return;}
        let csvContent="ID_Item,Departamento,UPC,Descripcion,Marca,URL_Imagen,UOM_Maestra\n"; 
        coincidencias.forEach(item=>{ 
            const esc = (v) => `"${(v??'').replace(/"/g,'""')}"`;
            csvContent+=`${esc(item.codigo)},${esc(item.department)},${esc(item.upc)},${esc(item.descripcion)},${esc(item.brand)},${esc(item.url)},${esc(item.uom)}\n`;
        });
        const blob = new Blob(["\uFEFF"+csvContent],{type:'text/csv;charset=utf-8;'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `concordancias_sdci_${new Date().toISOString().slice(0,10)}.csv`;
        link.click(); URL.revokeObjectURL(link.href);
        showToast("CSV de concordancias descargado.", 'success');
    }

    async function downloadXlsxResults() {
        // Verifica si hay ítems concordantes O ítems con cantidad >= 100 en datosVerificacionCargados
        const hasHighQuantityItems = datosVerificacionCargados.some(item => item.cantidad >= 100 && !coincidencias.has(item.idItem));
        if (coincidencias.size === 0 && !hasHighQuantityItems) {
            showToast("No hay Ítems concordantes ni ítems con cantidad >= 100 (no en maestra) para exportar a XLSX.", 'warning');
            return;
        }

        const btn = DOM.buttons.downloadXlsx;
        const originalText = btn.textContent;
        btn.textContent = 'Generando XLSX...';
        btn.disabled = true;

        try {
            const groupedForXLSX = new Map();
            const itemsHandledBySpecificContainer = new Set();

            // 1. Ítems concordantes agrupados por contenedora
            datosVerificacionCargados.forEach(uploadedItem => {
                if (coincidencias.has(uploadedItem.idItem)) {
                    const masterDetails = coincidencias.get(uploadedItem.idItem);
                    let contenedoraKey;
                    if (uploadedItem.isSuitableForGroupedReport && uploadedItem.contenedora &&
                        uploadedItem.contenedora.trim() !== '' && !uploadedItem.contenedora.startsWith('N/A_')) {
                        contenedoraKey = uploadedItem.contenedora.trim();
                        itemsHandledBySpecificContainer.add(uploadedItem.idItem);
                    } else {
                        contenedoraKey = "Ítems Concordantes (Otros/Sin Contenedora Específica)";
                    }
                    if (!groupedForXLSX.has(contenedoraKey)) groupedForXLSX.set(contenedoraKey, []);
                    groupedForXLSX.get(contenedoraKey).push({
                        ...masterDetails,
                        cantidadCargada: (typeof uploadedItem.cantidad === 'number') ? uploadedItem.cantidad : 'N/A',
                        status: "Concordante",
                        _originalUploadedItemContext: { contenedora: uploadedItem.contenedora, cantidad: uploadedItem.cantidad }
                    });
                }
            });

            // 2. Ítems concordantes no provenientes de archivo con contenedora específica
            coincidencias.forEach((masterItem, itemCodigo) => {
                if (!itemsHandledBySpecificContainer.has(itemCodigo)) {
                    const defaultGroupKey = "Ítems Concordantes (Otros/Sin Contenedora Específica)";
                    if (!groupedForXLSX.has(defaultGroupKey)) groupedForXLSX.set(defaultGroupKey, []);
                    if (!groupedForXLSX.get(defaultGroupKey).some(item => item.codigo === itemCodigo && item.status === "Concordante")) {
                        groupedForXLSX.get(defaultGroupKey).push({
                            ...masterItem,
                            cantidadCargada: 'N/A',
                            status: "Concordante"
                        });
                    }
                }
            });

            // 3. Ítems con cantidad >= 100 que NO están en la maestra
            datosVerificacionCargados.forEach(uploadedItem => {
                if (uploadedItem.cantidad >= 100 && !coincidencias.has(uploadedItem.idItem)) {
                    let contenedoraKey = (uploadedItem.isSuitableForGroupedReport && uploadedItem.contenedora &&
                        uploadedItem.contenedora.trim() !== '' && !uploadedItem.contenedora.startsWith('N/A_'))
                        ? uploadedItem.contenedora.trim()
                        : "Ítems Adicionales por Cantidad (Cont. Diversas)";

                    if (!groupedForXLSX.has(contenedoraKey)) groupedForXLSX.set(contenedoraKey, []);

                    const descFromUpload = uploadedItem.allRowData?.descripcion || uploadedItem.allRowData?.descripción || uploadedItem.allRowData?.description || "N/A (No en Maestra)";
                    const brandFromUpload = uploadedItem.allRowData?.marca || uploadedItem.allRowData?.brand || "N/A (No en Maestra)";

                    // Evita duplicados
                    const itemExistsCheckKey = `${uploadedItem.idItem}-${uploadedItem.cantidad}-${uploadedItem.contenedora}`;
                    let alreadyExists = groupedForXLSX.get(contenedoraKey).find(it =>
                        `${it.codigo}-${it.cantidadCargada}-${it.status === "No en Maestra (Cant. >= 100)" ? 'no_orig_cont' : it._originalUploadedItemContext?.contenedora}` === itemExistsCheckKey &&
                        it.status === "No en Maestra (Cant. >= 100)"
                    );
                    if (!alreadyExists) {
                        groupedForXLSX.get(contenedoraKey).push({
                            codigo: uploadedItem.idItem,
                            descripcion: descFromUpload,
                            brand: brandFromUpload,
                            upc: "N/A",
                            url: "N/A",
                            cantidadCargada: uploadedItem.cantidad,
                            status: "No en Maestra (Cant. >= 100)",
                            _originalUploadedItemContext: { contenedora: uploadedItem.contenedora, cantidad: uploadedItem.cantidad }
                        });
                    }
                }
            });

            // --- Generación del XLSX ---
            const dataForSheet = [];
            const mainTitleQuery = document.querySelector('.container > h1');
            const reportTitle = mainTitleQuery ? mainTitleQuery.innerText : "Sistema de Doble Control de Ítems";
            const currentDateFormatted = new Date().toLocaleDateString("es-CL", { year: 'numeric', month: 'long', day: 'numeric' });

            dataForSheet.push([reportTitle]);
            dataForSheet.push(["Informe de Verificación: Ítems por Contenedora"]);
            dataForSheet.push([`Fecha de Generación: ${currentDateFormatted}`]);
            dataForSheet.push([]);

            const merges = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } },
                { s: { r: 1, c: 0 }, e: { r: 1, c: 1 } },
                { s: { r: 2, c: 0 }, e: { r: 2, c: 1 } }
            ];
            let currentRow = 4;

            const sortedContenedoraKeys = Array.from(groupedForXLSX.keys()).sort((a, b) => {
                const defaultKey1 = "Ítems Concordantes (Otros/Sin Contenedora Específica)";
                const defaultKey2 = "Ítems Adicionales por Cantidad (Cont. Diversas)";
                const aIsDefault = (a === defaultKey1 || a === defaultKey2);
                const bIsDefault = (b === defaultKey1 || b === defaultKey2);

                if (aIsDefault && !bIsDefault) return 1;
                if (!aIsDefault && bIsDefault) return -1;
                if (a === defaultKey2 && b === defaultKey1) return 1;
                if (a === defaultKey1 && b === defaultKey2) return -1;
                return a.localeCompare(b);
            });

            sortedContenedoraKeys.forEach(contenedora => {
                const itemsInContenedora = groupedForXLSX.get(contenedora);
                if (!itemsInContenedora || itemsInContenedora.length === 0) return;

                const uniqueItemsForXLSXInGroup = [];
                const seenInThisGroup = new Set();
                itemsInContenedora.forEach(item => {
                    const itemKey = `${item.codigo}-${item.cantidadCargada}-${item.status || 'concordante'}-${item._originalUploadedItemContext?.contenedora || 'no_orig_cont'}`;
                    if (!seenInThisGroup.has(itemKey)) {
                        uniqueItemsForXLSXInGroup.push(item);
                        seenInThisGroup.add(itemKey);
                    }
                });

                dataForSheet.push([`Contenedora: ${contenedora} (${uniqueItemsForXLSXInGroup.length} ítem(s))`]);
                merges.push({ s: { r: currentRow, c: 0 }, e: { r: currentRow, c: 1 } });
                currentRow++;

                uniqueItemsForXLSXInGroup.forEach(item => {
                    let displayId = item.codigo || 'N/A';
                    if (item.status === "No en Maestra (Cant. >= 100)") {
                        displayId += " (No en Maestra)";
                    }
                    dataForSheet.push(["ID Ítem:", displayId]); currentRow++;
                    dataForSheet.push(["Descripción:", item.descripcion || 'N/A']); currentRow++;
                    dataForSheet.push(["Marca:", item.brand || 'N/A']); currentRow++;
                    dataForSheet.push(["Cantidad (Info. Carga):", item.cantidadCargada !== undefined ? item.cantidadCargada : 'N/A']); currentRow++;
                    dataForSheet.push(["Revisado:", "☐ " + "_".repeat(40) + " (Firma/Obs)"]); currentRow++;
                    dataForSheet.push(["Diferencias Encontradas:", "_".repeat(50)]); currentRow++;
                    dataForSheet.push(["Notas Adicionales:", "_".repeat(50)]); currentRow++;
                    dataForSheet.push([]); currentRow++;
                });
            });

            // --- Firma ---
            dataForSheet.push([], [], [], []);
            const signatureRow = [
                null, null,
                "___________________________", null, null,
                "___________________________"
            ];
            const signatureLabelRow = [
                null, null,
                "Firma Responsable", null, null,
                "Nombre y Cargo"
            ];
            dataForSheet.push(signatureRow, signatureLabelRow);
            merges.push({ s: { r: currentRow + 4, c: 2 }, e: { r: currentRow + 4, c: 4 } });
            merges.push({ s: { r: currentRow + 5, c: 2 }, e: { r: currentRow + 5, c: 4 } });
            merges.push({ s: { r: currentRow + 4, c: 5 }, e: { r: currentRow + 4, c: 7 } });
            merges.push({ s: { r: currentRow + 5, c: 5 }, e: { r: currentRow + 5, c: 7 } });

            // --- Crear y descargar XLSX ---
            const ws = XLSX.utils.aoa_to_sheet(dataForSheet);
            ws['!merges'] = merges;
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Informe de Control");
            XLSX.writeFile(wb, `Informe_Doble_Control_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showToast("Informe XLSX descargado con éxito.", 'success');
        } catch (error) {
            console.error('Error al generar XLSX:', error);
            showToast(`Error al generar XLSX: ${error.message}`, 'error');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function handleNewVerification() {
        if (confirm("¿Deseas iniciar un nuevo Doble Control? Se borrarán los datos actuales de verificación.")) {
            listaVerificar.clear();
            datosVerificacionCargados = [];
            coincidencias.clear();
            DOM.inputs.verifyTextarea.value = '';
            DOM.inputs.scannedCodesVerifyTextarea.value = '';
            resetFileInput(DOM.inputs.verifyFileTxtCsv);
            resetFileInput(DOM.inputs.verifyFileExcel);
            updateVerifyPreview();
            if (scannerVerifierActive && html5QrCodeVerifier?.isScanning) {
                html5QrCodeVerifier.stop().then(() => {
                    scannerVerifierActive = false;
                    DOM.displays.scannerContainerVerify.classList.add('hidden');
                    DOM.buttons.startScanVerify.textContent = '📷 Escanear UPC';
                }).catch(err => console.error("Error deteniendo escáner:", err));
            }
            showToast("Nueva verificación iniciada. Datos anteriores borrados.", 'info');
            navigateToView('dobleControlStep');
            setResultsLayoutByDevice(); // <-- Ajusta la vista automáticamente
        }
    }
  </script>
</body>
</html>