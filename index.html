<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Doble Control de √çtems v2.8.9 (REFACORIZADO)</title>
  <style>
    /* Estilos CSS Generales (de la v2.8.8 y mejoras) */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 15px;
      background-color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h1, h2, h3 {
      color: #2c3e50;
      text-align: center;
    }
    h1 { margin-bottom: 30px; font-size: 1.8em;}
    h2 { margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.5em;}
    h3 { margin-bottom: 15px; font-size: 1.2em; text-align: left;}

    .section {
      border: 1px solid #e0e0e0;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      background-color: #fdfdfd;
    }
    .hidden { display: none !important; }
    .panel-inicio-info {
        font-size: 1.1em;
        color: #27ae60;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #e8f8f0;
        border-left: 5px solid #27ae60;
        border-radius: 4px;
    }
    .panel-inicio-info.warning { color: #f39c12; background-color: #fef9e7; border-left-color: #f39c12;}
    .panel-inicio-info.error { color: #c0392b; background-color: #fdedec; border-left-color: #c0392b;}
    .panel-inicio-info.info { color: #2980b9; background-color: #eaf2f8; border-left-color: #2980b9;}
    .panel-inicio-actions button { margin-top: 10px; width: 100%; box-sizing: border-box; padding: 12px;}

    .input-group { margin-bottom: 20px; }
    .input-group label, .file-options label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 0.95em;
    }
    textarea, input[type="file"], select, input[type="text"], input[type="search"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    textarea { min-height: 100px; }
    .file-options { border: 1px solid #ddd; padding: 15px; margin-top: -10px; margin-bottom:15px; border-radius: 0 0 4px 4px; background-color: #f9f9f9;}
    .input-columns { display: flex; gap: 15px; align-items: flex-end; }
    .input-columns > div { flex: 1; }
    .input-columns input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle;}

    button {
      background-color: #3498db;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      margin-right: 8px;
      margin-top: 5px;
    }
    button:hover { background-color: #2980b9; }
    button.secondary { background-color: #95a5a6; }
    button.secondary:hover { background-color: #7f8c8d; }
    button.danger { background-color: #e74c3c; }
    button.danger:hover { background-color: #c0392b; }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

    .preview-area, .search-results-area {
      background-color: #ecf0f1;
      border: 1px dashed #bdc3c7;
      padding: 12px;
      min-height: 60px;
      margin-top:10px;
      font-size: 0.9em;
      border-radius: 4px;
      word-break: break-word;
    }
    #focoPreview ul { list-style-type: none; padding-left: 0; }
    #focoPreview li { margin-bottom: 5px; font-size: 0.95em; }
    #focoPreview strong { color: #34495e; }

    .search-results-area { max-height: 200px; overflow-y: auto; }
    .preview-item, .search-result-item {
        padding: 6px 3px;
        border-bottom: 1px solid #dde;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    .preview-item:last-child, .search-result-item:last-child { border-bottom: none; }
    .preview-item .code, .search-result-item .code { font-weight: bold; color: #34495e; flex-shrink: 0; margin-right: 10px;}
    .preview-item .desc, .search-result-item .desc { color: #7f8c8d; margin-left: 10px; font-style: italic; text-align: right; flex-grow: 1; }
    .preview-item .upc-brand-url, .search-result-item .upc-brand-url { font-size: 0.85em; color: #555; margin-left: 10px; }

    .results-summary {
      margin-bottom: 25px;
      background-color: #eaf5ff;
      padding: 18px;
      border-radius: 6px;
      border: 1px solid #c1d9ed;
    }
    .results-summary p { margin: 8px 0; font-size: 1.05em; }
    .results-summary strong { color: #2980b9; }

    #confirmacionCambiosStep .preview-area { max-height: 120px; margin-bottom: 10px; background-color: #fff; overflow-y: auto;}
    #confirmacionCambiosStep h3 { font-size: 1.1em; margin-bottom:5px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    #confirmacionCambiosStep li { font-size: 0.9em; padding: 3px 0; border-bottom: 1px dotted #eee; }
    #confirmacionCambiosStep li:last-child { border-bottom: none; }
    #confirmacionCambiosStep li s { color: #e74c3c; }
    #confirmacionCambiosStep li .field-change { display: block; margin-left: 15px; font-size: 0.9em;}

    #outputResults.list .barcode-item-container { margin: 10px 0; background: #fff; padding:12px; border:1px solid #e0e0e0; border-radius:5px; cursor: pointer;}
    #outputResults.grid .barcode-item-container { background: #fff; padding:12px; border:1px solid #e0e0e0; border-radius:5px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; cursor: pointer;}
    #outputResults.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }

    .barcode-item-code { font-weight: bold; text-align: center; margin-bottom: 4px; font-size: 1em; color: #333; }
    .barcode-item-desc { text-align: center; margin-bottom: 6px; font-size: 0.9em; color: #555; font-style: italic; }
    .barcode-item-svg svg { max-width: 100%; height: auto; display: block; margin: 0 auto;}

    #itemDetailModal {
      position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.5); display: none;
      align-items: center; justify-content: center;
    }
    #itemDetailModal .modal-content {
      background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888;
      width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center;
      position: relative;
    }
    #itemDetailModal .modal-content h3 { margin-top: 0; color: #3498db; }
    #itemDetailModal .modal-content p { margin: 8px 0; font-size: 1.1em; text-align: left;}
    #itemDetailModal .modal-content strong { color: #555;}
    #itemDetailModal #modalItemImageContainer { margin-top: 15px; margin-bottom: 15px; min-height: 50px; }
    #itemDetailModal #modalItemImage { max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; object-fit: contain; }
    #itemDetailModal .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; }
    #itemDetailModal .close-modal:hover, #itemDetailModal .close-modal:focus { color: black; text-decoration: none; }

    #scannerContainerVerify { max-width: 400px; margin: 15px auto; border: 1px solid #ccc; padding: 5px; border-radius: 4px;}
    #readerVerify { width: 100%; }

    footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      font-size: 0.9em;
      color: #777;
      border-top: 1px solid #eee;
    }

    /* Estilos para la exportaci√≥n a PDF (Formato Ficha Detallada / Carta) */
    .pdf-export-container {
        font-family: Arial, sans-serif;
        color: #333;
    }
    .pdf-export-container .main-document-title { /* H1 general del sistema */
        text-align: center;
        font-size: 18pt;
        font-weight: bold;
        margin-bottom: 8mm;
    }
    .pdf-export-container .report-title { /* T√≠tulo del reporte "Reporte de Verificaci√≥n..." */
        text-align: center;
        font-size: 16pt;
        font-weight: bold;
        margin-bottom: 3mm;
    }
    .pdf-export-container .report-date { /* "Fecha de Generaci√≥n: ..." */
        text-align: center;
        font-size: 10pt;
        margin-bottom: 10mm;
    }

    .pdf-item-ficha {
        border: 1px solid #b0b0b0;
        padding: 5mm;
        margin-bottom: 7mm;
        border-radius: 3px;
        background-color: #fff;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
    }
    .pdf-item-ficha .pdf-item-field {
        display: flex;
        margin-bottom: 3mm;
        font-size: 10pt;
        line-height: 1.4;
        align-items: flex-start;
    }
    .pdf-item-ficha .pdf-item-label {
        font-weight: bold;
        width: 95px;
        min-width: 95px;
        margin-right: 5px;
        flex-shrink: 0;
    }
    .pdf-item-ficha .pdf-item-value {
        flex-grow: 1;
        word-break: break-word;
    }
    .pdf-item-ficha .revisado-field .pdf-item-value,
    .pdf-item-ficha .diferencias-field .pdf-item-value,
    .pdf-item-ficha .diferencias-field-extra .pdf-item-value {
        font-family: 'Courier New', Courier, monospace;
        white-space: pre;
        letter-spacing: 0.5px;
        border-bottom: 0.5px solid #555;
        min-height: 1.2em;
        padding-bottom: 1px; /* Peque√±o espacio para que la l√≠nea no toque el texto */
    }
    .pdf-item-ficha .diferencias-field-extra .pdf-item-label {
        visibility: hidden;
    }

    .pdf-item-barcode-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 5mm; /* Espacio desde los otros campos */
        margin-bottom: 3mm; /* Espacio antes de los campos de revisi√≥n */
    }

    .pdf-item-barcode-svg svg {
        max-width: 90%; /* Para que no ocupe todo el ancho de la ficha */
        height: 25mm;   /* Altura fija para el c√≥digo de barras */
        display: block;
        margin: 0 auto; /* Centrar el SVG */
    }

    .pdf-export-container button { /* Ocultar botones dentro del contenido para PDF */
        display: none !important;
    }

    /* Estilos para @media print, si html2pdf usa modo 'css' y los recoge */
    @media print {
      .barcode-item-container, .pdf-item-ficha { /* Aplicar a ambos por si acaso */
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      .no-print-pdf { /* Clase gen√©rica para ocultar en impresi√≥n/PDF */
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sistema de Doble Control de √çtems v2.8.9 (REFACORIZADO)</h1>

    <div id="panelInicio" class="section">
      <h2>Panel de Inicio</h2>
      <div id="panelInicioInfo" class="panel-inicio-info info">
        Cargando informaci√≥n de Lista Maestra desde el repositorio...
      </div>
      <div class="panel-inicio-actions">
        <button id="btnIniciarDobleControlDesdePanel" disabled>‚û°Ô∏è Iniciar Doble Control</button>
        <button id="btnGestionMaestraDesdePanel" class="secondary" disabled>üîé Ver Lista Maestra y Buscar</button>
        <button id="btnBorrarMaestraStorage" class="danger secondary" style="margin-top: 20px;">üóëÔ∏è Borrar Maestra Local y Resincronizar</button>
      </div>
    </div>

    <div id="confirmacionCambiosStep" class="section hidden">
      <h2>Confirmar Cambios de Lista Maestra (desde Repositorio)</h2>
      <p>Se han detectado los siguientes cambios respecto a tu lista local guardada:</p>
      <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
          <div id="resumenNuevos"><h3>Nuevos √çtems:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenEliminados"><h3>√çtems Eliminados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
          <div id="resumenModificados"><h3>√çtems Modificados:</h3><ul class="preview-area"><li>Cargando...</li></ul></div>
      </div>
      <p>¬øDeseas aplicar estos cambios y usar la versi√≥n del repositorio en tu sesi√≥n actual?</p>
      <div style="text-align: center;">
        <button id="btnConfirmarCambiosRepositorio">S√≠, Aplicar Cambios del Repositorio</button>
        <button id="btnRechazarCambiosRepositorio" class="secondary">No, Mantener Mi Versi√≥n Local</button>
      </div>
    </div>

    <div id="gestionMaestraStep" class="section hidden">
      <h2>Ver Lista Maestra y Buscar</h2>
      <div class="input-group">
        <label for="searchFocoInput">Buscar √çtem (por ID, UPC, descripci√≥n, marca o URL de imagen):</label>
        <input type="text" id="searchFocoInput" placeholder="Ingrese t√©rmino de b√∫squeda...">
      </div>
      <div id="focoSearchResults" class="search-results-area" style="margin-bottom: 20px;">Resultados de la b√∫squeda aparecer√°n aqu√≠...</div>

      <div id="focoPreview" class="preview-area">
        <h3>Estad√≠sticas de la Lista Maestra</h3>
        <ul id="masterListStats">
            <li>Total de √çtems: <strong id="statTotalItems">0</strong></li>
            <li>√çtems sin URL de imagen: <strong id="statNoImageUrl">0</strong></li>
            <li>√çtems sin UPC: <strong id="statNoUpc">0</strong></li>
            <li>√çtems sin Descripci√≥n: <strong id="statNoDescription">0</strong></li>
            <li>√çtems sin Marca: <strong id="statNoBrand">0</strong></li>
        </ul>
        <p style="font-size:0.8em; margin-top:15px; text-align:center;">
            Utiliza la barra de b√∫squeda de arriba para encontrar √≠tems espec√≠ficos.
        </p>
      </div>

      <div style="margin-top:20px; text-align:center;">
        <button id="btnVolverAlPanelDesdeGestion" class="secondary">‚Ü©Ô∏è Volver al Panel de Inicio</button>
      </div>
    </div>

    <div id="dobleControlStep" class="section hidden">
      <h2>Paso 2: Cargar Lista de √çtems para Doble Control</h2>
      <p style="font-size:0.9em; color: #555;">
        Puede escanear el UPC del art√≠culo f√≠sico (si su Lista Maestra contiene UPCs) o ingresar el ID del √çtem.
        Solo se considerar√°n IDs de √çtem **num√©ricos de m√°s de 5 d√≠gitos**.
      </p>
       <p style="font-size:0.85em; color:#c0392b; background-color: #fdedec; padding: 5px; border-left: 3px solid #c0392b;">
        Para el reporte XLSX agrupado por contenedora, suba un archivo Excel (.xlsx) con encabezados: `item_`, `contenedoras`, `cantidad`.
      </p>
      <div class="input-group">
        <label for="verifyTextarea">Pegar IDs de √çtem a verificar (uno por l√≠nea o separados por espacio/tabulador):</label>
        <textarea id="verifyTextarea" rows="5" inputmode="numeric"></textarea>
      </div>
       <div class="input-group">
        <label>Subir archivo con IDs de √çtem a verificar:</label>
        <p style="font-size:0.85em; color:#666;">Se tomar√°n los IDs de √çtem de la columna especificada. Para el reporte agrupado, use Excel con las columnas indicadas arriba.</p>
        <div class="input-columns">
            <div><label for="verifyFileTxtCsv" style="font-size:0.9em;">Texto (.txt, .csv):</label><input type="file" id="verifyFileTxtCsv" accept=".txt,.csv"></div>
            <div><label for="verifyFileExcel" style="font-size:0.9em;">Excel (.xlsx, .xls):</label><input type="file" id="verifyFileExcel" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"></div>
        </div>
        <div class="file-options">
            <div class="input-columns">
                <div><label for="verifyCodigoCol">Col. ID √çtem (ej: 1 o por header 'item_'):</label><input type="number" id="verifyCodigoCol" value="1" min="1"></div>
                 <div><label for="verifyCsvDelimiter">Delimitador CSV:</label><input type="text" id="verifyCsvDelimiter" value=","></div>
            </div>
             <label><input type="checkbox" id="verifyHasHeader" checked> El archivo tiene encabezados</label>
        </div>
      </div>
      <div class="input-group">
        <button id="startScanVerifyBtn">üì∑ Escanear UPC de Art√≠culo</button>
        <div id="scannerContainerVerify" class="hidden"><div id="readerVerify"></div></div>
        <label for="scannedCodesVerifyTextarea" style="margin-top:10px;">IDs de √çtem v√°lidos identificados (desde UPC escaneado o ingresado):</label>
        <textarea id="scannedCodesVerifyTextarea" rows="3" placeholder="Los IDs de √çtem v√°lidos aparecer√°n aqu√≠..." readonly></textarea>
      </div>
      <div id="verifyPreview" class="preview-area">A√∫n no se han cargado √çtems a verificar.</div>
      <hr style="margin: 20px 0;">
      <button id="btnVolverAlPanelDesdeDobleControl" class="secondary">&larr; Volver al Panel de Inicio</button>
      <button id="btnCompare">Verificar y Mostrar √çtems Concordantes &rarr;</button>
    </div>

    <div id="resultadosStep" class="section hidden">
      <h2>Resultados: √çtems Concordantes</h2>
      <div id="resultsSummary" class="results-summary">
        <p>Total √çtems en Lista Maestra: <strong id="totalFoco">0</strong></p>
        <p>Total √çtems en Lista de Verificaci√≥n (v√°lidos): <strong id="totalVerify">0</strong></p>
        <p>√çtems Concordantes Verificados: <strong id="totalMatches">0</strong></p>
      </div>
      <h3>Detalle de √çtems Concordantes (Clic para ver m√°s)</h3>
      <div style="margin-bottom: 15px;">
          <button id="layoutToggleResultsBtn">üìä Cambiar Vista</button>
          <button id="downloadXlsxResultsBtn" class="secondary">üìä Descargar XLSX</button>
          <button id="downloadCsvResultsBtn" class="secondary">üíæ Descargar CSV de Concordancias</button>
          <button id="downloadPdfResultsBtn">üìÑ Generar PDF</button>
      </div>
      <div id="outputResults" class="list"><p>No se han encontrado coincidencias o no se ha realizado la verificaci√≥n.</p></div>
      <hr style="margin: 20px 0;">
      <button id="btnNewVerification">‚ú® Iniciar Nuevo Doble Control</button>
    </div>
  </div>

  <div id="itemDetailModal" class="hidden">
    <div class="modal-content">
      <span class="close-modal" onclick="closeItemDetailModal()">&times;</span>
      <h3 id="modalItemCodigo"></h3>
      <div id="modalItemImageContainer">
        <img id="modalItemImage" src="#" alt="Imagen del √çtem" style="display:none;">
        <p id="modalImageError" style="display:none; color:red;">Imagen no disponible.</p>
      </div>
      <p><strong>Descripci√≥n:</strong> <span id="modalItemDescripcion"></span></p>
      <p><strong>UPC:</strong> <span id="modalItemUPC"></span></p>
      <p><strong>Marca:</strong> <span id="modalItemBrand"></span></p>
    </div>
  </div>

  <footer>
    Sistema de Doble Control de √çtems v2.8.9 - Desarrollado por fgalaz - Chile, 2025
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ----- URL DE LA LISTA MAESTRA EN REPOSITORIO -----
    const URL_LISTA_MAESTRA_REPOSITORIO = 'https://raw.githubusercontent.com/Galaz94/Double_Control/main/maestra.csv';

    // ----- ESTADO DE LA APLICACI√ìN -----
    let listaFoco = new Map();
    let upcToCodigoMap = new Map();
    let listaVerificar = new Set(); // Stores unique, valid item IDs from any source for matching
    let datosVerificacionCargados = []; // Stores richer objects from upload, esp. for Excel {idItem, contenedora, cantidad, allRowData, isSuitableForGroupedReport}
    let coincidencias = new Map();
    const LOCAL_STORAGE_KEY_LISTA_FOCO = 'sDCI_listaFocoGuardada_v2.8.9';
    let listaFocoCacheadaLocalmente = new Map();
    let html5QrCodeVerifier = null;
    let scannerVerifierActive = false;

    const $ = (id) => document.getElementById(id);
    const DOM = {
        views: {
            panelInicio: $('panelInicio'),
            gestionMaestraStep: $('gestionMaestraStep'),
            dobleControlStep: $('dobleControlStep'),
            resultadosStep: $('resultadosStep'),
            confirmacionCambiosStep: $('confirmacionCambiosStep'),
            itemDetailModal: $('itemDetailModal'),
        },
        buttons: {
            iniciarDobleControl: $('btnIniciarDobleControlDesdePanel'),
            gestionMaestra: $('btnGestionMaestraDesdePanel'),
            borrarStorage: $('btnBorrarMaestraStorage'),
            volverDesdeGestion: $('btnVolverAlPanelDesdeGestion'),
            volverDesdeDobleControl: $('btnVolverAlPanelDesdeDobleControl'),
            compare: $('btnCompare'),
            startScanVerify: $('startScanVerifyBtn'),
            layoutToggle: $('layoutToggleResultsBtn'),
            downloadXlsx: $('downloadXlsxResultsBtn'),
            downloadCsv: $('downloadCsvResultsBtn'),
            downloadPdf: $('downloadPdfResultsBtn'),
            newVerification: $('btnNewVerification'),
            confirmarCambios: $('btnConfirmarCambiosRepositorio'),
            rechazarCambios: $('btnRechazarCambiosRepositorio'),
        },
        inputs: {
            searchFoco: $('searchFocoInput'),
            verifyTextarea: $('verifyTextarea'),
            verifyFileTxtCsv: $('verifyFileTxtCsv'),
            verifyFileExcel: $('verifyFileExcel'),
            verifyCodigoCol: $('verifyCodigoCol'),
            verifyCsvDelimiter: $('verifyCsvDelimiter'),
            verifyHasHeader: $('verifyHasHeader'),
            scannedCodesVerifyTextarea: $('scannedCodesVerifyTextarea'),
        },
        displays: {
            panelInicioInfo: $('panelInicioInfo'),
            focoSearchResults: $('focoSearchResults'),
            focoPreview: $('focoPreview'),
            verifyPreview: $('verifyPreview'),
            scannerContainerVerify: $('scannerContainerVerify'),
            readerVerify: $('readerVerify'),
            outputResults: $('outputResults'),
        },
        stats: {
            totalItems: $('statTotalItems'),
            noImageUrl: $('statNoImageUrl'),
            noUpc: $('statNoUpc'),
            noDescription: $('statNoDescription'),
            noBrand: $('statNoBrand'),
            totalFoco: $('totalFoco'),
            totalVerify: $('totalVerify'),
            totalMatches: $('totalMatches'),
        },
        modal: {
            image: $('modalItemImage'),
            imageError: $('modalImageError'),
            codigo: $('modalItemCodigo'),
            descripcion: $('modalItemDescripcion'),
            upc: $('modalItemUPC'),
            brand: $('modalItemBrand'),
        },
        resumenCambios: {
            nuevos: document.querySelector('#resumenNuevos ul'),
            eliminados: document.querySelector('#resumenEliminados ul'),
            modificados: document.querySelector('#resumenModificados ul'),
        }
    };

    // ----- INICIALIZACI√ìN -----
    document.addEventListener('DOMContentLoaded', () => {
        checkInitialState();
        navigateToView('panelInicio');
        addEventListeners();
    });

    function addEventListeners() {
        DOM.views.itemDetailModal.addEventListener('click', (event) => {
            if (event.target === DOM.views.itemDetailModal) closeItemDetailModal();
        });

        DOM.modal.image.onerror = function() {
            this.style.display = 'none';
            DOM.modal.imageError.style.display = 'block';
            DOM.modal.imageError.textContent = 'Error al cargar imagen o URL no v√°lida.';
        };
        DOM.modal.image.onload = function() {
            this.style.display = 'block';
            DOM.modal.imageError.style.display = 'none';
        };

        DOM.buttons.iniciarDobleControl.addEventListener('click', handleIniciarDobleControl);
        DOM.buttons.gestionMaestra.addEventListener('click', () => navigateToView('gestionMaestraStep'));
        DOM.buttons.borrarStorage.addEventListener('click', handleBorrarStorage);

        DOM.inputs.searchFoco.addEventListener('input', () => {
            const searchTerm = DOM.inputs.searchFoco.value.toLowerCase().trim();
            if (!searchTerm) {
                DOM.displays.focoSearchResults.innerHTML = '<p style="text-align:center;">Ingrese un t√©rmino para buscar en la Lista Maestra...</p>';
                return;
            }
            const results = Array.from(listaFoco.values()).filter(item =>
                item.codigo.toLowerCase().includes(searchTerm) ||
                (item.upc && item.upc.toLowerCase().includes(searchTerm)) ||
                (item.descripcion && item.descripcion.toLowerCase().includes(searchTerm)) ||
                (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                (item.url && item.url.toLowerCase().includes(searchTerm))
            );
            updateFocoPreviewAndSearch(results);
        });
        DOM.buttons.volverDesdeGestion.addEventListener('click', () => navigateToView('panelInicio'));

        DOM.inputs.verifyFileTxtCsv.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'textcsv'));
        DOM.inputs.verifyFileExcel.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'excel'));
        DOM.buttons.startScanVerify.addEventListener('click', toggleScanner);
        DOM.buttons.compare.addEventListener('click', handleCompare);
        DOM.buttons.volverDesdeDobleControl.addEventListener('click', () => navigateToView('panelInicio'));

        DOM.buttons.layoutToggle.addEventListener('click', toggleResultsLayout);
        DOM.buttons.downloadCsv.addEventListener('click', downloadCsvResults);
        DOM.buttons.downloadXlsx.addEventListener('click', downloadXlsxResults);
        DOM.buttons.downloadPdf.addEventListener('click', generatePdfReport);
        DOM.buttons.newVerification.addEventListener('click', handleNewVerification);

        DOM.displays.outputResults.addEventListener('click', (event) => {
            const itemContainer = event.target.closest('.barcode-item-container, .search-result-item');
            if (itemContainer) {
                const itemId = itemContainer.dataset.iditem;
                if (itemId) openItemDetailModal(itemId);
            }
        });
        DOM.displays.focoSearchResults.addEventListener('click', (event) => {
            const itemContainer = event.target.closest('.search-result-item');
            if(itemContainer) {
                const itemId = itemContainer.dataset.iditem;
                if(itemId) openItemDetailModal(itemId);
            }
        });
        DOM.buttons.confirmarCambios.addEventListener('click', () => { // Combined from previous to keep listener here
            const maestraRepositorioMap = JSON.parse(DOM.buttons.confirmarCambios.dataset.maestraRepositorio || '{}', (key, value) => {
                if (typeof value === 'object' && value !== null && value.__isMap__) return new Map(value.data);
                return value;
            });
            if (maestraRepositorioMap && maestraRepositorioMap.size > 0) {
                listaFoco = maestraRepositorioMap;
                rebuildUpcToCodigoMap();
                saveListaFocoToStorage();
                updateFocoPreviewAndSearch();
                DOM.displays.panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems) desde el repositorio y guardada localmente.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info';
            } else {
                 DOM.displays.panelInicioInfo.innerHTML = `‚ö†Ô∏è Error al aplicar cambios. Se mantuvo la versi√≥n actual.`;
                 DOM.displays.panelInicioInfo.className = 'panel-inicio-info warning';
            }
            navigateToView('panelInicio');
        });
        DOM.buttons.rechazarCambios.addEventListener('click', () => { // Combined from previous
            rebuildUpcToCodigoMap(); 
            updateFocoPreviewAndSearch();
            DOM.displays.panelInicioInfo.innerHTML = `‚ÑπÔ∏è Cambios del repositorio ignorados. Se mantiene la Maestra local (${listaFoco.size} √≠tems).`;
            DOM.displays.panelInicioInfo.className = 'panel-inicio-info info';
            navigateToView('panelInicio');
        });
    }

    // ----- L√≥gica de Carga y Sincronizaci√≥n con Repositorio -----
    function cleanText(text) { return text ? String(text).trim() : ''; }

    function parsearMaestraCSV(csvText) {
        return csvText.trim().split(/\r\n|\n/).slice(1).map(linea => {
            if (!linea.trim()) return null;
            const partes = linea.split(','); // Asume CSV, ajustar si delimitador es variable
            if (!partes[0]) return null;
            return {
                codigo: cleanText(partes[0]),
                upc: cleanText(partes[1]),
                descripcion: cleanText(partes[2]),
                brand: cleanText(partes[3]),
                url: cleanText(partes[4])
            };
        }).filter(Boolean);
    }

    function rebuildUpcToCodigoMap() {
        upcToCodigoMap.clear();
        listaFoco.forEach(item => {
            if (item.upc?.trim()) {
                upcToCodigoMap.set(item.upc.trim(), item.codigo);
            }
        });
    }

    async function cargarMaestraDesdeRepositorio() {
        if (!URL_LISTA_MAESTRA_REPOSITORIO || URL_LISTA_MAESTRA_REPOSITORIO.includes('PON_AQUI_LA_URL')) {
            console.warn('URL_LISTA_MAESTRA_REPOSITORIO no configurada.');
            return null;
        }
        try {
            const response = await fetch(`${URL_LISTA_MAESTRA_REPOSITORIO}?t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            const itemsArray = parsearMaestraCSV(csvText);
            const nuevaListaMap = new Map();
            itemsArray.forEach(item => {
                const idItemLimpio = cleanCode(item.codigo);
                if (idItemLimpio) nuevaListaMap.set(idItemLimpio, item);
            });
            return nuevaListaMap;
        } catch (error) {
            console.error('Excepci√≥n al cargar Maestra desde Repositorio:', error);
            return null;
        }
    }

    function compararListas(listaLocalMap, listaRemotaMap) {
        const nuevos = [], eliminados = [], modificados = [];
        listaRemotaMap.forEach((itemRemoto, codigo) => {
            if (!listaLocalMap.has(codigo)) {
                nuevos.push(itemRemoto);
            } else {
                const itemLocal = listaLocalMap.get(codigo);
                const changedFields = {};
                if ((itemLocal.descripcion ?? '') !== (itemRemoto.descripcion ?? '')) changedFields.descripcion = { old: itemLocal.descripcion, new: itemRemoto.descripcion };
                if ((itemLocal.upc ?? '') !== (itemRemoto.upc ?? '')) changedFields.upc = { old: itemLocal.upc, new: itemRemoto.upc };
                if ((itemLocal.brand ?? '') !== (itemRemoto.brand ?? '')) changedFields.brand = { old: itemLocal.brand, new: itemRemoto.brand };
                if ((itemLocal.url ?? '') !== (itemRemoto.url ?? '')) changedFields.url = { old: itemLocal.url, new: itemRemoto.url };

                if (Object.keys(changedFields).length > 0) {
                    modificados.push({ ...itemRemoto, changedFields });
                }
            }
        });
        listaLocalMap.forEach((itemLocal, codigo) => {
            if (!listaRemotaMap.has(codigo)) eliminados.push(itemLocal);
        });
        return { nuevos, eliminados, modificados };
    }

    function mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraRepositorioMap) {
        const popularListaResumen = (ul, items, fmt) => {
            ul.innerHTML = items.length > 0 ? items.map(fmt).join('') : '<li>Ninguno</li>';
        };
        const itemFormatter = itm => `<li><span class="code">${itm.codigo}</span>: D:${itm.descripcion??'N/A'}, U:${itm.upc??'N/A'}</li>`;
        
        popularListaResumen(DOM.resumenCambios.nuevos, nuevos, itemFormatter);
        popularListaResumen(DOM.resumenCambios.eliminados, eliminados, itemFormatter);

        popularListaResumen(DOM.resumenCambios.modificados, modificados, itm => {
            let chgs = '';
            if(itm.changedFields.descripcion) chgs += `<span class="field-change">Desc: <s>${itm.changedFields.descripcion.old??'N/A'}</s> &rarr; ${itm.changedFields.descripcion.new??'N/A'}</span>`;
            if(itm.changedFields.upc) chgs += `<span class="field-change">UPC: <s>${itm.changedFields.upc.old??'N/A'}</s> &rarr; ${itm.changedFields.upc.new??'N/A'}</span>`;
            if(itm.changedFields.brand) chgs += `<span class="field-change">Brand: <s>${itm.changedFields.brand.old??'N/A'}</s> &rarr; ${itm.changedFields.brand.new??'N/A'}</span>`;
            if(itm.changedFields.url) chgs += `<span class="field-change">URL Img: <s>${itm.changedFields.url.old??'N/A'}</s> &rarr; ${itm.changedFields.url.new??'N/A'}</span>`;
            return `<li><span class="code">${itm.codigo}</span>${chgs}</li>`;
        });
        
        // Store maestraRepositorioMap in a data attribute to retrieve it in the event listener
        DOM.buttons.confirmarCambios.dataset.maestraRepositorio = JSON.stringify(maestraRepositorioMap, (key, value) => {
             if (value instanceof Map) return { __isMap__: true, data: Array.from(value.entries()) };
             return value;
        });

        navigateToView('confirmacionCambiosStep');
    }

    async function checkInitialState() {
        loadListaFocoFromStorage(false);
        listaFocoCacheadaLocalmente = new Map(listaFoco);
        DOM.displays.panelInicioInfo.innerHTML = 'üîÑ Sincronizando Maestra TMR desde el repositorio...';
        DOM.displays.panelInicioInfo.className = 'panel-inicio-info info';
        DOM.buttons.iniciarDobleControl.disabled = true;
        DOM.buttons.gestionMaestra.disabled = true;

        const maestraDesdeRepositorio = await cargarMaestraDesdeRepositorio();
        DOM.buttons.iniciarDobleControl.disabled = false;
        DOM.buttons.gestionMaestra.disabled = false;

        if (maestraDesdeRepositorio) {
            const { nuevos, eliminados, modificados } = compararListas(listaFocoCacheadaLocalmente, maestraDesdeRepositorio);

            if (nuevos.length === 0 && eliminados.length === 0 && modificados.length === 0) {
                DOM.displays.panelInicioInfo.innerHTML = `‚úÖ Maestra TMR Sincronizada (${listaFoco.size} √≠tems). Ya estaba actualizada.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info';
                if (JSON.stringify(Array.from(listaFoco.values())) !== JSON.stringify(Array.from(maestraDesdeRepositorio.values()))) {
                    listaFoco = new Map(maestraDesdeRepositorio);
                    saveListaFocoToStorage(false); 
                }

            } else {
                DOM.displays.panelInicioInfo.innerHTML = `‚ÑπÔ∏è Se detectaron cambios en la Maestra TMR del repositorio. Revisa y confirma.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info warning';
                mostrarConfirmacionCambios(nuevos, eliminados, modificados, maestraDesdeRepositorio);
                return; 
            }
        } else {
            if (listaFoco.size > 0) {
                DOM.displays.panelInicioInfo.innerHTML = `‚ö†Ô∏è Error al cargar desde el repositorio. Usando Maestra local (${listaFoco.size} √≠tems).`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info warning';
            } else {
                DOM.displays.panelInicioInfo.innerHTML = `‚ùå Error al cargar desde el repositorio y no hay Maestra local. Funcionalidad limitada.`;
                DOM.displays.panelInicioInfo.className = 'panel-inicio-info error';
                DOM.buttons.iniciarDobleControl.disabled = true;
                DOM.buttons.gestionMaestra.disabled = true;
            }
        }
        rebuildUpcToCodigoMap();
        updateFocoPreviewAndSearch();
        if(document.getElementById('confirmacionCambiosStep').classList.contains('hidden')){ 
             navigateToView('panelInicio');
        }
    }

    // ----- NAVEGACI√ìN DE VISTAS -----
    function navigateToView(viewName) {
        Object.values(DOM.views).forEach(div => div.classList.add('hidden'));
        if (viewName !== 'itemDetailModal') DOM.views.itemDetailModal.style.display = 'none';
        
        const viewToShow = DOM.views[viewName];
        if (viewToShow) {
            viewToShow.classList.remove('hidden');
            if (viewName === 'gestionMaestraStep') updateFocoPreviewAndSearch();
        }
    }

    // ----- UTILIDADES -----
    function cleanCode(code) {
        if (typeof code !== 'string' && typeof code !== 'number') return '';
        return String(code).trim().replace(/[^a-zA-Z0-9\-]+/g, '').toUpperCase();
    }
    function resetFileInput(el) { if(el) el.value = null; }
    function getDelimiterRegex(d) {
        if (d.toLowerCase()==='<tab>') return /\t/;
        return new RegExp(d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
    }

    // ----- GESTI√ìN LISTA MAESTRA (B√öSQUEDA Y ESTAD√çSTICAS) -----
    function updateFocoPreviewAndSearch(itemsToShow = null) {
        let countNoUrl = 0, countNoUpc = 0, countNoDescription = 0, countNoBrand = 0;
        listaFoco.forEach(item => {
            if (!item.url?.trim()) countNoUrl++;
            if (!item.upc?.trim()) countNoUpc++;
            if (!item.descripcion?.trim()) countNoDescription++;
            if (!item.brand?.trim()) countNoBrand++;
        });
        DOM.stats.totalItems.textContent = listaFoco.size;
        DOM.stats.noImageUrl.textContent = countNoUrl;
        DOM.stats.noUpc.textContent = countNoUpc;
        DOM.stats.noDescription.textContent = countNoDescription;
        DOM.stats.noBrand.textContent = countNoBrand;

        if (itemsToShow) {
            DOM.displays.focoSearchResults.innerHTML = '';
            if (itemsToShow.length > 0) {
                const fragment = document.createDocumentFragment();
                itemsToShow.slice(0, 30).forEach(item => {
                    const p = document.createElement('div');
                    p.className = 'search-result-item';
                    p.dataset.iditem = item.codigo;
                    p.innerHTML = `<span class="code">${item.codigo}</span> <span class="upc-brand-url">(UPC: ${item.upc??'N/A'})</span> <span class="desc">${item.descripcion??'(S/D)'}</span>`;
                    fragment.appendChild(p);
                });
                DOM.displays.focoSearchResults.appendChild(fragment);

                if (itemsToShow.length > 30) {
                    DOM.displays.focoSearchResults.innerHTML += `<p style="text-align:center; font-style:italic;">... y ${itemsToShow.length - 30} m√°s. Refine su b√∫squeda.</p>`;
                }
            } else if (DOM.inputs.searchFoco.value) {
                DOM.displays.focoSearchResults.innerHTML = '<p style="text-align:center;">No se encontraron √≠tems.</p>';
            }
        }
    }

    function saveListaFocoToStorage(showAlert = true) {
        if (listaFoco.size === 0 && showAlert && !confirm("La Maestra est√° vac√≠a. ¬øGuardar vac√≠a?")) return false;
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_LISTA_FOCO, JSON.stringify(Array.from(listaFoco.values())));
            if (showAlert) alert(`Maestra con ${listaFoco.size} √≠tems guardada localmente.`);
            return true;
        } catch (e) {
            if (showAlert) alert(`Error al guardar Maestra local: ${e.message}`);
            return false;
        }
    }

    function loadListaFocoFromStorage(showAlerts = true) {
        const data = localStorage.getItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
        listaFoco.clear();
        if (data) {
            try {
                const itemsArray = JSON.parse(data);
                itemsArray.forEach(item => {
                    const idItemLimpio = cleanCode(item.codigo);
                    if (idItemLimpio) listaFoco.set(idItemLimpio, item);
                });
                if (showAlerts) alert(`Maestra local con ${listaFoco.size} √≠tems cargada.`);
            } catch (e) {
                if (showAlerts) alert("Error al cargar Maestra local: datos corruptos. Se borrar√°.");
                localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
            }
        }
    }
    
    // ----- LECTURA DE ARCHIVOS (VERIFICACI√ìN) Y MANEJO LISTA A VERIFICAR -----
    function handleFileUpload(file, fileType) { // fileType can be 'excel' or 'textcsv'
        if (!file) return;
        DOM.displays.verifyPreview.innerHTML = `Procesando "${file.name}"...`;
        const idItemColUserInput = parseInt(DOM.inputs.verifyCodigoCol.value); // 1-based for user
        const delimiter = DOM.inputs.verifyCsvDelimiter.value;
        const hasHeader = DOM.inputs.verifyHasHeader.checked;
        const targetFileElement = fileType === 'excel' ? DOM.inputs.verifyFileExcel : DOM.inputs.verifyFileTxtCsv;

        if (idItemColUserInput < 1 && fileType === 'textcsv') { // For excel, header name is preferred
            alert("Col. ID √çtem debe ser >= 1 para archivos de texto/CSV.");
            DOM.displays.verifyPreview.textContent = "Error.";
            resetFileInput(targetFileElement);
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            
            listaVerificar.clear();
            datosVerificacionCargados = [];
            DOM.inputs.scannedCodesVerifyTextarea.value = '';

            try {
                let parsedItems = [];
                if (fileType === 'excel') {
                    parsedItems = processExcelDataForVerify(content, idItemColUserInput, hasHeader);
                } else { // textcsv
                    const itemIdsOnly = processTextCsvDataForVerify(content, idItemColUserInput - 1, hasHeader, delimiter);
                    parsedItems = itemIdsOnly.map(id => ({
                        idItem: id,
                        contenedora: 'N/A_TXT_CSV',
                        cantidad: 0,
                        allRowData: { item_: id },
                        isSuitableForGroupedReport: false
                    }));
                }

                parsedItems.forEach(itemObj => {
                    const trimmedIdItem = cleanCode(itemObj.idItem); 
                    if (trimmedIdItem && /^[0-9]+$/.test(trimmedIdItem) && trimmedIdItem.length > 5) {
                        listaVerificar.add(trimmedIdItem); 
                        datosVerificacionCargados.push({...itemObj, idItem: trimmedIdItem }); 
                    } else {
                        console.warn("Item ID inv√°lido o no encontrado en fila:", itemObj.idItem, "Skipping.");
                    }
                });
                updateVerifyPreview();

            } catch (error) {
                alert(`Error procesando ${file.name}: ${error.message}`);
                DOM.displays.verifyPreview.textContent = `Error.`;
            }
            resetFileInput(targetFileElement);
        };
        reader.onerror = () => { alert(`No se pudo leer ${file.name}.`); resetFileInput(targetFileElement); };
        
        if (fileType === 'excel') reader.readAsArrayBuffer(file);
        else reader.readAsText(file);
    }

    function processTextCsvDataForVerify(content, colIdx, hasHeader, delimiter = ',') {
        const lines = content.split(/\r\n|\n/);
        const dataRows = hasHeader ? lines.slice(1) : lines;
        const delimRegex = getDelimiterRegex(delimiter);
        return dataRows.map(line => {
            const parts = line.split(delimRegex);
            return parts[colIdx] ? String(Number(parts[colIdx])).trim() : null; // Ensure number to string for consistency
        }).filter(Boolean);
    }

    function processExcelDataForVerify(arrayBuffer, itemColIdxUser /* 1-based */, hasHeader) {
        const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        if (!worksheet) throw new Error("Excel sin hojas.");
        
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, rawNumbers: false, defval: null });
        if (jsonData.length === 0) return [];

        let headerRow = [];
        let dataRows = jsonData; 

        if (hasHeader && jsonData.length > 0) {
            headerRow = jsonData[0].map(h => h ? String(h).toLowerCase().trim() : '');
            dataRows = jsonData.slice(1);
        } else if (hasHeader && jsonData.length === 0) { 
             return [];
        } else if (!hasHeader) {
            alert("Para la funcionalidad de reporte XLSX agrupado, el archivo Excel DEBE tener encabezados ('item_', 'contenedoras', 'cantidad').");
        }
        
        const itemHeaderName = 'item_';
        const contenedoraHeaderName = 'contenedoras';
        const cantidadHeaderName = 'cantidad';

        let actualItemColIdx = -1;
        let contenedoraColIdx = -1;
        let cantidadColIdx = -1;
        let isSuitableForGroupedReport = false;

        if (hasHeader && headerRow.length > 0) {
            actualItemColIdx = headerRow.indexOf(itemHeaderName);
            contenedoraColIdx = headerRow.indexOf(contenedoraHeaderName);
            cantidadColIdx = headerRow.indexOf(cantidadHeaderName);

            if (actualItemColIdx === -1 && itemColIdxUser > 0) { 
                actualItemColIdx = itemColIdxUser - 1;
            } else if (actualItemColIdx === -1) {
                 throw new Error(`Columna con encabezado "${itemHeaderName}" no encontrada. Verifique el archivo o la configuraci√≥n de columna.`);
            }
            if (contenedoraColIdx === -1) console.warn(`Encabezado "${contenedoraHeaderName}" no encontrado. El reporte agrupado no estar√° disponible para estos datos.`);
            if (cantidadColIdx === -1) console.warn(`Encabezado "${cantidadHeaderName}" no encontrado. El reporte agrupado no estar√° disponible para estos datos.`);
            
            isSuitableForGroupedReport = (contenedoraColIdx !== -1 && cantidadColIdx !== -1 && actualItemColIdx !== -1);

        } else if (!hasHeader && itemColIdxUser > 0) { 
            actualItemColIdx = itemColIdxUser - 1;
            isSuitableForGroupedReport = false;
             console.warn("Archivo Excel sin encabezados. El reporte agrupado por contenedora no estar√° disponible para estos datos.");
        } else if (!hasHeader && itemColIdxUser <=0) {
            throw new Error("Archivo Excel sin encabezados y no se especific√≥ una columna de ID de √≠tem v√°lida.");
        }


        return dataRows.map(row => {
            if (!row || row.every(cell => cell === null || cell === '')) return null; // Skip totally empty rows

            const idItem = (actualItemColIdx !== -1 && row[actualItemColIdx]) ? String(Number(row[actualItemColIdx])).trim() : null; // Ensure number to string
            const contenedora = (contenedoraColIdx !== -1 && row[contenedoraColIdx]) ? String(row[contenedoraColIdx]).trim() : (isSuitableForGroupedReport ? 'Sin Contenedora Especificada' : 'N/A_EXCEL_NO_HEADER_CONT');
            const cantidadVal = (cantidadColIdx !== -1 && row[cantidadColIdx]) ? String(row[cantidadColIdx]).replace(',', '.') : null;
            const cantidad = cantidadVal ? parseFloat(cantidadVal) : 0;

            const allRowData = {};
            if (hasHeader && headerRow.length > 0) {
                headerRow.forEach((header, idx) => {
                    if (header) allRowData[header] = row[idx];
                });
            } else { 
                 row.forEach((val, idx) => allRowData[`col_${idx+1}`] = val);
            }
            
            return {
                idItem: idItem,
                contenedora: contenedora,
                cantidad: !isNaN(cantidad) ? cantidad : 0,
                allRowData: allRowData,
                isSuitableForGroupedReport: isSuitableForGroupedReport && idItem !== null 
            };
        }).filter(item => item && item.idItem); 
    }
    
    function updateVerifyPreview() {
        const count = listaVerificar.size;
        DOM.displays.verifyPreview.textContent = `Lista de IDs de √çtem V√°lidos a Verificar: ${count}. ${count > 0 ? `Primeros: ${[...listaVerificar].slice(0,5).join(', ')}${count > 5 ? '...' : ''}` : 'Vac√≠a.'}`;
    }

    function collectVerifyDataFromInputs() {
        const textVerifyItems = DOM.inputs.verifyTextarea.value.trim();
        if (textVerifyItems) {
            textVerifyItems.split(/\s+/).forEach(id => {
                const trimmedIdItem = String(Number(id)).trim(); // Ensure number to string
                if (/^[0-9]+$/.test(trimmedIdItem) && trimmedIdItem.length > 5) {
                    listaVerificar.add(trimmedIdItem); 
                    const existsInDatos = datosVerificacionCargados.some(d => d.idItem === trimmedIdItem);
                    if (!existsInDatos) {
                        datosVerificacionCargados.push({
                            idItem: trimmedIdItem,
                            contenedora: 'N/A_TEXTAREA',
                            cantidad: 0, 
                            allRowData: { item_: trimmedIdItem },
                            isSuitableForGroupedReport: false
                        });
                    }
                }
            });
        }
        updateVerifyPreview(); 
    }
    
    function onScanSuccessVerify(decodedText){
        const scannedUPC = cleanText(decodedText);
        let internalCode = null;
        if (scannedUPC) {
            internalCode = upcToCodigoMap.get(scannedUPC) ?? upcToCodigoMap.get(scannedUPC.slice(0, -1));
            
            if (internalCode) {
                const cleanedInternalCode = cleanCode(internalCode);
                if (cleanedInternalCode && /^[0-9]+$/.test(cleanedInternalCode) && cleanedInternalCode.length > 5) {
                    listaVerificar.add(cleanedInternalCode);
                    DOM.inputs.scannedCodesVerifyTextarea.value += `${cleanedInternalCode} (Scan: ${scannedUPC})\n`;
                    
                    const existsInDatos = datosVerificacionCargados.some(d => d.idItem === cleanedInternalCode);
                    if (!existsInDatos) {
                        datosVerificacionCargados.push({
                            idItem: cleanedInternalCode,
                            contenedora: 'N/A_SCAN',
                            cantidad: 0, 
                            allRowData: { item_: cleanedInternalCode, upc_scanned: scannedUPC },
                            isSuitableForGroupedReport: false
                        });
                    }
                    updateVerifyPreview();
                }
            } else {
                alert(`UPC escaneado (${scannedUPC}) no encontrado en la Lista Maestra.`);
            }
        }
    }

    function toggleScanner() {
        if(scannerVerifierActive){
            if(html5QrCodeVerifier?.isScanning){
                html5QrCodeVerifier.stop().then(() => {
                    scannerVerifierActive = false;
                    DOM.displays.scannerContainerVerify.classList.add('hidden');
                    DOM.buttons.startScanVerify.textContent = 'üì∑ Escanear UPC de Art√≠culo';
                }).catch(err => console.error("Error deteniendo esc√°ner:", err));
            } else {
                scannerVerifierActive = false;
                DOM.displays.scannerContainerVerify.classList.add('hidden');
                DOM.buttons.startScanVerify.textContent = 'üì∑ Escanear UPC de Art√≠culo';
            }
        } else {
            if(location.protocol !=='https:' && !['localhost','127.0.0.1'].includes(location.hostname)){
                alert('El esc√°ner requiere un entorno seguro (HTTPS) o localhost.');
                return;
            }
            DOM.displays.scannerContainerVerify.classList.remove('hidden');
            DOM.buttons.startScanVerify.textContent = 'üõë Detener Esc√°ner';
            if(!html5QrCodeVerifier) html5QrCodeVerifier = new Html5Qrcode("readerVerify", { verbose: false });
            const config = { fps: 10, qrbox: { width: 250, height: 100 }, supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA] };
            html5QrCodeVerifier.start({ facingMode: "environment" }, config, onScanSuccessVerify, (errorMessage) => { /* console.log("QR Scan error:", errorMessage); */ })
            .then(() => scannerVerifierActive = true)
            .catch(err => {
                alert(`Error al iniciar esc√°ner: ${err.message || err}`);
                DOM.displays.scannerContainerVerify.classList.add('hidden');
                DOM.buttons.startScanVerify.textContent = 'üì∑ Escanear UPC de Art√≠culo';
                scannerVerifierActive = false;
            });
        }
    }

    // ----- COMPARACI√ìN Y RESULTADOS -----
    function compareListsAndDisplayResults(){
        coincidencias.clear();
        listaVerificar.forEach(idItemToVerify => { 
            if(listaFoco.has(idItemToVerify)) {
                coincidencias.set(idItemToVerify, listaFoco.get(idItemToVerify));
            }
        });
        displayFinalResults();
    }
    
    function displayFinalResults() {
        DOM.stats.totalFoco.textContent = listaFoco.size;
        DOM.stats.totalVerify.textContent = listaVerificar.size;
        DOM.stats.totalMatches.textContent = coincidencias.size;

        DOM.displays.outputResults.innerHTML = '';
        DOM.displays.outputResults.className = 'list'; // Default to list view

        if (coincidencias.size === 0) { 
            DOM.displays.outputResults.innerHTML = '<p>No se encontraron √çtems concordantes para mostrar.</p>';
            return;
        }

        const fragment = document.createDocumentFragment();
        const groupedForDisplay = new Map();

        // 1. Group matched items from datosVerificacionCargados by contenedora
        datosVerificacionCargados.forEach(uploadedItem => {
            if (coincidencias.has(uploadedItem.idItem)) {
                const masterDetails = coincidencias.get(uploadedItem.idItem);
                const contenedoraKey = uploadedItem.isSuitableForGroupedReport && uploadedItem.contenedora ?
                                       uploadedItem.contenedora :
                                       "√çtems Verificados (Otros/Sin Contenedora Espec√≠fica)";
                
                if (!groupedForDisplay.has(contenedoraKey)) {
                    groupedForDisplay.set(contenedoraKey, []);
                }
                if (!groupedForDisplay.get(contenedoraKey).some(existing => existing.codigo === masterDetails.codigo)) {
                    groupedForDisplay.get(contenedoraKey).push({
                        ...masterDetails, 
                        cantidadOriginal: uploadedItem.cantidad, 
                        isFromUploadWithContainerInfo: uploadedItem.isSuitableForGroupedReport && uploadedItem.contenedora
                    });
                }
            }
        });

        // 2. Add other matched items (not from datosVerificacionCargados with specific container info)
        coincidencias.forEach(masterItem => {
            const alreadyDisplayedWithContainer = Array.from(groupedForDisplay.values())
                                       .flat()
                                       .some(dispItem => dispItem.codigo === masterItem.codigo && dispItem.isFromUploadWithContainerInfo);
            
            if (!alreadyDisplayedWithContainer) {
                const defaultGroupKey = "√çtems Verificados (Otros/Sin Contenedora Espec√≠fica)";
                if (!groupedForDisplay.has(defaultGroupKey)) {
                    groupedForDisplay.set(defaultGroupKey, []);
                }
                if (!groupedForDisplay.get(defaultGroupKey).some(existing => existing.codigo === masterItem.codigo)) {
                    groupedForDisplay.get(defaultGroupKey).push({ ...masterItem, cantidadOriginal: null, isFromUploadWithContainerInfo: false });
                }
            }
        });
        
        if (groupedForDisplay.size === 0) { 
             DOM.displays.outputResults.innerHTML='<p>No se encontraron √çtems concordantes para mostrar despu√©s de agrupar.</p>';
             return;
        }

        const sortedContenedoraKeys = Array.from(groupedForDisplay.keys()).sort((a, b) => {
            if (a.startsWith("√çtems Verificados (Otros")) return 1;
            if (b.startsWith("√çtems Verificados (Otros")) return -1;
            return a.localeCompare(b);
        });

        sortedContenedoraKeys.forEach(contenedora => {
            const itemsArray = groupedForDisplay.get(contenedora);
            if (itemsArray.length === 0) return; 

            const contenedoraHeader = document.createElement('h4');
            contenedoraHeader.textContent = `${contenedora}`; 
            contenedoraHeader.style.marginTop = "20px";
            contenedoraHeader.style.paddingBottom = "5px";
            contenedoraHeader.style.borderBottom = "1px solid #ccc";
            contenedoraHeader.style.color = "#2c3e50";
            fragment.appendChild(contenedoraHeader);

            itemsArray.forEach(item => {
                const cD = document.createElement("div");
                cD.className = "barcode-item-container";
                cD.dataset.iditem = item.codigo;

                const descText = item.descripcion ? `<p class="barcode-item-desc">${item.descripcion}</p>` : '';
                const brandText = `<p style="font-size: 0.8em; text-align: center; color: #777;">Marca: ${item.brand ?? 'N/A'}</p>`;
                const cantidadText = (typeof item.cantidadOriginal === 'number' && item.cantidadOriginal !== null) ? `<p style="font-size: 0.9em; text-align: center; color: #333; font-weight: bold;">Cantidad (cargada): ${item.cantidadOriginal}</p>` : '';

                cD.innerHTML = `
                    <p class="barcode-item-code">${item.codigo}</p>
                    ${descText}
                    ${brandText}
                    ${cantidadText}
                    <div class="barcode-item-svg"></div>
                `;

                const svgContainer = cD.querySelector('.barcode-item-svg');
                const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
                try {
                    JsBarcode(svg, item.codigo, { format:"CODE128", width:2, height:50, displayValue:false, margin:5 });
                    svgContainer.appendChild(svg);
                } catch(e) {
                    console.error("Error JsBarcode:", e, "para item:", item.codigo);
                    svgContainer.innerHTML=`<p style="color:red;font-size:0.8em;">Error BC</p>`;
                }
                fragment.appendChild(cD);
            });
        });
        DOM.displays.outputResults.appendChild(fragment);
    }
    
    function openItemDetailModal(idItem) {
        const item = listaFoco.get(idItem) ?? coincidencias.get(idItem);
        if (item) {
            DOM.modal.codigo.textContent = "ID √çtem: " + item.codigo;
            DOM.modal.descripcion.textContent = item.descripcion ?? 'No disponible';
            DOM.modal.upc.textContent = item.upc ?? 'No disponible';
            DOM.modal.brand.textContent = item.brand ?? 'No disponible';
            
            const imageUrl = item.url?.trim();
            if (imageUrl) {
                DOM.modal.image.src = imageUrl;
                DOM.modal.image.alt = "Imagen de " + (item.descripcion ?? item.codigo);
                DOM.modal.image.style.display = 'block';
                DOM.modal.imageError.style.display = 'none';
            } else {
                DOM.modal.image.style.display = 'none';
                DOM.modal.image.src = '#';
                DOM.modal.imageError.textContent = 'URL de imagen no especificada.';
                DOM.modal.imageError.style.display = 'block';
            }
            DOM.views.itemDetailModal.classList.remove('hidden');
            DOM.views.itemDetailModal.style.display = 'flex';
        }
    }

    function closeItemDetailModal() {
        DOM.views.itemDetailModal.classList.add('hidden');
        DOM.views.itemDetailModal.style.display = 'none';
        DOM.modal.image.src="#";
    }

    // ----- MANEJADORES DE EVENTOS DE BOTONES -----
    function handleIniciarDobleControl() {
        if (listaFoco.size === 0) {
            alert("No hay Lista Maestra cargada. Sincronice con el repositorio.");
            return;
        }
        listaVerificar.clear();
        datosVerificacionCargados = []; 
        coincidencias.clear();
        DOM.inputs.verifyTextarea.value = '';
        DOM.inputs.scannedCodesVerifyTextarea.value = '';
        resetFileInput(DOM.inputs.verifyFileTxtCsv);
        resetFileInput(DOM.inputs.verifyFileExcel);
        updateVerifyPreview();
        navigateToView('dobleControlStep');
    }

    function handleBorrarStorage() {
        if (confirm("¬øSeguro que desea borrar la Maestra guardada localmente? Se intentar√° resincronizar.")) {
            localStorage.removeItem(LOCAL_STORAGE_KEY_LISTA_FOCO);
            listaFoco.clear();
            listaFocoCacheadaLocalmente.clear();
            upcToCodigoMap.clear();
            alert("Maestra local borrada. Resincronizando...");
            checkInitialState(); 
        }
    }

    function handleCompare() {
        collectVerifyDataFromInputs(); 
        if (listaVerificar.size === 0) {
            alert("Cargue o escanee √çtems v√°lidos para la Lista de Verificaci√≥n.");
            return;
        }
        if (listaFoco.size === 0) {
            alert("La Lista Maestra est√° vac√≠a. Sincronice con el repositorio.");
            navigateToView('panelInicio');
            return;
        }
        compareListsAndDisplayResults();
        navigateToView('resultadosStep');
    }

    function toggleResultsLayout(){
        DOM.displays.outputResults.classList.toggle('grid');
        DOM.displays.outputResults.classList.toggle('list');
        DOM.buttons.layoutToggle.textContent = DOM.displays.outputResults.classList.contains('grid') ? 'üìä Vista Lista' : 'üìä Vista Cuadr√≠cula';
    }

    function downloadCsvResults(){
        if(coincidencias.size===0){alert("No hay √çtems concordantes para descargar.");return;}
        let csvContent="ID_Item,UPC,Descripcion,Marca,URL_Imagen\n"; 
        coincidencias.forEach(item=>{ 
            const desc = `"${(item.descripcion??'').replace(/"/g,'""')}"`;
            const upcVal = `"${(item.upc??'').replace(/"/g,'""')}"`;
            const brandVal = `"${(item.brand??'').replace(/"/g,'""')}"`;
            const urlVal = `"${(item.url??'').replace(/"/g,'""')}"`;
            csvContent+=`${item.codigo},${upcVal},${desc},${brandVal},${urlVal}\n`;
        });
        const blob = new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `concordancias_sdci_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    async function downloadXlsxResults() {
        const hasGroupableData = datosVerificacionCargados.some(item => item.isSuitableForGroupedReport);
        const itemsConCantidadSuficiente = datosVerificacionCargados.filter(item => item.cantidad >= 100 && item.isSuitableForGroupedReport);

        if (coincidencias.size === 0 && itemsConCantidadSuficiente.length === 0) {
             alert("No hay √≠tems concordantes ni √≠tems con cantidad >= 100 del archivo de verificaci√≥n para exportar."); return;
        }

        const btn = DOM.buttons.downloadXlsx;
        const originalText = btn.textContent;
        let groupedByContenedora = new Map(); 

        if (hasGroupableData || itemsConCantidadSuficiente.length > 0) {
            btn.textContent = 'Generando (Agrupado)...';
            btn.disabled = true;

            try {
                for (const uploadedItem of datosVerificacionCargados) {
                    if (uploadedItem.isSuitableForGroupedReport && coincidencias.has(uploadedItem.idItem)) {
                        const masterDetails = coincidencias.get(uploadedItem.idItem);
                        const itemDataForReport = {
                            idItem: uploadedItem.idItem,
                            descripcion: masterDetails.descripcion || uploadedItem.allRowData?.descripcion || uploadedItem.allRowData?.['descripci√≥n'] || uploadedItem.allRowData?.['description'] || 'Descripci√≥n del archivo',
                            marca: masterDetails.brand || uploadedItem.allRowData?.marca || uploadedItem.allRowData?.['brand'] || 'Marca del archivo',
                            cantidad: uploadedItem.cantidad, 
                        };
                        const contenedoraKey = uploadedItem.contenedora || "Sin Contenedora Asignada";
                        if (!groupedByContenedora.has(contenedoraKey)) {
                            groupedByContenedora.set(contenedoraKey, []);
                        }
                        groupedByContenedora.get(contenedoraKey).push(itemDataForReport);
                    }
                }

                for (const uploadedItem of itemsConCantidadSuficiente) {
                    if (!coincidencias.has(uploadedItem.idItem)) { 
                        const itemDataForReport = {
                            idItem: uploadedItem.idItem,
                            descripcion: uploadedItem.allRowData?.descripcion || uploadedItem.allRowData?.['descripci√≥n'] || uploadedItem.allRowData?.['description'] || 'Descripci√≥n del archivo (√çtem no en Maestra)',
                            marca: uploadedItem.allRowData?.marca || uploadedItem.allRowData?.['brand'] || 'Marca del archivo (√çtem no en Maestra)',
                            cantidad: uploadedItem.cantidad,
                            notInMaster: true 
                        };
                        const contenedoraKey = uploadedItem.contenedora || "Sin Contenedora Asignada";
                        if (!groupedByContenedora.has(contenedoraKey)) {
                            groupedByContenedora.set(contenedoraKey, []);
                        }
                        const existingInGroup = groupedByContenedora.get(contenedoraKey);
                        if (!existingInGroup.some(ex => ex.idItem === itemDataForReport.idItem)) {
                           existingInGroup.push(itemDataForReport);
                        }
                    }
                }

                if (groupedByContenedora.size === 0) {
                    alert("No hay √≠tems concordantes con datos de contenedora v√°lidos ni √≠tems con cantidad >= 100 para el reporte agrupado. Se generar√° el reporte est√°ndar si hay coincidencias generales.");
                } else {
                    const dataForSheet = [];
                    dataForSheet.push(["Reporte de Control TMR Agrupado por Contenedora"]);
                    dataForSheet.push(["Fecha de Generaci√≥n:", new Date().toLocaleDateString("es-CL", { day: '2-digit', month: '2-digit', year: 'numeric' })]);
                    dataForSheet.push([]);

                    let currentRowIdx = dataForSheet.length - 1;
                    const merges = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }];

                    groupedByContenedora.forEach((itemsArray, contenedora) => {
                        currentRowIdx++;
                        dataForSheet.push([`Contenedora: ${contenedora}`]);
                        merges.push({ s: { r: currentRowIdx, c: 0 }, e: { r: currentRowIdx, c: 5 } });
                        currentRowIdx++;
                        dataForSheet.push(["ID √çtem", "Descripci√≥n", "Marca", "Cantidad (Unidades)", "Revisado", "Diferencias Encontradas"]);

                        itemsArray.forEach(item => {
                            let idItemDisplay = item.idItem;
                            if (item.notInMaster) {
                                idItemDisplay += " (No en Maestra)";
                            }
                            dataForSheet.push([
                                idItemDisplay, item.descripcion, item.marca, item.cantidad,
                                "‚òê " + "_".repeat(20), "_".repeat(30)
                            ]);
                            currentRowIdx++;
                        });
                        dataForSheet.push([]);
                        currentRowIdx++;
                    });

                    const ws = XLSX.utils.aoa_to_sheet(dataForSheet);
                    ws['!cols'] = [ { wch: 25 }, { wch: 50 }, { wch: 25 }, { wch: 20 }, { wch: 28 }, { wch: 35 } ];
                    ws['!merges'] = merges;

                    if(ws['A1']) ws['A1'].s = { font: { bold: true, sz: 16 }, alignment: { horizontal: "center", vertical: "center" } };
                    for(let i = 0; i < dataForSheet.length; i++) {
                        if (dataForSheet[i] && typeof dataForSheet[i][0] === 'string' && dataForSheet[i][0].startsWith("Contenedora:")) {
                            const cellAddress = XLSX.utils.encode_cell({r: i, c: 0});
                            if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: dataForSheet[i][0] };
                            ws[cellAddress].s = { font: { bold: true, sz: 13, color: { rgb: "1F497D" } }, fill: { fgColor: { rgb: "DCE6F1" } }, alignment: { vertical: "center"} };
                        }
                        if (dataForSheet[i] && dataForSheet[i][0] === "ID √çtem") {
                             for (let j=0; j<dataForSheet[i].length; j++) {
                                const cellAddress = XLSX.utils.encode_cell({r: i, c: j});
                                if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: dataForSheet[i][j] };
                                ws[cellAddress].s = { font: { bold: true, sz:10 }, fill: { fgColor: { rgb: "F2F2F2" } }, border: { bottom: { style: "thin"} }, alignment: {wrapText: true, vertical: "center"} };
                             }
                        }
                        if (dataForSheet[i] && dataForSheet[i][0] && typeof dataForSheet[i][0] === 'string' && dataForSheet[i][0].includes("(No en Maestra)")) {
                            for (let j=0; j<4; j++) { 
                                const cellAddress = XLSX.utils.encode_cell({r: i, c: j});
                                if (ws[cellAddress]) {
                                     if(!ws[cellAddress].s) ws[cellAddress].s = {};
                                     ws[cellAddress].s.font = { ...ws[cellAddress].s.font, color: {rgb: "FF0000"} }; 
                                }
                            }
                        }
                    }
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Control TMR Agrupado");
                    XLSX.writeFile(wb, `Control_TMR_Agrupado_${new Date().toISOString().slice(0,10)}.xlsx`);

                    btn.textContent = originalText;
                    btn.disabled = false;
                    return; 
                }
            } catch (error) {
                console.error("Error generando XLSX agrupado:", error);
                alert("Error al generar archivo XLSX agrupado: " + error.message + "\nSe intentar√° generar el reporte est√°ndar si hay coincidencias generales.");
            }
        }

        if (coincidencias.size > 0) {
            if ((hasGroupableData || itemsConCantidadSuficiente.length > 0) && groupedByContenedora.size === 0) {
            } else if (!hasGroupableData && itemsConCantidadSuficiente.length === 0) {
                 alert("No se encontraron datos adecuados para el reporte agrupado. Se generar√° el reporte est√°ndar de coincidencias.");
            }
        } else { 
             btn.textContent = originalText; 
             btn.disabled = false;
             return; 
        }

        btn.textContent = 'Generando (Est√°ndar)...'; 
        btn.disabled = true;
        try {
            const oldDataForSheet = [
                ["Control TMR 2025 - Reporte Est√°ndar de Concordancias"],
                ["Fecha de Generaci√≥n:", new Date().toLocaleDateString("es-CL")],
                [],
            ];
            Array.from(coincidencias.values()).forEach(item => { 
                oldDataForSheet.push(
                    ["ID √çtem:", item.codigo],
                    ["Descripci√≥n:", item.descripcion ?? ''],
                    ["Marca:", item.brand ?? ''],
                    ["Revisado:", "‚òê " + "_".repeat(30) + " (Firma/Obs)"],
                    ["Diferencias Encontradas:", "_".repeat(45)],
                    [null, "_".repeat(45)],
                    []
                );
            });
            if (oldDataForSheet.length <= 3 && coincidencias.size === 0) { 
                 alert("No hay √≠tems concordantes para el reporte est√°ndar.");
            } else {
                const ws_std = XLSX.utils.aoa_to_sheet(oldDataForSheet);
                ws_std['!cols'] = [ { wch: 25 }, { wch: 60 } ];
                ws_std['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }];
                 if(ws_std['A1']) { ws_std['A1'].s = { font: { bold: true, sz: 16 }, alignment: { horizontal: "center" } }; }
                const wb_std = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb_std, ws_std, "Control TMR Est√°ndar");
                XLSX.writeFile(wb_std, `Control_TMR_Estandar_${new Date().toISOString().slice(0,10)}.xlsx`);
            }
        } catch (error) {
            console.error("Error generando XLSX est√°ndar:", error);
            alert("Error al generar archivo XLSX est√°ndar: " + error.message);
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }
    
    function createPdfField(label, value) {
        return `<div class="pdf-item-field">
                    <span class="pdf-item-label">${label}:</span>
                    <span class="pdf-item-value">${value ?? 'N/A'}</span>
                </div>`;
    }

    function generatePdfReport() {
        if (coincidencias.size === 0) { alert("No hay √çtems para generar el PDF."); return; }
        
        const btn = DOM.buttons.downloadPdf;
        const originalText = btn.textContent;
        btn.textContent = 'Generando PDF...';
        btn.disabled = true;

        const pdfExportContainer = document.createElement('div');
        pdfExportContainer.className = 'pdf-export-container';
        pdfExportContainer.style.position = 'absolute';
        pdfExportContainer.style.left = '-9999px';
        pdfExportContainer.style.width = '180mm'; 

        const currentDateFormatted = new Date().toLocaleDateString("es-CL", { year: 'numeric', month: 'long', day: 'numeric' });
        let contentHTML = `
            <h1 class="main-document-title">${document.querySelector('.container > h1').innerText}</h1>
            <h2 class="report-title">Reporte de Verificaci√≥n de √çtems</h2>
            <p class="report-date">Fecha de Generaci√≥n: ${currentDateFormatted}</p>`;
        
        coincidencias.forEach(item => {
            const svgBarcode = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            try {
                JsBarcode(svgBarcode, item.codigo, { format: "CODE128", width: 1.5, height: 60, displayValue: true, fontSize: 12, margin: 5 });
            } catch (e) { console.error("Error JsBarcode para PDF:", e); }

            contentHTML += `
                <div class="pdf-item-ficha">
                    ${createPdfField('ID √çtem', item.codigo)}
                    ${createPdfField('Descripci√≥n', item.descripcion)}
                    ${createPdfField('Marca', item.brand)}
                    <div class="pdf-item-barcode-container">${svgBarcode.outerHTML}</div>
                    <div class="pdf-item-field revisado-field">
                        <span class="pdf-item-label">Revisado:</span><span class="pdf-item-value">‚òê ${" ".repeat(40)} (Firma/Obs)</span>
                    </div>
                    <div class="pdf-item-field diferencias-field">
                        <span class="pdf-item-label">Diferencias:</span><span class="pdf-item-value">${" ".repeat(55)}</span>
                    </div>
                     <div class="pdf-item-field diferencias-field-extra">
                        <span class="pdf-item-label">&nbsp;</span><span class="pdf-item-value">${" ".repeat(55)}</span>
                    </div>
                </div>`;
        });
        
        pdfExportContainer.innerHTML = contentHTML;
        document.body.appendChild(pdfExportContainer);

        const opt = {
            margin: [20, 18, 20, 18],
            filename: `Reporte_Control_TMR_Detallado_${new Date().toISOString().slice(0,10)}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: false, useCORS: true },
            jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' },
            pagebreak: { mode: ['css', 'avoid-all'], avoid: '.pdf-item-ficha' }
        };

        html2pdf().from(pdfExportContainer).set(opt).save().catch(err => {
            console.error("Error al generar PDF:", err);
            alert("Error al generar PDF: " + err.message);
        }).finally(() => {
            btn.textContent = originalText;
            btn.disabled = false;
            if (document.body.contains(pdfExportContainer)) {
                document.body.removeChild(pdfExportContainer);
            }
        });
    }

    function handleNewVerification() {
        listaVerificar.clear();
        datosVerificacionCargados = []; 
        coincidencias.clear();
        DOM.inputs.verifyTextarea.value = '';
        DOM.inputs.scannedCodesVerifyTextarea.value = '';
        resetFileInput(DOM.inputs.verifyFileTxtCsv);
        resetFileInput(DOM.inputs.verifyFileExcel);
        updateVerifyPreview();
        DOM.displays.outputResults.innerHTML = '<p>No se han encontrado coincidencias o no se ha realizado la verificaci√≥n.</p>';
        DOM.stats.totalVerify.textContent = '0';
        DOM.stats.totalMatches.textContent = '0';
        if(scannerVerifierActive) toggleScanner(); 
        navigateToView('panelInicio');
    }

  </script>
</body>
</html>
